# Bots 平台 "应用市场" 功能产品方案 (V7.2)

## 1. 项目概述

本文档旨在详细描述 Bots 平台新增的"应用市场"功能。该功能为平台用户提供一个集中管理、发现、创建、共享和使用各类 APP 包的界面与机制。这些 APP 包主要服务于 Bots 平台的工作流构建，允许工作流调用手机或特定设备执行自动化操作，例如下载并运行指定应用或进行功能测试。

## 2. 功能目标

*   **界面友好与易用性:** 提供直观、清晰的用户界面，方便用户高效浏览、精确搜索及管理 APP。
*   **用户创建与贡献:** 允许用户创建新的应用，并为自己创建的应用或官方应用上传、管理和共享包。
*   **内部协作与发现:** 强化内部资源共享，使用户可以发现和使用官方应用及其他用户共享的应用。
*   **应用来源与归属区分:** 明确区分应用创建者（Bots官方、用户），确保应用和包的归属清晰。
*   **版本与标识规范:** 确保每个 APP 包拥有清晰的版本管理和唯一的 PackageID，保障在工作流中被精确引用和调用。
*   **层级化共享与权限控制:** 建立合理、明确的层级化共享机制（应用级共享、包在应用内共享）和权限控制，保障应用市场的规范运作和内容安全。

## 3. 核心概念与术语

*   **应用 (Application):**
    *   代表一个具有特定功能的智能体应用（例如："智能客服助手"、"订单处理机器人"）。
    *   **属性:**
        *   `应用ID (AppID)`: 系统生成的唯一标识。
        *   `应用名称 (AppName)`: 用户定义，需清晰表明应用功能，并建议包含平台指示（如："智能客服助手-Android"， "智能客服助手-iOS"）。
        *   `应用描述 (AppDescription)`: 详细描述应用的功能、用途。
        *   `应用图标 (AppIcon)`: 用户上传的图片文件。
        *   `平台类型 (PlatformType)`: 如 Android, iOS 等。(目前UI仅支持Android, iOS)
        *   `创建者 (Creator)`: "Bots官方" 或 "用户XXX"。
        *   `创建时间 (CreateTime)`: 应用创建的时间。
        *   `更新时间 (UpdateTime)`: 应用信息最后更新的时间。
        *   `应用共享状态 (AppSharingStatus)`:
            *   `共享到司内 (SharedToInternal)`: 应用在"司内应用"市场中对公司其他成员可见。
            *   `私有 (Private)`: 应用仅创建者在"司内应用"市场中可见。
    *   **司内应用:** 指在"司内应用"市场中展示的应用。它可以是：
        *   由"Bots官方"创建和维护的应用，供内部使用和协作。
        *   由平台用户创建的应用，用户可以自行决定其 `应用共享状态`。
    *   **司外应用:** 指在"司外应用"市场中展示的，由"Bots官方"从主流应用市场引入的第三方应用。
    *   每个"应用"条目下均包含该应用对应平台的多个"包"版本。

*   **包 (Package):**
    *   指"应用"的具体可执行构建版本，是用户在 Bots 工作流中实际下载和调用的基本单元。
    *   **属性:**
        *   `包ID (PackageID)`: 系统生成的唯一标识，提供复制功能。
        *   `PackageURL`: 系统生成的包下载链接，提供复制功能。
        *   `归属应用ID (AppID)`: 关联的父应用ID。
        *   `版本号 (Version)`: 如 "1.0.0", "2.1-beta"。
        *   `包描述 (PackageDescription)`: 该版本包的特定更新说明或备注。
        *   `包文件 (PackageFile)`: 用户上传的实际应用包文件（前端处理，后端存储）。
        *   `上传者 (Uploader)`: 上传该包的用户名（可能与应用创建者不同）。
        *   `上传时间 (UploadTime)`: 包上传的时间。
        *   `包在应用内共享状态 (PackageInAppSharingStatus)`: (此状态仅在父应用为 `SharedToInternal` 时，决定包对其他用户的可见性)
            *   `共享 (Shared)`: 包在父应用（共享状态下）的详情页中对其他用户可见。
            *   `私有 (Private)`: 包在父应用（共享状态下）的详情页中对其他用户隐藏，仅对应用创建者/包上传者/管理员可见。若父应用本身为 `Private`，则此包无论此状态为何，均对外隐藏。

*   **我上传的包 (My Uploaded Packages):** 一个专属标签页，集中展示当前登录用户上传的所有包，无论这些包归属于官方应用还是用户自己创建的应用。
*   **司内应用 (Internal Apps Market):** (原"司内市场") 展示所有相关的内部应用：Bots官方应用 + 所有用户创建的应用（无论共享或私有，私有应用仅创建者可见）。
*   **司外应用 (External Apps Market):** (原"司外市场") 展示由"Bots官方"引入的第三方公开市场应用。用户不能向此类应用上传包或创建新应用。

## 4. 功能模块详述

### 4.1. 应用市场主界面

应用市场主界面采用顶部标签页进行功能区域切换，下方为相应内容展示区。

*   **4.1.1. 标签页 (Tabs):**
    *   **司内应用 (Internal Apps):** **默认选中的标签页。** 以卡片视图展示。
    *   **司外应用 (External Apps):** 以卡片视图展示。
    *   **我上传的包 (My Uploaded Packages):** 以列表视图展示。

*   **4.1.2. 搜索功能:**
    *   位于标签页导航栏下方，提供全局内容搜索能力。
    *   在 **"司内应用"** 或 **"司外应用"** 标签页激活时: 用户可按应用名称、应用描述、创建者等关键词进行搜索。
    *   在 **"我上传的包"** 标签页激活时: 用户可按包的版本号、包描述、PackageID、PackageURL、归属应用名称进行搜索。
    *   搜索结果始终根据当前激活的标签页内容进行筛选和展示。

### 4.2. "我上传的包 (My Uploaded Packages)" 标签页

此区域集中管理用户个人上传的所有包。

*   **4.2.1. 包列表视图 (Package List View):**
    *   **顶部操作:**
        *   搜索框 (详情见 4.1.2)。
        *   **复合按钮 "上传新包":**
            *   点击后展开下拉菜单，提供两个选项：
                *   **"仅上传包":** 点击后打开标准"上传新包"弹窗 (4.2.2.1)，用户需在弹窗内选择一个已存在的归属应用。
                *   **"新建应用并上传包":** 点击后打开"新建应用并上传首个包"复合弹窗 (4.2.2.2)，允许用户在一个流程中同时创建新应用并上传其第一个包。
    *   **列表展示字段:**
        *   **归属应用名称:** 显示该包所属的应用的名称。此名称可作为链接，点击后跳转至该应用在"司内应用"市场的包列表详情页。
        *   **版本号:** 包的版本标识。
        *   **包描述:** 包的描述信息。
        *   **PackageID:** 包的唯一标识，提供一键复制功能。
        *   **PackageURL:** 包的下载链接，提供一键复制功能。
        *   **上传时间:** 包的上传日期和时间。
        *   **状态:**
            *   显示包自身的 `PackageInAppSharingStatus` (值为："共享" 或 "私有")。
            *   若该包所属的应用当前为 `私有 (Private)` 状态，且此包的 `PackageInAppSharingStatus` 为 `共享`，则在"共享"状态旁应有明确的提示图标(例如信息图标)，鼠标悬浮提示："归属应用当前为私有。此包的'共享'状态仅在应用所有者可见范围内生效，并不会使其在司内市场对其他用户共享。如需对市场共享，请先将归属应用设为共享。"
        *   **操作:**
            *   下载: 触发包文件下载。
            *   编辑包信息: 修改包的版本描述等非核心信息（仅限自己上传的包）。
            *   切换共享状态 (共享/私有): 用于切换 `PackageInAppSharingStatus`。（操作需二次确认，并遵循4.5节的共享逻辑与引导）。
            *   删除: 移除此包（仅限自己上传的包，操作需二次确认）。
    *   **交互特性:** 列表支持按上传时间、版本号等关键字段进行排序。

*   **4.2.2. 上传新包流程:**
    *   **4.2.2.1. "仅上传包" 弹窗:**
        *   **归属应用 (Target Application):** (必选项) 下拉列表形式，展示用户有权限上传包的应用（包括Bots官方允许上传的应用、以及用户自己创建的所有应用）。
        *   **应用包文件 (PackageFile):** (必填项) 标准文件上传控件，需进行文件类型和大小限制。
        *   **版本号 (Version):** (必填项)
        *   **包描述 (PackageDescription):** (可选项)
        *   **在应用内共享状态 (PackageInAppSharingStatus):** (可选项) 单选/开关，选项为"共享"（默认选中）或"私有"。
        *   **系统自动生成:** `PackageID`, `PackageURL`。
    *   **4.2.2.2. "新建应用并上传首个包" 复合弹窗:**
        *   此弹窗在一个界面内整合了创建新应用和上传其首个包的字段。
        *   **应用信息部分:**
            *   `应用名称 (AppName)`: (必填项)
            *   `应用描述 (AppDescription)`: (可选项)
            *   `应用图标 (AppIcon)`: (可选项) 文件上传。
            *   `平台类型 (PlatformType)`: (必填项) 下拉选择 (Android, iOS)。
            *   `应用初始共享状态 (AppSharingStatus)`: (必选项) 单选/开关 (`共享到司内` / `私有`)。
        *   **首个包信息部分:**
            *   `应用包文件 (PackageFile)`: (必填项)
            *   `版本号 (Version)`: (必填项)
            *   `包描述 (PackageDescription)`: (可选项)
            *   `包在应用内共享状态 (PackageInAppSharingStatus)`: (必选项) 单选/开关 (`共享` / `私有`)。
        *   **系统自动生成:** `AppID`, `PackageID`, `PackageURL`。
    *   **后续流程:** 上传/创建成功后，新包/新应用将出现在相应列表中。其在市场的可见性遵循4.5节的共享逻辑。

### 4.3. "司内应用 (Internal Apps)" 标签页

此区域展示并允许用户与内部应用进行交互，包括官方应用和用户创建的应用。

*   **4.3.1. 应用列表视图 (Application Card View):**
    *   **展示内容:**
        *   所有 "Bots官方" 创建的应用。
        *   所有用户创建的，且 `AppSharingStatus` 为 `SharedToInternal` 的应用。
        *   当前用户创建的，且 `AppSharingStatus` 为 `Private` 的应用（仅对该用户可见）。
    *   **顶部操作:**
        *   `[+] 新建应用` 按钮 (点击后进入4.3.3流程，打开标准"新建应用"弹窗)。
        *   **筛选器:**
            *   按来源: 全部、Bots官方、我创建的、他人共享的。
            *   按我创建的应用的共享状态: (仅当"我创建的"或"全部"来源被选中时激活) 全部、已共享、私有。
            *   按平台类型: 全部、Android、iOS。
        *   关键词搜索框 (搜索应用名称、描述、创建者)。
    *   **卡片展示信息:**
        *   应用图标
        *   应用名称 (包含明确的平台标识)
        *   平台类型
        *   最新包版本号 (基于该应用下 `PackageInAppSharingStatus` 为 `Shared` 的最新包，若无则为N/A)
        *   应用描述 (简短)
        *   最新包上传时间 (同上)
        *   **应用创建者:** 显示"Bots官方"或"用户XXX"。
        *   **应用状态 (仅对我创建的应用显示):** "已共享 (司内可见)" 或 "私有 (仅自己可见)"。
    *   **卡片操作按钮:**
        *   `查看版本列表`: 点击后跳转至该应用的包详情页 (见 4.3.2)。
        *   如果应用是当前用户创建的，额外显示管理按钮（通常在卡片右上角"..."菜单内）：`编辑应用信息`、`切换共享状态 (共享到司内/设为私有)` (操作需二次确认并遵循4.5节逻辑)、`删除应用` (操作需二次确认)。

*   **4.3.2. 应用包详情页 (Package Details Page):**
    *   当用户点击"司内应用"中的某个应用卡片后，进入此页面。
    *   **页面结构与功能:**
        *   **导航:** 提供清晰的"返回司内应用列表"的按钮。
        *   **应用信息概要:** 展示当前应用的名称、图标、描述、平台类型、创建者、应用状态 (如果是我创建的)。
        *   **顶部操作栏:**
            *   **包搜索:** 提供仅针对当前应用下包列表的搜索框 (按版本、描述、PackageID、PackageURL)。
            *   **`[+] 为此应用上传包` 按钮:**
                *   仅当应用是"Bots官方"应用或当前用户创建的应用时显示。
                *   点击后弹出标准"上传新包"弹窗 (4.2.2.1)，"归属应用"已固定为当前应用。
    *   **包列表 (Package List):**
        *   **列表展示字段:**
            *   版本号
            *   包描述
            *   PackageID (提供一键复制)
            *   PackageURL (提供一键复制)
            *   **上传者:** 显示上传此包的"平台用户昵称/ID"或"Bots官方"。
            *   上传时间
            *   **操作 (Actions) 列 (条件显示):**
                *   下载包
                *   复制 PackageID
                *   复制 PackageURL
                *   **以下操作仅当 `canManagePackage(pkg)` 返回 `true` 时可见 (即登录用户是此包的上传者):**
                    *   编辑包信息 (修改版本描述等)
                    *   切换包在应用内共享状态 (共享/私有) (遵循4.5节逻辑和引导，二次确认)
                    *   删除包 (二次确认)
        *   **可见性规则 (包列表):**
            *   如果父应用 `AppSharingStatus` 为 `Private`，则此应用详情页及所有包仅对应用创建者可见。
            *   如果父应用 `AppSharingStatus` 为 `SharedToInternal`:
                *   对于普通用户（非包上传者、非应用创建者、非管理员），他们在此列表中仅能看到 `PackageInAppSharingStatus` 为 `Shared` 的包。
                *   对于包的上传者、应用的创建者或管理员，他们可以看到该应用下的所有包，无论其 `PackageInAppSharingStatus` 是 `Shared` 还是 `Private`。
        *   **交互特性:** 列表支持按上传时间、版本号等关键字段进行排序。

*   **4.3.3. 新建/编辑应用 (Create/Edit New Application - 标准弹窗):**
    *   **新建应用入口:** "司内应用"页的 `[+] 新建应用` 按钮。
    *   **编辑应用入口:** 用户自己创建的应用卡片上的 `编辑应用信息` 按钮。
    *   **表单字段:**
        *   `应用名称 (AppName)`: (必填项) 文本输入。
        *   `应用描述 (AppDescription)`: (可选项) 文本区域。
        *   `应用图标 (AppIcon)`: (可选项) 文件上传组件。
        *   `平台类型 (PlatformType)`: (必填项) 下拉选择 (Android, iOS)。
        *   `应用共享状态 (AppSharingStatus)`: (必选项) 单选/开关 (`共享到司内` / `私有`)。

### 4.4. "司外应用 (External Apps)" 标签页

此区域展示由官方从外部引入的第三方应用。

*   **4.4.1. 应用列表视图 (Application Card View):**
    *   **卡片展示信息:** 应用图标、应用名称（含平台标识）、平台类型、最新包版本号、应用描述、应用来源（固定显示为"Bots官方"）。
    *   **卡片操作按钮:** 查看版本列表 (点击后跳转至该应用的包详情页)。

*   **4.4.2. 应用包详情页 (Package Details Page):**
    *   **页面结构与功能:**
        *   导航: 提供清晰的"返回司外应用列表"的按钮。
        *   应用信息: 展示当前应用的名称和平台类型。
        *   包搜索: 提供仅针对当前应用下包列表的搜索框。
        *   **无"上传新包"按钮。** 用户不能为此类应用上传包。
    *   **包列表 (Package List):**
        *   列表展示字段: 版本号、包描述、PackageID (提供一键复制)、PackageURL (提供一键复制)、上传者 (固定显示为"Bots官方")、上传时间。
        *   操作: 下载、复制 PackageID, 复制 PackageURL。
        *   交互特性: 列表支持按上传时间、版本号等关键字段进行排序。

### 4.5. 核心权限与共享逻辑 (V7.3 更新)

*   **应用创建与管理:**
    *   **Bots官方应用:** 由具备管理员权限的"Bots官方"人员在后台管理系统创建、维护。
    *   **用户创建应用:**
        *   任何登录用户均可在"司内应用"标签页通过 `[+] 新建应用` 按钮创建新应用，或在"我上传的包"标签页通过复合按钮的"新建应用并上传包"选项创建。
        *   用户对自己创建的应用拥有管理权，包括编辑应用信息、删除应用（需二次确认，并提示其下所有包也将被删除）、切换应用的 `AppSharingStatus`。
*   **包的上传:**
    *   用户可以为自己创建的应用上传包。
    *   用户也可以为"Bots官方"创建且允许贡献的应用上传包。
*   **层级化共享状态与可见性:**
    *   **第一层：应用共享状态 (`AppSharingStatus`) - `共享到司内` / `私有`:**
        *   这是**首要控制**。
        *   **1. 当应用设为 `私有 (Private)` 时:**
            *   系统将弹窗提示用户："该应用「AppName」以及其下的所有包都将被置为私有状态，仅您可见。是否确认？"
            *   确认后，该应用的 `AppSharingStatus` 变为 `Private`。
            *   **该应用下的所有包，无论其各自的 `PackageInAppSharingStatus` 是什么，都将自动且强制地被同步修改为 `私有 (Private)`** (数据层面)。
            *   该应用（及其所有包）在"司内应用"市场中仅对创建者本人可见。
        *   **2. 当私有应用被设为 `共享到司内 (SharedToInternal)` 时:**
            *   该应用的 `AppSharingStatus` 变为 `SharedToInternal`。
            *   **其下所有包的 `PackageInAppSharingStatus` 默认保持其之前的状态 (通常是 `私有 (Private)`)**。用户需要手动逐个或批量将希望共享的包设为 `共享 (Shared)`。这是为了避免意外暴露之前不打算公开的包。
    *   **第二层：包在应用内的共享状态 (`PackageInAppSharingStatus`) - `共享` / `私有`:**
        *   此状态的**实际对外效用取决于其父应用的 `AppSharingStatus`**。
        *   **当父应用为 `私有 (Private)` 时:** 包的 `PackageInAppSharingStatus` **不起实际对外共享作用**。所有包随应用对外隐藏 (且数据层面其 `PackageInAppSharingStatus` 已被强制设为 `Private`)。
        *   **当父应用为 `共享到司内 (SharedToInternal)` 时:**
            *   `PackageInAppSharingStatus` **决定了该特定包是否在其父应用的详情页中对市场用户可见**。
            *   `共享 (Shared)`: 该包版本在"司内应用"市场的该应用详情中对有权查看此共享应用的用户可见。
            *   `私有 (Private)`: 该包版本在"司内应用"市场的该应用详情中对其他用户隐藏，仅应用创建者/包上传者/管理员在管理视图中可见。
        *   **3. 在私有应用下尝试共享包 (将包的 `PackageInAppSharingStatus` 从 `Private` 改为 `Shared`):**
            *   操作按钮可见且可点击。
            *   点击后，系统将弹窗提示用户："当前包「PackageVersion」所属的应用「AppName」为私有状态。若要共享此包使其对其他用户可见，其归属应用「AppName」首先需要被共享。是否需要系统帮助您将【应用「AppName」和此包「PackageVersion」一并设为共享】？"
            *   提供 "取消" 和 "是，全部共享" 按钮。
            *   若用户选择 "是，全部共享"：则父应用的 `AppSharingStatus` 变为 `SharedToInternal`，同时当前包的 `PackageInAppSharingStatus` 也变为 `Shared`。其他包的状态不变，仍需用户手动管理。

*   **包的管理操作权限 (`canManagePackage(pkg)`):**
    *   **核心原则:** 用户**仅能管理自己上传的包 (`pkg.uploader === USER_ID`)**。
    *   这意味着，即使在官方应用中，如果某个包是用户A上传的，则只有用户A（或管理员）能编辑/删除/切换该包的共享状态。其他普通用户（包括应用创建者如果不是包上传者）无权管理非自己上传的包。
    *   在 **"我上传的包"** 标签页中: 用户对自己上传的所有包拥有管理权限。
    *   在 **"司内应用"** 的应用包详情页中:
        *   对于**用户自己创建的应用**：用户（应用创建者）可以上传新包。对于已存在的包，只有包的原始上传者才能管理该包。
        *   对于**官方应用**：用户可以上传新包（如果官方应用允许）。对于已存在的包，只有包的原始上传者才能管理该包。
        *   普通用户（非包上传者、非管理员）仅可浏览符合共享逻辑的包，并可下载、复制PackageID/PackageURL。
    *   在 **"司外应用"** 中: 用户仅有浏览和使用权限。
*   **管理员权限:** 平台管理员拥有对所有应用（无论创建者）及所有包的最高管理权限。

## 5. 技术与运营考量

*   **PackageID与PackageURL唯一性保障:** 后端需设计机制确保每个上传的 `PackageID` 和生成的 `PackageURL` 在整个平台内是唯一的。PackageURL由系统根据上传文件和存储策略自动生成，用户不可修改。
*   **版本号规范建议:** 考虑在用户上传包时，提供版本号规范的建议或弱校验（如提示遵循语义化版本 x.y.z）。
*   **"归属应用"数据源:** "我上传的包"功能中，"仅上传包"时选择"归属应用"的下拉列表，其数据应动态获取自当前"司内应用"中所有允许当前用户上传包的应用（包括官方开放贡献的应用和用户自己创建的所有应用）。
*   **后台管理系统需求:** 必须配备功能完善的后台管理系统，供管理员进行：
    *   管理"Bots官方"应用（创建、编辑、删除等）。
    *   审查和管理所有用户创建的应用（如发现违规可进行干预）。
    *   所有包（包括用户上传）的审查、管理。
    *   用户权限管理、角色定义（如普通用户、管理员）。
    *   平台公告、配置管理等。
*   **用户通知机制:** 考虑设计通知机制，例如：当用户上传的包因特定原因（如安全风险、违规）被管理员修改状态或删除时，系统应能以适当方式通知到原上传用户。
*   **空状态与引导:**
    *   如果"司内应用"当前没有任何官方应用可供用户上传包，或用户自己还未创建任何应用，在"我上传的包"的"上传新包"功能中，"归属应用"下拉列表应有明确的空状态提示或引导。
    *   各列表在无数据时应显示友好的空状态提示。

本文档（V7.2）基于V7.1进行了UI交互调整和共享逻辑的进一步细化，后续可基于此进行技术实现和迭代。