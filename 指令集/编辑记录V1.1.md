# 【设计中】官方指令 - 编辑记录 - V1.0.0

## 指令名称

UpdateRecord / EditRecord / 编辑记录

## 功能描述

根据提供的筛选条件，在指定的 ABS 数据表（由 `base_id` 和 `table_id` 标识）中找到符合条件的记录，并批量更新这些记录的指定字段值。支持多条件组合筛选,并返回成功更新记录的完整信息。

## 使用说明

1. 在工作流画布中添加"编辑记录"节点。
2. 配置节点的输入参数，需要提供：
   * **所属数据库 Base ID (`base_id`) (必填):** 目标数据表所在的 ABS 数据库的 ID。
   * **目标数据表 Table ID (`table_id`) (必填):** 要编辑记录的数据表的 ID。
   * **筛选条件 (`filter`) (必填):** 用于确定要更新哪些记录的条件对象。
   * **更新数据 (`update_data`) (必填):** 包含要更新的字段名和新值的 JSON 对象。
3. 将节点的输入连接到前序节点。
4. 执行工作流。
5. 检查节点的输出，确认记录是否成功更新。

### 单条更新与批量更新

本指令支持两种更新模式:

1. **单条更新:**
   - 通过在筛选条件中指定 `record_id` 等唯一标识字段实现
   - 确保筛选条件只会匹配到一条记录
   - 适用于精确更新特定记录的场景

2. **批量更新:**
   - 通过设置业务相关的筛选条件实现
   - 可以同时更新多条符合条件的记录
   - 适用于批量数据处理场景

**单条更新示例:**
```json
{
  "filter": {
    "conditions": [
      {
        "field": "record_id",
        "operator": "=",
        "value": "rec_abc123"
      }
    ]
  },
  "update_data": {
    "状态": "已完成"
  }
}
```

**批量更新示例:**
```json
{
  "filter": {
    "conditions": [
      {
        "field": "部门",
        "operator": "=",
        "value": "技术部"
      },
      {
        "field": "入职日期",
        "operator": "<=",
        "value": "2023-12-31"
      }
    ],
    "conjunction": "AND"
  },
  "update_data": {
    "级别": "P6",
    "更新说明": "年度晋升"
  }
}
```

> **注意:** 在使用批量更新时,建议先通过查询操作验证筛选条件的匹配范围,避免意外更新过多数据。

## 注意事项

* **权限:** 执行此操作需要在目标 ABS 数据表上拥有**编辑/写入**记录的权限。
* **筛选条件验证:** 确保 filter 中指定的字段名存在且类型匹配。
* **数据量控制:** 筛选条件可能匹配大量记录,建议先测试匹配数量。
* **不可逆操作:** 批量更新是不可逆的,请谨慎设置筛选条件。
* **字段验证:** 更新的字段值必须符合目标字段的数据类型和约束。
* **部分更新:** `update_data` 只需提供需要修改的字段及其新值。
* **批量限制:** 单次更新的记录数可能受到平台限制。
* **原子性:** 批量更新通常不是原子操作,部分成功部分失败是可能的。
* **并发控制:** 需要考虑并发更新的情况。
* **性能考量:** 返回完整记录信息可能在大量数据时有性能影响。

## 适用场景

* 批量更新符合特定条件的记录（如：将所有"进行中"且"低优先级"的任务提升为"高优先级"）。
* 数据状态批量迁移（如：将30天前的"进行中"任务标记为"已过期"）。
* 数据订正（如：修复特定日期范围内录入的错误数据）。
* 业务规则触发的批量更新（如：当项目状态变更时,更新所有相关任务的状态）。

## 入参

| 参数名      | 参数说明                                      | 是否必填 | 用户是否配置 |
| :---------- | :-------------------------------------------- | :------- | :----------- |
| base_id     | 所属 ABS 数据库的 Base ID                     | 是       | 是           |
| table_id    | 目标 ABS 数据表的 Table ID                    | 是       | 是           |
| filter      | 筛选条件对象,用于确定要更新的记录             | 是       | 是           |
| update_data | 要更新的字段和值                              | 是       | 是           |
| token       | ABS 调用令牌                                  | 是       | 否(系统获取) |
| workspaceID | ABS 空间 ID（API 调用上下文）                 | 是       | 否(系统获取) |

**filter 对象结构说明:**
```json
{
  "conditions": [  // 条件数组,支持多个条件
    {
      "field": "状态",      // 字段名
      "operator": "=",      // 操作符
      "value": "进行中"     // 比较值
    },
    {
      "field": "创建时间",
      "operator": "<=",  
      "value": "2024-01-01"
    }
  ],
  "conjunction": "AND"  // 条件组合方式: "AND" 或 "OR"
}
```

**支持的操作符:**
- `=`: 等于
- `!=`: 不等于
- `>`: 大于
- `>=`: 大于等于
- `<`: 小于
- `<=`: 小于等于
- `CONTAINS`: 包含
- `NOT_CONTAINS`: 不包含
- `IS_EMPTY`: 为空
- `IS_NOT_EMPTY`: 不为空

**请求体示例 (更新所有进行中的低优先级任务):**
```json
{
  "base_id": "base_xyz789",
  "table_id": "tbl_abc123",
  "filter": {
    "conditions": [
      {
        "field": "状态",
        "operator": "=",
        "value": "进行中"
      },
      {
        "field": "优先级",
        "operator": "=",
        "value": "低"
      }
    ],
    "conjunction": "AND"
  },
  "update_data": {
    "优先级": "高",
    "更新说明": "批量提升优先级"
  }
}
```

**请求体示例 (更新过期任务):**
```json
{
  "base_id": "base_xyz789",
  "table_id": "tbl_abc123",
  "filter": {
    "conditions": [
      {
        "field": "状态",
        "operator": "=",
        "value": "进行中"
      },
      {
        "field": "截止日期",
        "operator": "<=",
        "value": "2023-12-31"
      }
    ],
    "conjunction": "AND"
  },
  "update_data": {
    "状态": "已过期",
    "更新说明": "系统自动标记过期任务"
  }
}
```
## 出参

| 参数名         | 参数说明                                                   |
| :------------- | :-------------------------------------------------------- |
| success        | 布尔值,指示更新操作是否成功执行                            |
| matched_count  | 匹配筛选条件的记录总数                                     |
| updated_count  | 实际成功更新的记录数                                       |
| records        | 成功更新的记录完整信息数组                                 |
| errors         | (可选) 更新过程中遇到的错误信息                            |
| filter_error   | (可选) 筛选条件相关的错误信息                              |
| message        | 操作结果的总体消息                                         |
| error_code     | (如果 success 为 false) 错误代码                          |

**响应体示例 (成功):**
```json
{
  "success": true,
  "matched_count": 5,
  "updated_count": 5,
  "records": [
    {
      "record_id": "rec_001",
      "状态": "进行中",
      "优先级": "高",
      "更新说明": "批量提升优先级",
      "创建时间": "2024-01-15T10:00:00Z",
      "最后更新时间": "2024-02-20T15:30:00Z"
    },
    // ... 其他更新记录
  ],
  "errors": [],
  "message": "Successfully updated 5 records."
}
```

**响应体示例 (部分成功):**
```json
{
  "success": true,
  "matched_count": 3,
  "updated_count": 2,
  "records": [
    {
      "record_id": "rec_001",
      "状态": "进行中",
      "优先级": "高",
      // ... 其他字段
    }
  ],
  "errors": [
    {
      "record_id": "rec_003",
      "error_code": "DB005",
      "message": "Permission denied for this record."
    }
  ],
  "message": "Partially succeeded: 2 out of 3 matched records updated."
}
```

**响应体示例 (筛选条件错误):**
```json
{
  "success": false,
  "matched_count": 0,
  "updated_count": 0,
  "filter_error": {
    "field": "状态A",
    "message": "字段不存在",
    "error_code": "DB034"
  },
  "message": "Invalid filter condition: Field '状态A' does not exist."
}
```

## XML 语法

```xml
<UpdateRecord baseId="{{base_id}}" tableId="{{table_id}}">
  <Filter>
    <Conditions>
      <Condition>
        <Field>状态</Field>
        <Operator>=</Operator>
        <Value>进行中</Value>
      </Condition>
      <Condition>
        <Field>优先级</Field>
        <Operator>=</Operator>
        <Value>低</Value>
      </Condition>
    </Conditions>
    <Conjunction>AND</Conjunction>
  </Filter>
  <UpdateData>
    <Field name="优先级">高</Field>
    <Field name="更新说明">批量提升优先级</Field>
  </UpdateData>
</UpdateRecord>
```

## Groovy 语法

```groovy
def filter = [
  conditions: [
    [field: '状态', operator: '=', value: '进行中'],
    [field: '优先级', operator: '=', value: '低']
  ],
  conjunction: 'AND'
]

def updateData = [
  '优先级': '高',
  '更新说明': '批量提升优先级'
]

def updateResult = engine.execute('UpdateRecord', [
  base_id: workflow.getVariable('target_base_id'),
  table_id: workflow.getVariable('target_table_id'),
  filter: filter,
  update_data: updateData
])

if (updateResult.success) {
  println("匹配记录数: ${updateResult.output.matched_count}")
  println("成功更新: ${updateResult.output.updated_count} 条记录")
  
  // 处理更新后的记录
  updateResult.output.records.each { record ->
    println("记录 ${record.record_id} 更新后状态: ${record.'状态'}")
  }
  
  // 检查是否有错误
  if (updateResult.output.errors) {
    println("部分记录更新失败:")
    updateResult.output.errors.each { err -> 
      println(" - 记录 ${err.record_id}: ${err.message}")
    }
  }
} else {
  if (updateResult.output.filter_error) {
    println("筛选条件错误: ${updateResult.output.filter_error.message}")
  } else {
    println("更新失败: ${updateResult.error.message}")
  }
}
```

## 使用案例

1. **批量更新任务优先级:**
```json
{
  "filter": {
    "conditions": [
      {
        "field": "状态",
        "operator": "=",
        "value": "进行中"
      },
      {
        "field": "截止日期",
        "operator": "<=",
        "value": "2024-02-29"
      }
    ],
    "conjunction": "AND"
  },
  "update_data": {
    "优先级": "高",
    "更新说明": "临近截止日期,提升优先级"
  }
}
```

2. **标记过期记录:**
```json
{
  "filter": {
    "conditions": [
      {
        "field": "状态",
        "operator": "!=",
        "value": "已完成"
      },
      {
        "field": "截止日期",
        "operator": "<",
        "value": "2024-01-01"
      }
    ],
    "conjunction": "AND"
  },
  "update_data": {
    "状态": "已过期",
    "备注": "系统自动标记"
  }
}
```

## 分类与标签

数据库, Database, 数据表, Table, ABS, 更新, 编辑, 批量更新, Update, Edit, Batch Update, Record, Data Management, CR**U**D (Update), 条件更新

## 错误码与异常说明

| 错误码 | 说明                     | 处理建议                                                     |
| :----- | :----------------------- | :----------------------------------------------------------- |
| DB000  | 未知错误                 | 查看工作流执行日志，联系平台管理员                           |
| DB002  | 身份验证失败             | 检查系统配置的 ABS Token 是否有效                            |
| DB005  | 权限不足                 | 确认执行权限                                                 |
| DB008  | 数据库不存在或无权访问    | 检查 base_id 是否正确                                       |
| DB010  | 数据表未找到             | 检查 table_id 是否正确                                      |
| DB013  | 字段数据类型不匹配       | 检查 update_data 中的值类型                                 |
| DB014  | 字段值校验失败           | 检查 update_data 中的值是否符合字段约束                      |
| DB015  | 违反唯一性约束           | 检查是否与现有数据冲突                                      |
| DB034  | 筛选条件字段不存在       | 检查 filter 中的字段名是否正确                               |
| DB035  | 筛选条件操作符不支持     | 检查操作符是否在支持范围内                                   |
| DB036  | 筛选条件值类型不匹配     | 检查筛选条件中的值类型是否与字段类型匹配                     |
| DB037  | 匹配记录数超出限制       | 缩小筛选范围或分批次更新                                    |

## 权限与安全要求

* **需要登录:** 是
* **涉及敏感操作:** 是。批量更新数据是高风险操作
* **具体权限:** 需要对目标表有编辑/写入权限
* **数据安全:** 建议在执行前确认筛选条件的影响范围

## 依赖关系与前置条件

* **数据库和数据表:** 必须存在且可访问
* **有效凭证:** 系统必须有更新权限的有效 Token
* **筛选条件:** 必须指定有效的筛选条件
* **字段存在:** filter 和 update_data 中引用的字段必须在表中存在
* **数据类型:** 更新值必须符合字段的数据类型要求
