# 添加字段 - AddField - V1.0.0

## 指令名称

AddField / 添加字段

## 功能描述

向指定的 ABS 数据表（由 `base_id` 和 `table_id` 标识）中添加一个或多个新的字段（列）。支持设置字段名称、类型、是否必填、默认值等属性。

## 使用说明

1. 在工作流画布中添加"添加字段"节点。
2. 配置节点的输入参数，需提供：
   - **所属数据库 Base ID (`base_id`) (必填)：** 目标数据表所在的 ABS 数据库的 ID。
   - **目标数据表 Table ID (`table_id`) (必填)：** 需要添加字段的数据表 ID。
   - **字段定义列表 (`fields`) (必填)：** 一个包含要添加字段定义的数组，每个字段需指定名称、类型等属性。
3. 将节点的输入与前序节点连接（如获取 `base_id`、`table_id` 等）。
4. 执行工作流，系统会在目标表中添加新字段。
5. 后续节点可使用新增字段。

## 注意事项

- **权限：** 需要对目标数据表拥有"结构修改"或"管理"权限。
- **字段名唯一性：** 新增字段名称不能与现有字段重复。
- **字段类型：** 支持的类型请参考 ABS 平台字段类型文档。
- **批量添加：** 支持一次添加多个字段。
- **部分失败：** 若部分字段添加失败，响应中会有详细错误信息。

## 适用场景

- 数据表结构升级，新增业务字段
- 动态扩展表结构以适应新需求
- 自动化流程中根据条件动态添加字段

## 入参

| 参数名      | 参数说明                                   | 是否必填 | 用户是否配置 |
| ----------- | ------------------------------------------ | -------- | ------------ |
| base_id     | 所属 ABS 数据库的 Base ID                  | 是       | 是           |
| table_id    | 目标 ABS 数据表的 Table ID                 | 是       | 是           |
| fields      | 要添加的字段定义数组（见下方结构说明）      | 是       | 是           |
| token       | ABS 调用令牌                               | 是       | 否（系统获取）|
| workspaceID | ABS 空间 ID（API 调用上下文）              | 是       | 否（系统获取）|

**字段定义结构示例：**
```json
[
  {
    "field_name": "客户邮箱",
    "field_type": "text",
    "required": false,
    "default_value": ""
  },
  {
    "field_name": "注册时间",
    "field_type": "datetime",
    "required": true
  }
]
```

**请求体示例：**
```json
{
  "base_id": "base_xyz789",
  "table_id": "tbl_abc123",
  "fields": [
    {
      "field_name": "客户邮箱",
      "field_type": "text",
      "required": false,
      "default_value": ""
    }
  ]
}
```

## 出参

| 参数名       | 参数说明                                         |
| ------------ | ------------------------------------------------ |
| success      | 布尔值，指示操作是否成功                         |
| added_fields | 成功添加的字段信息数组                           |
| errors       | (可选) 添加失败的字段及原因                      |
| message      | 操作结果的总体消息                               |
| error_code   | (失败时) 错误码                                  |

**响应体示例（全部成功）：**
```json
{
  "success": true,
  "added_fields": [
    {
      "field_name": "客户邮箱",
      "field_type": "text"
    }
  ],
  "errors": [],
  "message": "成功添加 1 个字段。"
}
```
**响应体示例（部分失败）：**
```json
{
  "success": true,
  "added_fields": [
    {
      "field_name": "客户邮箱",
      "field_type": "text"
    }
  ],
  "errors": [
    {
      "field_name": "注册时间",
      "error_code": "DB031",
      "message": "字段已存在"
    }
  ],
  "message": "部分字段添加失败，请查看 errors。"
}
```
**响应体示例（失败）：**
```json
{
  "success": false,
  "added_fields": [],
  "errors": [],
  "message": "权限不足，无法添加字段。",
  "error_code": "DB005"
}
```

## 前端展示

- 成功时，提示"成功添加 X 个字段"
- 部分失败时，提示"部分字段添加失败"，并展示失败原因
- 失败时，展示错误信息及错误码

## XML 语法

```xml
<AddField baseId="{{base_id}}" tableId="{{table_id}}">
  <Fields>
    <Field>
      <Name>客户邮箱</Name>
      <Type>text</Type>
      <Required>false</Required>
      <DefaultValue></DefaultValue>
    </Field>
  </Fields>
</AddField>
```

## Groovy 语法

```groovy
def addResult = engine.execute('AddField', [
  base_id: 'base_xyz789',
  table_id: 'tbl_abc123',
  fields: [
    [field_name: '客户邮箱', field_type: 'text', required: false]
  ]
])
if (addResult.success) {
  println("添加字段成功: " + addResult.output.added_fields)
} else {
  println("添加字段失败: " + addResult.output.message)
}
```

## 使用案例

- 新业务上线，需要在"客户信息表"中增加"客户邮箱"字段
- 业务流程自动化时，根据条件动态扩展表结构

## 分类与标签

数据库, 数据表, 字段, 结构变更, 添加, ABS, Schema, Field, Table, 管理

## 错误码与异常说明

| 错误码 | 说明                   | 处理建议                   |
| ------ | ---------------------- | -------------------------- |
| DB000  | 未知错误               | 查看日志，联系管理员        |
| DB002  | 身份验证失败           | 检查 Token                 |
| DB005  | 权限不足               | 检查权限                   |
| DB010  | 数据表不存在           | 检查 table_id              |
| DB031  | 字段已存在             | 检查字段名是否重复          |
| DB032  | 字段类型不支持         | 检查 field_type 是否有效    |
| DB033  | 字段定义不合法         | 检查字段定义参数            |

## 权限与安全要求

- 需要登录
- 需要对目标表有结构修改/管理权限

## 依赖关系与前置条件

- 目标数据库和数据表已存在
- 字段名、类型等参数合法
