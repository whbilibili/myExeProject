# PRD: Bots 平台数据库模块 (基于 ABS 集成) - V1.0

**版本历史:**

| 版本  | 日期       | 作者     | 变更说明         |
| :---- | :--------- | :------- | :--------------- |
| 1.0   | 2024-XX-XX | Gemini Pro | 初始草案         |

## 1. 概述 (Overview)

### 1.1 背景

当前的 Bots 平台缺乏内置的、用户友好的结构化数据存储和管理能力。开发者在构建需要持久化存储、复杂数据查询或状态管理的工作流和智能体 (Agent) 时，面临诸多不便，往往需要依赖外部数据库或复杂的变量管理。市面上主流的智能体平台（如 Coze, BetterYeah）均提供了集成的数据库功能，允许用户方便地创建、管理数据表，并将其应用于工作流和 Agent 记忆中。

我们拥有一个基于 NocoDB 二次开发的成熟平台 ABS，它提供了强大的多维表格（类数据库）能力，包含空间、应用（Base）、表格等层级。

### 1.2 目标

本方案旨在将 ABS 的核心能力作为**数据库模块**无缝集成到 Bots 平台中，为开发者提供强大、易用且原生的数据存储与管理功能。具体目标包括：

*   为 Bots 工作流提供可靠的结构化数据存储和读写能力。
*   为 Bots 智能体 (Agent) 提供可配置的、基于 ABS 的长期记忆存储机制。
*   在 Bots 平台内提供统一的界面来创建和管理这些"数据库"（ABS 应用）。
*   确保 Bots 空间与 ABS 空间的逻辑关联，实现一致的组织和权限基础。

### 1.3 核心理念

*   **ABS 应用即 Bots 数据库:** 将 ABS 中的"应用 (Base)"概念映射为 Bots 中的"数据库"。每个"数据库"是一个表格的集合。
*   **空间对齐:** Bots 平台的顶层结构"空间"与 ABS 平台的"空间"建立一对一的映射关系。一个 Bots 空间对应一个专属的 ABS 空间，该 Bots 空间下创建的所有"数据库"（ABS 应用）都将位于其对应的 ABS 空间内。
*   **指令驱动交互:** 工作流通过专门设计的数据库指令（已定义）与这些"数据库"进行交互。
*   **记忆工具化:** 智能体 (Agent) 将这些数据库指令作为工具，访问指定的 ABS 表以实现长期记忆。

### 1.4 用户场景示例

为了更具体地阐述数据库模块的价值，以下列举了一些典型的用户场景：

**场景一：工作流数据持久化与查询 (面向工作流开发者)**

*   **用户故事 1.1 (订单信息收集与管理):**
    *   **角色:** 电商平台的运营人员，使用 Bots 工作流处理用户订单。
    *   **场景:** "我需要构建一个工作流，当用户通过聊天机器人下单时，能自动将订单的详细信息（如商品名称、数量、用户联系方式、订单状态）保存到一个结构化的数据库中。后续，我希望能通过另一个工作流或后台查询，根据订单号快速检索订单信息，或定期统计未付款订单。"
    *   **对应功能:** `创建数据库` (例如 "电商订单库")，`创建数据表` (例如 "订单表"，包含订单号、商品、用户ID、状态等字段)，工作流中使用 `添加记录` 指令保存新订单，使用 `获取记录` 指令查询订单。

*   **用户故事 1.2 (用户反馈收集与跟踪):**
    *   **角色:** SaaS 产品经理，使用 Bots 工作流收集用户反馈。
    *   **场景:** "我希望设置一个工作流，当用户在我们的产品内通过机器人提交反馈（问题、建议、Bug）时，系统能将反馈内容、用户ID、提交时间、反馈类型等信息记录到数据库。并且，客服团队可以通过一个内部工作流，根据反馈ID查询反馈详情，并更新处理状态（如已接收、处理中、已解决）。"
    *   **对应功能:** `创建数据库` ("用户反馈中心")，`创建数据表` ("反馈记录表")，`添加记录`，`获取记录`，`编辑记录` (更新处理状态)。

*   **用户故事 1.3 (活动报名与参与者管理):**
    *   **角色:** 市场活动组织者。
    *   **场景:** "我正在组织一场线上研讨会，需要一个工作流来处理报名。当用户通过机器人报名时，我希望将他们的姓名、邮箱、公司、报名时间记录到数据库。活动开始前，我需要能从数据库中导出所有报名成功的用户列表，并通过另一个工作流给他们发送参会提醒。"
    *   **对应功能:** `创建数据库` ("活动管理库")，`创建数据表` ("研讨会报名表")，`添加记录`，`获取记录` (可配合 `SQL自定义节点` 进行筛选和导出)。

**场景二：智能体长期记忆与个性化 (面向智能体开发者)**

*   **用户故事 2.1 (个性化学习助手):**
    *   **角色:** 教育科技开发者，构建一个个性化学习 Agent。
    *   **场景:** "我正在开发一个 AI 学习助手 Agent。我希望它能记住与每个学生的对话历史、学习偏好（例如，喜欢视频还是文本教程）、以及在特定知识点上的掌握程度。当学生再次与 Agent 互动时，Agent 能够基于这些记忆，提供更个性化的学习建议和内容推荐。"
    *   **对应功能:** Agent 配置中指定"数据库"和"数据表"作为长期记忆存储。Agent 通过 `添加记录` 保存关键对话信息和学习状态，通过 `获取记录` 检索历史信息以定制回复。需要设计合理的记忆表结构。

*   **用户故事 2.2 (客户服务 Agent 的上下文保持):**
    *   **角色:** 企业客服系统开发者。
    *   **场景:** "我需要构建一个客服 Agent，能够处理多轮复杂对话。如果用户的问题需要分多次沟通才能解决，或者用户中途断开后再次连接，我希望 Agent 能够记住之前的对话上下文、用户提出的问题以及已经尝试过的解决方案，避免让用户重复描述问题，提升服务效率和用户满意度。"
    *   **对应功能:** Agent 记忆存储配置，使用数据库指令存取对话状态、关键实体、用户意图等。

*   **用户故事 2.3 (任务管理 Agent):**
    *   **角色:** 个人用户或团队成员，希望通过 Agent 管理待办事项。
    *   **场景:** "我希望我的个人助理 Agent 能够帮我记录和管理待办事项。我可以告诉它'明天上午10点提醒我开会'或'把购买牛奶加入购物清单'。Agent 需要将这些任务（任务内容、截止日期、优先级、状态）存储起来，并在适当的时候提醒我，或者在我查询时列出所有未完成的任务。"
    *   **对应功能:** Agent 记忆存储配置，Agent 使用数据库指令 `添加记录` (创建任务)、`获取记录` (查询任务)、`编辑记录` (标记完成/修改截止日期)、`删除记录` (删除任务)。

**场景三：平台管理与资源组织 (面向 Bots 平台管理员)**

*   **用户故事 3.1 (项目数据隔离):**
    *   **角色:** 一家软件外包公司的 Bots 平台管理员。
    *   **场景:** "我们公司同时为多个客户（项目 A, 项目 B, 项目 C）开发和运维聊天机器人。我需要在我们的 Bots 平台中，为每个客户项目创建独立的 Bots 空间。并且，我希望每个项目的数据（例如，项目 A 的订单数据、项目 B 的用户反馈）能够安全地存储在各自独立的数据库中，互不干扰，方便管理和权限控制。"
    *   **对应功能:** Bots 空间与 ABS 空间的映射，确保在一个 Bots 空间下创建的"数据库"（ABS 应用）仅属于该空间。管理员可以在不同空间下创建同名但数据独立的"数据库"。

### 1.5 名词解释

为确保文档的清晰和一致性，以下是本模块 PRD 中常用术语的解释：

*   **Bots 平台 (Bots Platform):** 指用户构建、管理和部署聊天机器人、自动化工作流和智能 Agent 的核心 SaaS 平台。
*   **ABS (Abstracted Backend Service / 可抽象的后端服务):** 在本模块特指用于提供数据库能力的后端服务，如 NocoDB, Baserow 等类 Airtable 的无代码/低代码数据库平台。Bots 平台的数据库模块旨在与这类服务集成。
*   **数据库模块 (Database Module):** 本 PRD 描述的核心功能模块，旨在为 Bots 平台提供集成的、结构化的数据存储和管理能力，通过与 ABS 对接实现。
*   **Bots 空间 (Bots Space):** Bots 平台中用于组织资源、团队协作和隔离数据的基本单位。每个空间可以包含多个机器人、工作流和 Agent。
*   **ABS 工作空间 (ABS Workspace):** 指 ABS (如 NocoDB 中的 "Project" 或 Baserow 中的 "Workspace/Group") 中的顶层组织单元，它可以包含一个或多个数据库 (Base/Database)。在本模块中，一个 Bots 空间对应一个 ABS 工作空间。
*   **Bots 数据库 (Bots Database):** 在 Bots 平台用户视角下的数据库概念，对应 ABS 中的一个 "Base" (NocoDB) 或 "Database" (Baserow)，它位于一个 ABS 工作空间内，并包含一个或多个数据表。
*   **数据表 (Data Table):** 结构化数据的集合，由行（记录）和列（字段）组成。对应 ABS 中的 "Table"。
*   **字段 (Field):** 数据表中的一列，定义了存储在该列中数据的类型和属性（如文本、数字、日期、单选等）。对应 ABS 中的 "Column" 或 "Field"。
*   **记录 (Record):** 数据表中的一行，代表一个具体的数据条目。对应 ABS 中的 "Row"。
*   **工作流 (Workflow):** Bots 平台中用于实现业务流程自动化的功能，由一系列相互连接的指令节点组成。
*   **工作流指令 (Workflow Command/Node):** 工作流中的一个执行单元，数据库模块提供了一系列与数据库交互的指令（如创建表、添加记录等）。
*   **Agent (AI Agent):** Bots 平台中具备一定自主性和智能的程序实体，可以执行任务、与用户交互，并利用数据库模块实现长期记忆。
*   **长期记忆 (Long-term Memory):** 指 Agent 将关键信息和交互历史存储在持久化数据库中，以便在后续交互中回忆和利用这些信息的能力。
*   **API Token/Key:** 用于在程序间进行认证和授权的凭证，Bots 平台后端服务将使用此凭证与 ABS API 进行安全通信。
*   **权限映射 (Permission Mapping):** 将 Bots 平台空间中的用户角色（如所有者、管理员、编辑者、查看者）转换为对相应 ABS 资源（工作空间、数据库、数据表）的具体操作权限的过程。
*   **惰性创建 (Lazy Creation / On-demand Creation):** 一种资源创建策略，指仅在资源首次被实际需要时才进行创建，而不是预先创建。例如，ABS 工作空间在用户首次访问数据库模块时才创建。
*   **CRUD 操作:** 指数据管理中的创建 (Create)、读取 (Read)、更新 (Update)、删除 (Delete) 这四种基本操作。

## 2. 产品概述 (Product Overview)

### 2.1 模块核心功能简介

数据库模块 (ABS 集成) 是 Bots 平台的一个核心扩展功能，旨在为用户提供强大且易用的结构化数据存储与管理能力。通过与成熟的无代码/低代码数据库后端服务 (ABS，如 NocoDB, Baserow) 的集成，本模块允许用户：

1.  **在 Bots 空间内创建和管理专属的数据库环境：** 每个 Bots 空间可以拥有一个独立的、受管的 ABS 工作空间，用于数据隔离和组织。
2.  **通过工作流与数据进行深度交互：** 提供一系列工作流指令节点，使自动化流程能够方便地对数据库进行记录的增、删、改、查 (CRUD) 操作，以及数据库和数据表的创建。
3.  **为 AI Agent 提供长期记忆支持：** Agent 可以利用配置好的数据表作为其长期记忆库，存储和检索对话历史、用户偏好、知识积累等信息，从而提升交互的连贯性和个性化水平。
4.  **基于 Bots 平台角色实现数据访问控制：** 用户的 Bots 空间角色（如所有者、管理员、编辑者、查看者）将自动映射为对关联数据库资源的相应操作权限，确保数据安全和合规。
5.  **接入已有的 ABS 数据资源：** 允许用户将已在独立 ABS 服务中创建和管理的工作空间链接到 Bots 平台，以便在 Bots 平台内统一使用和管理。

本模块的目标是降低用户使用结构化数据的门槛，增强工作流的业务处理能力，并赋予 Agent 更强的上下文感知和记忆能力，从而全面提升 Bots 平台的价值。

### 2.2 模块范围 (V1.0)

**V1.0 版本计划实现的核心功能范围包括：**

**范围内 (In Scope for V1.0):**

*   **空间与工作空间的映射与创建：**
    *   实现 Bots 空间与 ABS 工作空间的一对一映射关系。
    *   支持按需（惰性）创建 ABS 工作空间。
    *   持久化存储和管理映射关系。
*   **基础的数据库和表管理（主要通过工作流指令）：**
    *   工作流指令支持创建 Bots 数据库 (ABS Base/Database)。
    *   工作流指令支持创建数据表 (ABS Table)。
    *   (UI层面) 提供查看已链接/创建的数据库和数据表列表的基本界面。V1.0 的 UI 侧重于连接和配置，而非完整的数据管理界面。
*   **工作流指令集成：**
    *   提供核心的 CRUD（创建、读取、更新、删除记录）工作流指令。
    *   提供用于创建数据库、创建数据表、连接数据表以及执行自定义 SQL (只读为主) 的工作流指令。
    *   确保工作流指令在正确的权限和上下文（`workspaceID`, `token`）中执行。
*   **Agent 长期记忆集成：**
    *   允许用户在 Agent 配置中选择一个数据表作为其长期记忆存储。
    *   Agent 可通过授权的数据库工具对其配置的记忆表进行读写操作。
    *   提供推荐的记忆表结构示例和 Prompt 指导。
*   **权限管理：**
    *   实现基于 Bots 空间角色的权限自动映射到 ABS 资源。
    *   数据库操作指令在执行前进行严格的权限校验。
*   **现有 ABS 资源接入：**
    *   支持用户授权并链接其已有的 ABS 工作空间到指定的 Bots 空间。
    *   链接后，Bots 平台的角色权限将主导该工作空间在 Bots 平台内的访问控制。
*   **核心的错误处理与用户反馈机制。**

**范围外 (Out of Scope for V1.0):**

*   **Bots 平台内提供完整的、类似 ABS 原生界面的数据表结构编辑、数据录入和复杂查询 UI。** (V1.0 用户主要通过 ABS 原生界面进行复杂的数据管理，或通过工作流进行程序化操作)。
*   **复杂的数据迁移工具** (例如，从一个 ABS 工作空间/Base 迁移数据到另一个，或从外部文件批量导入复杂结构的数据，V1.0 侧重"链接"而非"深度迁移")。
*   **在 Bots 平台 UI 内提供超出预设空间角色映射的、更细粒度的自定义权限配置界面。**
*   **跨 Bots 数据库 (ABS Base) 或跨 ABS 工作空间的数据关联查询或操作指令（除非通过自定义 SQL 实现且 ABS 支持）。**
*   **高级数据治理功能** (如数据审计日志、版本控制等，这些依赖于底层 ABS 的能力以及更复杂的集成)。
*   **离线数据同步或缓存机制。**

### 2.3 与其他模块的关系

数据库模块与 Bots 平台的多个核心模块紧密协作，共同为用户提供完整的服务体验：

*   **Bots 空间管理 (Bots Space Management):**
    *   数据库模块的功能与 Bots 空间直接绑定。每个 Bots 空间是数据库资源（对应的 ABS 工作空间）的逻辑容器。
    *   空间的创建、删除等生命周期事件可能需要触发数据库模块的相应操作（如创建/清理映射关系）。
*   **用户管理与身份认证 (User Management & Identity):**
    *   用户的身份和其在特定 Bots 空间中所扮演的角色（所有者、管理员、编辑者、查看者）是数据库模块进行权限判断和映射的依据。
    *   认证服务提供的用户凭证 (token) 将用于代表用户与数据库模块后端服务及 ABS 服务进行安全通信。
*   **工作流引擎 (Workflow Engine):**
    *   数据库模块为工作流引擎提供了一套专门的指令节点，使其能够将数据存取能力融入自动化流程中。
    *   工作流引擎负责调度和执行这些数据库指令，并处理其输入输出参数。
*   **Agent 服务 (Agent Service):**
    *   Agent 可以配置使用数据库模块管理的某个数据表作为其长期记忆的存储后端。
    *   Agent 服务通过调用数据库模块提供的工具（基于工作流指令或专用 API）来实现对记忆数据的读写。
*   **API 网关/后端服务 (API Gateway/Backend Services):**
    *   数据库模块的后端逻辑（如与 ABS 的交互、权限校验、映射管理）作为 Bots 平台后端服务的一部分。
    *   API 网关负责接收来自前端 UI、工作流引擎或 Agent 服务的请求，并将其路由到数据库模块的相关处理逻辑。

通过这些模块间的协同工作，数据库模块能够无缝集成到 Bots 平台的整体架构中，为用户提供一致且强大的数据处理能力。

## 3. 目标用户 (Target Users)

*   **工作流开发者/设计者:** 需要在自动化流程中存储、查询、更新结构化数据的人员。
*   **智能体 (Agent) 创建者/开发者:** 需要为 Agent 构建长期记忆、知识库或需要 Agent 操作结构化数据的场景。
*   **Bots 平台管理员:** 需要管理平台数据存储资源和权限的人员。
*   **最终用户 (间接):** 与使用了数据库功能的工作流或 Agent 交互的用户，将体验到更智能、更连贯、功能更强大的服务。

## 4. 范围 (Scope)

### 4.1 V1.0 范围内 (In Scope)

*   **空间映射机制:** 建立 Bots 空间与 ABS 空间的关联机制（具体实现待定，可能是按需创建或后台同步）。
*   **数据库模块 UI:** 在 Bots 平台内提供一个专门的"数据库"导航入口和管理界面。
*   **创建数据库 (ABS 应用):** 用户可以在 Bots UI 内，在当前空间下创建新的"数据库"（对应在关联的 ABS 空间下创建 Base/应用）。输入字段包括数据库名称、描述。
*   **查看数据库列表:** 在数据库模块 UI 中展示当前 Bots 空间下的所有"数据库"（ABS 应用）列表。
*   **创建数据表 (ABS 表格):** 用户可以在选定的"数据库"下创建新的数据表。输入字段包括表名、描述（V1.0 可能仅支持创建空表或带默认字段）。
*   **查看数据表列表:** 在选定的"数据库"详情页展示其下的数据表列表。
*   **工作流指令集成:** 实现已定义的数据库相关指令：
    *   `新建数据库` (CreateDatabase / ABS 应用)
    *   `新建数据表` (CreateTable)
    *   `连接数据表` (ConnectDataTable)
    *   `添加记录` (AddRecord)
    *   `获取记录` (GetRecords)
    *   `编辑记录` (UpdateRecord)
    *   `删除记录` (DeleteRecord)
    *   `SQL自定义节点` (ExecuteCustomSQL, V1.0 限制于操作当前 Base)
*   **Agent 长期记忆配置:** 允许在 Agent 配置中指定一个 ABS 数据库 (Base) 和数据表 (Table) 作为其长期记忆存储。
*   **Agent 工具授权:** 自动为配置了记忆存储的 Agent 授权使用上述数据库指令（操作其指定的记忆库）。
*   **基础权限映射:** 实现基于 Bots 空间角色的基础权限映射。例如，Bots 空间管理员默认拥有对应 ABS 空间的管理权限（包括创建/删除应用/数据库），空间成员拥有读写权限（需细化）。

### 4.2 V1.0 范围外 (Out of Scope)

*   **复杂的数据库/表结构管理:** 在 Bots UI 内进行复杂的字段添加/编辑/删除、视图创建/管理、关系设置等高级 ABS 功能（用户如有需要可引导至 ABS 平台操作）。
*   **在 Bots UI 内直接浏览和编辑数据记录:** V1.0 重点在于创建、管理元数据以及提供给工作流/Agent 的接口。数据浏览/编辑可能需要跳转到 ABS 或后续版本迭代。
*   **跨 Bots 空间访问数据库:** V1.0 的数据库操作限制在当前空间对应的 ABS 空间内。
*   **精细化的表/字段/行级权限控制:** V1.0 依赖于基于空间角色的粗粒度权限映射。
*   **数据库备份、恢复、迁移等运维功能:** 这些仍依赖于 ABS 平台自身。
*   **实时数据同步/推送机制:** (除非 ABS/NocoDB 天然支持并通过 API 暴露)。

## 5. 核心概念与映射 (Core Concepts & Mapping)

| Bots 平台概念          | ABS 平台概念           | 说明                                       |
| :--------------------- | :--------------------- | :----------------------------------------- |
| Bots 空间 (Space)      | ABS 空间 (Workspace)   | 顶层组织单元，建立一对一关联。             |
| **Bots 数据库 (Database)** | **ABS 应用 (Base)**    | **核心映射**。Bots 中管理和引用的数据库实例。 |
| Bots 数据表 (Table)    | ABS 表格 (Table)       | 数据库 (Base) 内的数据存储单元。           |
| Bots 记录 (Record)     | ABS 记录 (Row)         | 数据表中的一行数据。                       |
| Bots 字段 (Field)      | ABS 列 (Column/Field)  | 数据表中的一列定义。                       |
| Bots 数据库模块 (UI)   | N/A (Bots 平台界面)  | Bots 内用于管理"数据库"(ABS Bases) 的界面。 |

## 6. 功能需求 (Functional Requirements)

### 6.1 空间与数据库管理 (UI & Backend)

| ID      | 模块         | 需求描述                                                                                                | 优先级 | 备注                                                                                                                                 |
| :------ | :----------- | :------------------------------------------------------------------------------------------------------ | :----- | :----------------------------------------------------------------------------------------------------------------------------------- |
| F-DB-01 | 空间关联     | 系统需确保每个 Bots 空间都对应一个唯一的 ABS 工作空间，用于存储该 Bots 空间下创建的所有"数据库"(ABS 应用)。详细策略及流程见章节 `5.1.1`。 | 高     | 这是数据库模块功能的基础。                                                                                                               |
| F-DB-02 | 数据库模块 UI | 在 Bots 主导航中增加"数据库"入口。点击后进入数据库管理页面，默认展示当前空间下的数据库列表。                           | 高     |                                                                                                                                      |
| F-DB-03 | 数据库列表   | 数据库管理页面以列表或卡片形式展示当前空间下的所有数据库（ABS 应用）。应显示数据库名称、描述、创建时间、创建者（可选）等。      | 高     | 需要调用 ABS API 获取当前 Bots 空间关联的 ABS 工作空间下的应用列表。                                                                     |
| F-DB-04 | 创建数据库   | 提供"新建数据库"按钮。点击后弹出表单，用户输入数据库名称（必填，需校验唯一性和规则）、描述（可选）。提交后调用 ABS API 在当前 Bots 空间关联的 ABS 工作空间内创建新应用。 | 高     | 对应 `新建数据库` 指令的核心功能。需处理命名冲突、权限不足等错误。成功后列表应刷新。                                                             |
| F-DB-05 | 查看数据库   | 点击数据库列表中的条目，可以进入该数据库的详情页（或直接展示其下的数据表列表）。                                        | 高     |                                                                                                                                      |
| F-DB-06 | 删除数据库   | （V1.0 可选）在数据库列表或详情页提供"删除"操作。需有二次确认，明确告知删除的风险（数据将丢失，关联的工作流/Agent 可能失败）。 | 中     | 需要谨慎处理：删除 ABS 应用是高危操作。需检查依赖关系？软删除？                                                                              |
| F-DB-07 | 数据库搜索/过滤 | （V1.0 可选）提供基于数据库名称的搜索或过滤功能。                                                                | 低     | 如果数据库数量不多，V1.0 可省略。                                                                                                  |

#### 5.1.1 Bots 空间与 ABS 工作空间的映射与创建策略

**5.1.1.1 核心原则**

*   **一对一映射:** 每个 Bots 平台的"空间 (Space)"都将严格对应一个 ABS 平台的"工作空间 (Workspace)"。此 ABS 工作空间将专门用于存放该 Bots 空间下用户创建的所有"Bots 数据库"（即 ABS 应用/Base）。
*   **数据隔离:** 此映射确保了不同 Bots 空间的数据在 ABS 层面也是隔离的，符合多租户和项目隔离的原则。
*   **持久化映射关系:** 系统需要持久化存储 Bots Space ID 与其对应的 ABS Workspace ID 之间的映射关系。建议使用专门的数据库表（例如 `bots_space_abs_workspace_mapping` 表，包含字段如 `bots_space_id`, `abs_workspace_id`, `status`, `created_at`, `updated_at`）。

**5.1.1.2 ABS 工作空间创建策略 (V1.0 推荐：按需惰性创建)**

为了优化用户体验和资源利用，V1.0 版本推荐采用**按需惰性创建 (On-Demand/Lazy Creation)** 的策略。

*   **策略描述:** 关联的 ABS 工作空间并不会在 Bots 空间创建时立即同步创建。而是在用户**首次尝试访问**特定 Bots 空间内的"数据库"模块功能时（例如，点击主导航的"数据库"入口，或工作流尝试执行"新建数据库"指令），系统才会检查并创建对应的 ABS 工作空间。
*   **优点:**
    *   Bots 空间创建速度更快，因为不涉及即时的 ABS API 调用。
    *   仅当用户确实需要使用数据库功能时，才在 ABS 平台创建和消耗工作空间资源。
    *   避免了因 Bots 空间创建后从未被使用其数据库功能而产生空置的 ABS 工作空间。
*   **缺点:**
    *   用户首次访问特定空间的"数据库"模块时，可能会经历一个短暂的初始化/加载过程。
    *   需要处理首次创建 ABS 工作空间可能发生的各种异常情况，并向用户提供清晰反馈。

**5.1.1.3 按需惰性创建流程详解**

1.  **用户触发:** 用户在某个 Bots 空间 (例如 `Space_A`) 内，首次点击导航栏的 "数据库" 模块入口。
2.  **系统检查映射:**
    *   Bots 后端根据当前 `Space_A` 的 `bots_space_id` 查询 `bots_space_abs_workspace_mapping` 表。
3.  **分支处理:**
    *   **情况一：映射已存在且有效 (之前已创建成功):**
        *   系统获取到对应的 `abs_workspace_id`。
        *   直接使用此 `abs_workspace_id` 调用 ABS API，获取该 ABS 工作空间下的应用列表 (即 Bots 数据库列表)，并展示给用户。流程结束。
    *   **情况二：映射不存在或状态无效 (首次访问此空间的数据库模块):**
        *   **前端反馈:** 界面向用户显示一个友好的加载/初始化提示，例如："正在为您初始化数据库环境，请稍候..."
        *   **后端执行创建:**
            1.  Bots 后端服务发起调用 ABS API，请求创建一个新的 ABS 工作空间。
                *   **命名策略:** 新 ABS 工作空间的名称可以基于 Bots 空间的名称（可能需要处理特殊字符和长度限制），或者使用 Bots Space ID，或两者的组合，以确保唯一性和可追溯性。例如："BotsSpace_SpaceName_SpaceID" 或仅使用 `Bots_Space_ID` 作为标识（如果 ABS 支持通过 ID 查找）。
                *   **权限设置:** 创建 ABS 工作空间时，需要为当前操作用户（通常是 Bots 空间的所有者/管理员）或 Bots 平台的系统服务账号授予在该 ABS 工作空间内的管理员权限（至少包含创建应用/Base 的权限）。
            2.  **处理 ABS API 响应:**
                *   **创建成功:** ABS API 返回新创建的 `abs_workspace_id`。
                    *   Bots 后端将 `bots_space_id` 和新的 `abs_workspace_id` 及其成功状态存入 `bots_space_abs_workspace_mapping` 表。
                    *   **前端反馈:** 加载提示消失，页面显示数据库模块的初始界面（通常是一个空的数据库列表，并有"新建数据库"的引导）。流程结束。
                *   **创建失败 (关键异常处理):**
                    *   **ABS 服务不可达/超时:** 向用户显示"数据库服务暂时不可用，请稍后重试。"并记录错误。
                    *   **ABS 账户/配额问题** (例如，ABS 平台已达到最大工作空间数量限制): 向用户显示"无法初始化数据库环境，可能由于您的 ABS 账户限制。请检查您的 ABS 账户或联系支持。"
                    *   **Bots 平台权限不足** (例如，用于创建 ABS 工作空间的服务账号权限配置错误): 向用户显示通用错误"数据库环境初始化失败，请联系平台管理员。"并详细记录内部错误。
                    *   在失败情况下，`bots_space_abs_workspace_mapping` 表中不应创建记录，或标记为失败状态，以便下次尝试时重新执行创建流程。
        *   **前端最终反馈:**
            *   若成功，则正常展示数据库模块。
            *   若失败，加载提示消失，替换为清晰的错误信息和可能的下一步操作建议（如"重试"、"联系支持"）。

**5.1.1.4 对工作流指令的影响**

当工作流执行数据库相关指令（如 `新建数据库`、`新建数据表`）时，如果目标 Bots 空间尚未初始化其对应的 ABS 工作空间，指令执行器应能触发或等待上述 `5.1.1.3` 中的按需创建流程完成，然后再执行指令本身。这意味着指令执行可能包含首次初始化的延迟。

**5.1.1.5 其他考虑**

*   **幂等性:** ABS 工作空间的创建过程应设计为幂等的。如果因网络问题导致首次创建请求后未收到确认，再次尝试时不应创建重复的工作空间，而是能够识别并关联已创建（但可能未记录映射）的工作空间。
*   **Bots 空间删除:** 当一个 Bots 空间被删除时，其关联的 ABS 工作空间是否也应被删除？V1.0 可能不处理自动删除 ABS 工作空间，以防数据误删，可作为未来考虑。如果删除，需要明确告知用户数据将一并清除。

### 5.2 数据表管理 (UI & Backend)

| ID      | 模块     | 需求描述                                                                                                  | 优先级 | 备注                                                                       |
| :------ | :------- | :-------------------------------------------------------------------------------------------------------- | :----- | :------------------------------------------------------------------------- |
| F-TBL-01 | 数据表列表 | 在数据库详情页中，展示该数据库（ABS 应用）下的所有数据表列表。应显示表名、描述（可选）、记录数（可选）等。                     | 高     | 需要调用 ABS API 获取指定 Base 下的表格列表。                                |
| F-TBL-02 | 创建数据表 | 在数据库详情页提供"新建数据表"按钮。点击后弹出表单，用户输入表名（必填，需校验应用内唯一性和规则）、描述（可选）。提交后调用 ABS API 创建新表格。 | 高     | 对应 `新建数据表` 指令的核心功能。V1.0 创建空表或带基础系统字段（如 ID）。 |
| F-TBL-03 | 删除数据表 | （V1.0 可选）在数据表列表提供"删除"操作。需二次确认。                                                          | 中     | 同删除数据库，需谨慎。                                                       |
| F-TBL-04 | 跳转至 ABS | （V1.0 推荐）在数据库或数据表层面，提供一个明显的链接或按钮，可以跳转到对应的 ABS 平台界面进行高级操作（如编辑表结构、管理视图、浏览数据等）。 | 高     | 避免在 Bots 中重复造轮子，引导用户到功能更全的 ABS 进行高级管理。            |

### 5.3 工作流指令集成

| ID      | 模块   | 需求描述                                                                     | 优先级 | 备注                                     |
| :------ | :----- | :--------------------------------------------------------------------------- | :----- | :--------------------------------------- |
| F-WF-01 | 指令实现 | 实现 `新建数据库`, `新建数据表`, `连接数据表`, `添加记录`, `获取记录`, `编辑记录`, `删除记录`, `SQL自定义节点` 指令的后端逻辑，使其能够与 ABS API 交互，并在正确的空间和应用/表上下文中执行。详见 `5.3.1`。 | 高     | 遵循已定义的指令文档规范。                 |
| F-WF-02 | 指令可用 | 在工作流编辑器的节点面板中，提供这些数据库相关的指令供用户选择和使用。             | 高     | 需要规划好指令的分类（例如放在"数据库"或"存储"类别下）。 |
| F-WF-03 | 上下文注入 | 工作流运行时，系统需要自动为这些指令注入正确的凭证 (`token`) 和当前 Bots 空间对应的 ABS `workspaceID`。      | 高     | 核心机制，确保安全和正确执行。             |

#### 5.3.1 工作流指令详情与参数建议 (V1.0)

以下是 V1.0 范围内数据库相关指令的简要描述及其建议的关键输入/输出参数。(*注：具体参数名称和类型可能需要根据实际技术实现调整。*)

1.  **`新建数据库 (CreateDatabase)`**
    *   **描述:** 在当前 Bots 空间下创建一个新的 Bots 数据库 (即 ABS 应用/Base)。
    *   **输入参数:**
        *   `databaseName` (字符串, 必填): 新数据库的名称。
        *   `description` (字符串, 可选): 数据库的描述。
    *   **输出参数:**
        *   `success` (布尔值): 操作是否成功。
        *   `databaseId` (字符串, 若成功): 新创建的 Bots 数据库 ID (即 ABS Base ID)。
        *   `errorMessage` (字符串, 若失败): 错误信息。
    *   **备注:** 此指令由具有相应权限（如空间所有者、管理员、编辑者）的用户触发的工作流执行。

2.  **`新建数据表 (CreateTable)`**
    *   **描述:** 在指定的 Bots 数据库中创建一个新的数据表 (即 ABS 表格)。
    *   **输入参数:**
        *   `databaseId` (字符串, 必填): 目标 Bots 数据库 ID (ABS Base ID)。可通过"连接数据表"指令获取或直接输入。
        *   `tableName` (字符串, 必填): 新数据表的名称。
        *   `description` (字符串, 可选): 数据表的描述。
        *   **(V1.0 可选)** `fields` (对象数组, 可选): 定义初始字段 (例如: `[{name: "column1", type: "text"}, {name: "column2", type: "number"}]`)。V1.0 可能仅支持创建空表或带系统默认字段。
    *   **输出参数:**
        *   `success` (布尔值): 操作是否成功。
        *   `tableId` (字符串, 若成功): 新创建的数据表 ID (ABS Table ID)。
        *   `errorMessage` (字符串, 若失败): 错误信息。

3.  **`连接数据表 (ConnectDataTable)`**
    *   **描述:** 用于在工作流中指定要操作的目标数据库和数据表，并获取其元信息。通常作为后续数据操作指令的前置步骤。
    *   **输入参数:**
        *   `databaseNameOrId` (字符串, 必填): 目标 Bots 数据库的名称或 ID。
        *   `tableNameOrId` (字符串, 必填): 目标数据表的名称或 ID。
    *   **输出参数:**
        *   `success` (布尔值): 连接是否成功（即数据库和表是否存在且可访问）。
        *   `databaseId` (字符串, 若成功): 目标数据库 ID (ABS Base ID)。
        *   `tableId` (字符串, 若成功): 目标数据表 ID (ABS Table ID)。
        *   `fields` (对象数组, 若成功): 数据表的字段列表及其类型信息 (例如 `[{name: "ID", type: "autonumber"}, {name: "email", type: "email"}]`)。
        *   `errorMessage` (字符串, 若失败): 错误信息。
    *   **备注:** 此指令主要用于动态获取 `databaseId` 和 `tableId` 以供其他指令使用，并帮助用户了解表结构。

4.  **`添加记录 (AddRecord)`**
    *   **描述:** 向指定的数据表中添加一条新记录。
    *   **输入参数:**
        *   `databaseId` (字符串, 必填): 目标 Bots 数据库 ID。
        *   `tableId` (字符串, 必填): 目标数据表 ID。
        *   `recordData` (对象, 必填): 要添加的记录数据，键值对形式，键为字段名，值为字段值 (例如 `{"name": "Alice", "age": 30}` )。
    *   **输出参数:**
        *   `success` (布尔值): 操作是否成功。
        *   `recordId` (字符串/数字, 若成功): 新添加记录的 ID。
        *   `errorMessage` (字符串, 若失败): 错误信息。

5.  **`获取记录 (GetRecords)`**
    *   **描述:** 从指定的数据表中检索符合条件的记录。
    *   **输入参数:**
        *   `databaseId` (字符串, 必填): 目标 Bots 数据库 ID。
        *   `tableId` (字符串, 必填): 目标数据表 ID。
        *   `filter` (对象/字符串, 可选): 过滤条件 (例如，使用 NocoDB 的过滤语法或简化的键值对 `{ "status": "pending" }`)。V1.0 可简化为等值匹配。
        *   `sort` (对象/字符串, 可选): 排序条件 (例如 `{"field": "createdAt", "order": "desc"}` )。
        *   `limit` (数字, 可选): 返回记录的最大数量 (默认为例如 100)。
        *   `offset` (数字, 可选): 跳过的记录数量，用于分页。
        *   `fieldsToSelect` (字符串数组, 可选): 指定要返回的字段列表 (默认返回所有字段)。
    *   **输出参数:**
        *   `success` (布尔值): 操作是否成功。
        *   `records` (对象数组, 若成功): 检索到的记录列表。
        *   `totalCount` (数字, 可选, 若成功): 符合条件的总记录数 (不考虑 limit/offset 时)。
        *   `errorMessage` (字符串, 若失败): 错误信息。

6.  **`编辑记录 (UpdateRecord)`**
    *   **描述:** 更新指定数据表中的一条或多条符合条件的记录。
    *   **输入参数:**
        *   `databaseId` (字符串, 必填): 目标 Bots 数据库 ID。
        *   `tableId` (字符串, 必填): 目标数据表 ID。
        *   `recordId` (字符串/数字, 可选): 如果更新单条记录，则提供记录 ID。
        *   `filter` (对象/字符串, 可选): 如果批量更新，则提供过滤条件（同 `GetRecords`）。
        *   `updateData` (对象, 必填): 要更新的字段及其新值 (例如 `{"status": "completed", "notes": "Task finished"}` )。
    *   **输出参数:**
        *   `success` (布尔值): 操作是否成功。
        *   `updatedCount` (数字, 若成功): 成功更新的记录数量。
        *   `errorMessage` (字符串, 若失败): 错误信息。
    *   **备注:** 如果同时提供了 `recordId` 和 `filter`，通常以 `recordId` 为准。需明确批量更新的行为和风险。

7.  **`删除记录 (DeleteRecord)`**
    *   **描述:** 从指定数据表中删除一条或多条符合条件的记录。
    *   **输入参数:**
        *   `databaseId` (字符串, 必填): 目标 Bots 数据库 ID。
        *   `tableId` (字符串, 必填): 目标数据表 ID。
        *   `recordId` (字符串/数字, 可选): 如果删除单条记录，则提供记录 ID。
        *   `filter` (对象/字符串, 可选): 如果批量删除，则提供过滤条件（同 `GetRecords`）。
    *   **输出参数:**
        *   `success` (布尔值): 操作是否成功。
        *   `deletedCount` (数字, 若成功): 成功删除的记录数量。
        *   `errorMessage` (字符串, 若失败): 错误信息。

8.  **`SQL自定义节点 (ExecuteCustomSQL)`**
    *   **描述:** 执行用户自定义的 SQL 查询语句（主要针对查询，V1.0 可能限制写操作）。
    *   **输入参数:**
        *   `databaseId` (字符串, 必填): 目标 Bots 数据库 ID (ABS Base ID，SQL 将在此 Base 的上下文中执行)。
        *   `sqlQuery` (字符串, 必填): 要执行的 SQL 语句 (例如 `"SELECT * FROM orders WHERE status = ? AND amount > ?"`)。
        *   `parameters` (数组, 可选): 用于参数化查询的参数值 (例如 `["pending", 100]`)，以防止 SQL 注入。
    *   **输出参数:**
        *   `success` (布尔值): 操作是否成功。
        *   `result` (对象数组 / 其他, 若成功): SQL 查询的结果。对于 `SELECT`，通常是记录数组；对于其他语句可能是影响行数等。
        *   `errorMessage` (字符串, 若失败): 错误信息。
    *   **安全备注:** 必须强制使用参数化查询。V1.0 可能只允许执行只读查询 (`SELECT`)，或对可执行的 SQL 类型进行严格限制。执行权限也受用户角色映射的限制。

### 5.4 Agent 长期记忆集成

| ID      | 模块     | 需求描述                                                                                             | 优先级 | 备注                       |
| :------ | :------- | :--------------------------------------------------------------------------------------------------- | :----- | :------------------------- |
| F-MEM-01 | 配置界面 | 在 Agent 配置界面，增加"长期记忆存储"设置项，允许用户选择一个当前空间下的 ABS 数据库 (Base) 和数据表 (Table) 作为记忆库。 | 高     | 存储 `base_id` 和 `table_id`。 |
| F-MEM-02 | 工具授权 | 当 Agent 配置了记忆存储后，自动为其添加可用的数据库操作指令（`添加记录`, `获取记录`, `编辑记录`, `删除记录`）作为其可用工具，操作范围限定于其配置的记忆库。       | 高     |                            |
| F-MEM-03 | Prompt指导 | 提供默认的或推荐的 System Prompt 模板片段，指导 Agent 如何使用数据库工具进行记忆的存、取、改、查。                 | 高     | 结合推荐的记忆表结构 (见 `5.4.5`)。       |
| F-MEM-04 | 执行上下文 | Agent 调用数据库工具时，系统需确保操作目标是其配置的记忆库，并使用正确的凭证和上下文。                               | 高     |                            |

#### 5.4.5 推荐的 Agent 记忆表结构示例

为了帮助用户快速上手并规范 Agent 记忆的使用，平台可以提供一个或多个推荐的记忆表结构。以下是一个通用的对话式记忆表结构示例：

**表名 (示例):** `agent_conversation_memory`

| 字段名          | 字段类型 (ABS) | 描述                                                                  | 备注                                     |
| :-------------- | :------------- | :-------------------------------------------------------------------- | :--------------------------------------- |
| `id`            | `ID` (自增)   | 记录的唯一标识符。                                                        | ABS 自动生成。                           |
| `session_id`    | `SingleLineText` / `UUID` | 唯一标识一次完整的对话会话。                                              | Agent 在新会话开始时生成或接收。         |
| `interaction_id`| `SingleLineText` / `UUID` | 唯一标识一次用户与 Agent 的交互轮次（可选，用于更细粒度追踪）。             | Agent 每次交互生成。                     |
| `user_id`       | `SingleLineText` | 用户的唯一标识符。                                                        | 从会话上下文中获取。                       |
| `user_query`    | `LongText`     | 用户的原始输入/问题。                                                     |                                          |
| `agent_response`| `LongText`     | Agent 的回复内容。                                                        |                                          |
| `entities`      | `JSON` / `LongText` | 从用户查询中提取的关键实体（例如，JSON 格式 `{"location": "北京", "time": "明天"}`）。 | 可选，用于结构化记忆。                   |
| `intent`        | `SingleLineText` | 识别到的用户意图。                                                        | 可选。                                   |
| `summary`       | `LongText`     | 本轮交互或截止目前会话的摘要（可选，可由 Agent 自行生成并存储）。               | 用于快速回顾上下文。                     |
| `metadata`      | `JSON` / `LongText` | 其他元数据，如情感分析结果、知识库引用ID等。                                  | 灵活扩展。                               |
| `timestamp`     | `DateTime`     | 交互发生的时间戳。                                                        | Agent 记录交互时间。                     |
| `created_at`    | `CreatedAt`    | 记录创建时间。                                                            | ABS 自动生成。                           |
| `updated_at`    | `UpdatedAt`    | 记录最后更新时间。                                                        | ABS 自动生成。                           |

**使用建议:**

*   Agent 在 System Prompt 中可以被告知此表结构。
*   引导 Agent 在每次交互后，使用 `添加记录` 工具将关键信息（如 `session_id`, `user_query`, `agent_response`, `timestamp` 以及提取的 `entities` 或 `summary`）保存到此表中。
*   当需要回忆或保持上下文时，引导 Agent 使用 `获取记录` 工具，通过 `session_id` (以及可能的 `user_id` 或 `timestamp` 范围) 查询历史交互，并利用这些信息生成更连贯和个性化的回复。
*   对于特定任务型 Agent（如任务管理 Agent），表结构会更专业化（如包含 `task_name`, `due_date`, `status`, `priority` 等字段）。

**在 Agent 配置界面:**

*   当用户选择或创建一个表作为记忆库时，如果该表结构与推荐结构差异较大，可以给出提示或建议。
*   提供一个选项，允许用户基于推荐模板快速创建一个新的数据表作为记忆库。

### 5.5 权限管理

| ID      | 模块   | 需求描述                                                                                                                               | 优先级 | 备注                                                                               |
| :------ | :----- | :------------------------------------------------------------------------------------------------------------------------------------- | :----- | :--------------------------------------------------------------------------------- |
| F-PERM-01 | 基础映射 | 实现基于 Bots 空间角色的权限映射至对应的 ABS 工作空间及内部资源 (应用/Base, 表格)。详细策略及流程见章节 `5.5.1`。 | 高     | V1.0 的核心安全机制。需要与 ABS 权限体系对接。                                           |
| F-PERM-02 | 指令校验 | 每个数据库指令执行前，需校验调用者（通常是 Bots 后端服务代表工作流触发用户或 Agent）是否具有执行该操作所需的（映射后的）ABS 权限。详细策略见章节 `5.5.2`。                                         | 高     | 例如，`添加记录` 需要校验是否有对应表的写入权限。                                     |

#### 5.5.1 Bots 空间角色到 ABS 权限的映射策略 (V1.0)

**5.5.1.1 核心原则**

*   **最小权限原则:** 用户在 ABS 中获得的权限应仅限于其在 Bots 空间角色所必需的最小范围，以完成其在 Bots 平台内的操作。
*   **Bots 平台主导权限变更:** Bots 平台内的空间角色和成员变动是权限变更的唯一驱动源。用户不应直接在 ABS 平台修改这些由 Bots 管理的映射权限，以避免不一致。
*   **空间级隔离:** 用户的权限严格限制在其当前操作的 Bots 空间所对应的 ABS 工作空间内。不允许通过 Bots 平台的数据库模块进行跨 Bots 空间的数据库访问（V1.0 范围）。
*   **权限同步机制:** Bots 空间成员角色的添加、移除或变更，应能有效地同步到对应的 ABS 工作空间权限设置中。

**5.5.1.2 V1.0 Bots 空间角色与 ABS 权限映射表 (示例)**

假设 Bots 平台空间有以下典型角色：

*   **空间所有者 (Space Owner):** 创建该 Bots 空间的用户。
*   **空间管理员 (Space Admin):** 由所有者或其他管理员添加，拥有空间内所有管理权限的用户。
*   **空间编辑者 (Space Editor):** 可以创建和编辑空间内资源（如工作流、Agent、数据库、数据表）的用户。
*   **空间查看者 (Space Viewer):** 只能查看空间内资源，不能进行修改的用户。

*ABS 平台（NocoDB）的权限层级通常包括：工作空间 (Workspace)、应用/Base (Project/Base)、表格 (Table)、字段 (Column)、行 (Row)。V1.0 的映射将主要关注工作空间、应用和表格层面。*

| Bots 空间角色     | 对应 ABS 工作空间级别权限                                   | 对应 ABS 应用 (Bots 数据库) 级别权限                                  | 对应 ABS 表格 (Bots 数据表) 级别权限                                     | 关键操作权限 (通过 Bots 数据库模块 UI/指令)                                                                                                                                                                                                     |
| :---------------- | :--------------------------------------------------------- | :-------------------------------------------------------------------- | :----------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **空间所有者**   | 所有者/管理员 (Owner/Admin) - 完全控制此 ABS 工作空间         | 创建者/所有者 (Creator/Owner) - 对其创建的及工作空间内的所有应用有完全控制权  | 创建者/所有者 (Creator/Owner) - 对其创建的及应用内的所有表格有完全控制权     | **Bots UI:** 创建/删除数据库, 创建/删除数据表。<br>**工作流/Agent 指令:** `新建数据库`, `新建数据表`, `添加记录`, `获取记录`, `编辑记录`, `删除记录`, `SQL自定义节点` (完全权限)。                                                                       |
| **空间管理员**   | 管理员 (Admin) - 完全控制此 ABS 工作空间                        | 创建者/所有者 (Creator/Owner) - 对工作空间内的所有应用有完全控制权          | 创建者/所有者 (Creator/Owner) - 对应用内的所有表格有完全控制权             | **Bots UI:** 创建/删除数据库, 创建/删除数据表。<br>**工作流/Agent 指令:** `新建数据库`, `新建数据表`, `添加记录`, `获取记录`, `编辑记录`, `删除记录`, `SQL自定义节点` (完全权限)。                                                                       |
| **空间编辑者**   | 编辑者/协作者 (Editor/Collaborator) - 可在此工作空间内创建应用    | 创建者/编辑者 (Creator/Editor) - 可创建应用；对其创建的应用有完全控制权；对他人创建的应用可创建表格、读写记录。 | 创建者/编辑者 (Creator/Editor) - 可创建表格；对其创建的表格有完全控制权；对他人创建的表格可读写记录。 | **Bots UI:** 创建数据库, 创建数据表, (可选)删除其创建的数据库/数据表。<br>**工作流/Agent 指令:** `新建数据库`, `新建数据表`, `添加记录`, `获取记录`, `编辑记录`, `删除记录`, `SQL自定义节点` (受限于其对目标表的操作权限)。 |
| **空间查看者**   | 查看者 (Viewer) - 仅可查看此工作空间及其内容                   | 查看者 (Viewer) - 仅可查看应用及其元数据                               | 查看者 (Viewer) - 仅可查看表格结构和读取记录                                 | **Bots UI:** 查看数据库列表, 查看数据表列表。<br>**工作流/Agent 指令:** `获取记录`, 执行只读的 `SQL自定义节点`。                                                                                                                                   |

**注:**
*   "完全控制权"通常意味着对该层级资源（及其子资源）的创建、读取、更新、删除 (CRUD) 以及权限管理（如果 ABS 角色允许）。
*   ABS 的具体角色名称（如 `creator`, `editor`, `viewer`, `commenter`, `no-access` 等）需根据 NocoDB 实际提供的角色及其权限范围进行精确匹配。
*   Bots 平台后端服务将代表用户执行操作，因此需要一个机制（如服务账户或用户Token代理）来与 ABS API 交互，并确保操作遵循上述映射的权限。

**5.5.1.3 权限同步机制**

*   **事件驱动同步 (推荐):**
    *   当 Bots 空间发生以下事件时，应触发对 ABS 对应工作空间权限的更新：
        *   新成员加入 Bots 空间。
        *   成员在 Bots 空间的角色发生变更。
        *   成员从 Bots 空间被移除。
        *   (如果支持) Bots 空间被删除 (可能涉及 ABS 工作空间的归档或权限清理)。
    *   此同步通过 Bots 后端调用 ABS API 实现，例如添加/移除用户到 ABS 工作空间，或修改用户在 ABS 工作空间/应用/表格的角色。
*   **定期校验 (可选，作为补充):** 可以考虑设置一个定期任务，校验 Bots 空间成员与 ABS 工作空间权限的一致性，以捕获任何潜在的同步遗漏或外部干扰。
*   **冲突处理:** 以 Bots 平台的角色和成员关系为"唯一事实来源 (Source of Truth)"。如果在 ABS 端直接修改了与 Bots 空间关联的权限，Bots 平台的同步机制应有能力将其纠正回基于 Bots 空间角色定义的权限。

**5.5.1.4 边界情况与特殊处理**

*   **Bots 空间所有者/管理员变更:** 当 Bots 空间的所有者或管理员发生变更时，其在 ABS 对应工作空间的最高权限也应相应转移或授予。
*   **用户账户注销/禁用:** 当用户在 Bots 平台或统一用户中心的账户被注销或禁用时，应评估其在所有关联 ABS 工作空间的权限是否需要被移除或禁用。
*   **ABS 空间创建时的初始权限:** 在按需创建 ABS 工作空间时（参考 `5.1.1.3`），创建该工作空间的 Bots 用户（通常是首次触发数据库功能的所有者或管理员）应自动获得该 ABS 工作空间的最高管理权限。
*   **ABS 平台直接操作的权限:** 本权限映射主要针对通过 Bots 平台 UI 和指令进行的数据库操作。如果用户通过"跳转到 ABS"功能直接在 ABS 平台操作，则遵循 ABS 自身的权限校验逻辑。理想情况下，用户在 ABS 中看到的权限应与其 Bots 角色映射的权限一致。

#### 5.5.2 指令执行时的权限校验

*   **执行主体:** 数据库相关的指令（如 `添加记录`, `获取记录` 等）以及 Agent 使用数据库工具时，实际的 API 调用是由 Bots 后端服务发起的。
*   **上下文传递:** Bots 后端服务在调用 ABS API 时，必须能够识别出操作发起的用户（或工作流/Agent 的归属用户/空间）及其在当前 Bots 空间的角色。
*   **后端校验:**
    1.  在执行任何数据库操作指令前，Bots 后端需要根据操作类型（读、写、创建、删除等）和目标资源（数据库、数据表），结合 `5.5.1.2` 中的权限映射表，判断当前用户（基于其 Bots 空间角色）是否拥有在对应 ABS 资源上执行该操作的权限。
    2.  如果直接依赖 ABS 自身的权限校验（即 Bots 后端使用能代表用户权限的 Token 调用 ABS），则 ABS API 会返回权限错误。Bots 后端需要捕获这些错误并转化为对用户的友好提示。
    3.  **推荐方案:** Bots 后端在调用 ABS 前进行一次预校验（基于已知的映射关系和用户角色），如果明显无权限，则直接拒绝并返回错误，避免不必要的 ABS API 调用。最终的权限控制依赖 ABS API 执行时的校验。
*   **Agent 使用工具的权限:** 当 Agent 配置了记忆存储并使用数据库工具时，其对指定记忆库（ABS 表）的读写权限应在 Agent 配置时或运行时基于 Agent 创建者/所有者的空间角色进行隐式授予（仅限于操作其配置的记忆库）。Agent 不应能随意操作空间内的其他数据库或数据表，除非被明确授权。
*   **`SQL自定义节点` 的权限:** 执行自定义 SQL 时，其权限范围同样受限于执行用户/Agent 在目标数据库（ABS 应用）及其下数据表的映射权限。例如，查看者只能执行 `SELECT` 语句。平台需防止通过 SQL 注入等方式进行越权操作。

## 7. 非功能性需求 (Non-Functional Requirements)

*   **性能 (Performance):**
    *   数据库模块 UI 加载速度应在可接受范围内（< 3秒）。
    *   工作流指令的执行耗时应主要取决于 ABS API 响应时间和网络延迟。简单操作（如 Add/Get 单条记录）应在数百毫秒内完成。
    *   `SQL自定义节点` 的性能取决于 SQL 本身和目标数据库。
*   **可扩展性 (Scalability):**
    *   Bots 平台应能支持管理大量空间及其对应的 ABS 空间。
    *   单个空间下支持创建合理数量的数据库（ABS 应用）和数据表（取决于 ABS 自身限制）。
*   **可靠性 (Reliability):**
    *   与 ABS API 的交互应有健壮的错误处理和重试机制（针对网络抖动等）。
    *   指令执行失败时，应返回清晰的错误码和信息。
    *   空间映射关系应持久可靠。
*   **安全性 (Security):**
    *   与 ABS API 的通信需使用 HTTPS。
    *   用于调用 ABS API 的 `token` 需安全存储和管理，避免泄露。
    *   严格执行权限校验，防止越权操作。
    *   `SQL自定义节点` 必须强制使用参数化查询防止 SQL 注入。
*   **易用性 (Usability):**
    *   数据库模块的 UI 应简洁直观，易于理解和操作。
    *   工作流指令的配置应清晰明了。
    *   Agent 记忆的配置和使用应有良好的文档和示例指导。

## 8. 设计注意事项 (Design Considerations)

### 8.1 UI/UX 设计

*   **无缝集成:** 数据库模块的界面风格、交互模式应与 Bots 平台整体保持一致。
*   **概念清晰:** 在 UI 上明确展示 Bots 概念（数据库、数据表）与 ABS 概念（应用/Base、表格）的对应关系，帮助用户理解。
*   **操作引导:** 对于创建数据库/表等操作，提供清晰的指引和必要的输入校验。
*   **简化与抽象:** 隐藏底层 ABS 的复杂性，例如用户不需要关心 ABS 的具体 API 调用细节和认证流程。
*   **反馈及时:** 所有操作（创建、删除、指令执行）都应有明确的成功或失败反馈。
*   **高级操作入口:** 提供方便的入口跳转到 ABS 平台进行高级设置和数据管理。

### 8.2 技术架构

*   **API 封装层:** 建议在 Bots 后端增加一个 ABS Service/Adapter 层，封装对 ABS API 的调用，处理认证、错误映射、上下文注入等逻辑。
*   **空间映射存储:** 需要设计数据库表或配置来存储 Bots Space ID 和 ABS Workspace ID 的映射关系。
*   **认证机制:** 确定 Bots 后端如何获取和管理用于调用 ABS API 的有效凭证（`token`）。可能是基于用户登录态转换，或使用平台级的服务账号。
*   **指令执行器:** 工作流引擎需要集成新的数据库指令执行逻辑。
*   **Agent Runtime:** Agent 运行时需要能够访问其配置的记忆库信息 (`base_id`, `table_id`) 和授权的数据库工具。

### 8.3 UI/UX 交互流程示例

本章节将详细描述数据库模块中几个核心功能的 UI/UX 交互流程，以确保用户体验的流畅性和易用性。(*注：以下描述为纯文本，实际 PRD 中建议辅以简单的线框图或流程图。*)

**7.3.1 创建新的 Bots 数据库 (ABS 应用/Base)**

*   **触发点/入口:**
    1.  用户在 Bots 平台主导航中点击 "数据库" 入口，进入数据库管理页面。
    2.  在数据库管理页面（显示当前空间下数据库列表），点击 "新建数据库" 按钮。
*   **交互流程:**
    1.  **弹出模态框/表单:**
        *   **标题:** "创建新数据库"
        *   **输入字段:**
            *   **数据库名称 (必填):** 文本输入框。
                *   **提示/占位符:** "例如：客户订单库、产品反馈中心"
                *   **校验规则:**
                    *   不能为空。
                    *   长度限制（例如：2-50 个字符）。
                    *   字符限制（例如：允许中英文、数字、下划线、连字符，不允许特殊符号）。
                    *   **实时校验 (可选):** 输入时提示名称在当前 Bots 空间内是否已存在（调用后端接口检查对应 ABS 空间下是否有同名应用）。
            *   **数据库描述 (可选):** 文本区域输入框。
                *   **提示/占位符:** "简要描述此数据库的用途"
                *   **长度限制 (可选):** 例如，最多 200 字符。
        *   **操作按钮:**
            *   "创建" (或 "确定") - 主操作按钮，蓝色。
            *   "取消" - 次要操作按钮，灰色。
    2.  **用户操作与系统反馈:**
        *   用户填写表单信息。
        *   **点击 "创建":**
            *   **前端校验:** 首先进行前端输入格式校验。不通过则在对应字段下方显示错误提示（例如，红色文字）。
            *   **提交请求:** 前端校验通过后，向后端发送创建请求 (调用 ABS API 创建新应用)。按钮变为加载状态 (e.g., "创建中...")。
            *   **成功反馈:**
                *   后端返回成功。
                *   模态框关闭。
                *   页面顶部显示成功提示消息 (例如："数据库 [用户输入的名称] 创建成功！")，持续几秒后自动消失。
                *   数据库列表**自动刷新**，新创建的数据库出现在列表中，并可能有高亮或动画提示。
            *   **失败反馈:**
                *   后端返回失败（例如，名称冲突、权限不足、ABS API 错误等）。
                *   按钮恢复可点击状态。
                *   模态框内或顶部显示具体的错误提示消息 (例如："创建失败：数据库名称 '[用户输入的名称]' 已存在。" 或 "创建失败：内部服务器错误，请稍后重试。")。
        *   **点击 "取消":**
            *   模态框直接关闭，无其他操作。
*   **异常处理考虑:**
    *   网络请求超时或失败时的用户提示。
    *   ABS 服务不可用时的提示。

**7.3.2 创建新的数据表 (ABS 表格)**

*   **触发点/入口:**
    1.  用户在数据库管理页面，点击进入某个已存在的 "数据库" 的详情页（即显示该数据库下数据表列表的页面）。
    2.  在该数据库的详情页，点击 "新建数据表" 按钮。
*   **交互流程:**
    1.  **弹出模态框/表单:**
        *   **标题:** "在 [数据库名称] 中创建新数据表"
        *   **输入字段:**
            *   **数据表名称 (必填):** 文本输入框。
                *   **提示/占位符:** "例如：订单详情、用户反馈、报名信息"
                *   **校验规则:** 类似数据库名称，但在当前选定数据库（ABS 应用）内唯一。
            *   **数据表描述 (可选):** 文本区域输入框。
            *   **(V1.0 简化)** **字段定义:** V1.0 可能仅创建空表或带默认系统字段（如 `ID`, `创建时间`, `更新时间`）。若允许用户在此时定义简单字段：
                *   可提供一个动态增减的区域让用户添加字段，每个字段包含：字段名、字段类型（文本、数字、日期、布尔等简单类型下拉选择）。
                *   或者，V1.0 直接提示"数据表创建后，请前往 ABS 平台定义详细字段结构"。
        *   **操作按钮:** "创建", "取消"。
    2.  **用户操作与系统反馈:**
        *   类似创建数据库的流程：前端校验 -> 提交请求 (调用 ABS API 在指定应用下创建表格) -> 成功/失败反馈 -> 数据表列表刷新。
        *   成功创建后，可以考虑是否直接导航到该数据表的（可能是空的或基础的）视图，或停留在数据表列表页。
*   **跳转 ABS 提示:**
    *   在创建成功后，或在数据表列表的操作项中，明确提示用户"如需定义复杂字段、视图或管理数据，请 [跳转到 ABS 高级管理]"。

**7.3.3 Agent 配置长期记忆存储**

*   **触发点/入口:**
    1.  用户在 Bots 平台编辑或创建一个智能体 (Agent)。
    2.  在 Agent 配置界面的 "高级设置" 或专门的 "记忆" 区域。
*   **交互流程:**
    1.  **记忆配置区域:**
        *   **启用开关/复选框:** "启用长期记忆" (默认为关闭)。
        *   **当启用后，显示以下配置项:**
            *   **记忆存储类型 (V1.0 固定):** 显示 "ABS 数据库" (不可更改或仅此选项)。
            *   **选择数据库 (下拉列表):**
                *   动态加载当前 Bots 空间下所有已创建的 "Bots 数据库" (ABS 应用) 列表。
                *   用户选择一个数据库。
                *   旁边可有 "新建数据库" 快捷按钮，点击后弹出 7.3.1 中的创建数据库模态框。
            *   **选择数据表 (下拉列表):**
                *   当用户选择了数据库后，此下拉列表动态加载所选数据库下的所有数据表。
                *   用户选择一个数据表。
                *   旁边可有 "新建数据表" 快捷按钮，点击后弹出 7.3.2 中的创建数据表模态框（上下文已确定为所选数据库）。
            *   **(可选) 提示/建议:**
                *   "建议使用包含特定字段（如 `session_id`, `query`, `response`, `timestamp`）的数据表作为记忆库。查看推荐表结构示例 [链接]。"
    2.  **用户操作与系统反馈:**
        *   用户勾选 "启用长期记忆"。
        *   用户依次选择数据库和数据表。
        *   **保存 Agent 配置:** 当用户保存整个 Agent 的配置时，这些记忆相关的设置（`base_id`, `table_id`)随之一同保存。
        *   **工具自动授权提示 (可选):** 保存后，可提示用户 "已为此 Agent 自动授权数据库操作工具，您可以在 Prompt 中引导 Agent 使用它们进行记忆存储。"
*   **错误/引导:**
    *   如果当前空间没有任何数据库，"选择数据库" 下拉框为空，应提示用户 "请先创建数据库"。
    *   如果所选数据库没有任何数据表，"选择数据表" 下拉框为空，应提示用户 "请先在此数据库下创建数据表"。
    *   如果用户选择的表结构不符合推荐（如果平台有此校验能力），可以给出弱提示。

## 9. 未来考虑与开放问题 (Future Considerations & Open Questions)

*   **更精细的权限模型:** 未来是否支持在 Bots 平台内进行更细粒度的 ABS 权限配置（如表级、字段级）？
*   **数据浏览与编辑:** 是否需要在 Bots UI 内提供更完善的数据查看和编辑功能？何时提供？
*   **高级表结构管理:** 是否需要在 Bots UI 内支持更多字段类型、视图、关联关系的配置？
*   **跨空间数据库共享/引用:** 是否允许工作流或 Agent 访问其他空间的数据库？如何控制权限？
*   **ABS 空间创建失败处理:** 如果自动创建 ABS 空间失败（如 ABS 配额满、权限问题），应如何向用户反馈并处理？
*   **与 NocoDB 版本的兼容性:** 明确支持的 ABS (NocoDB) 版本范围。
*   **向量数据库与 RAG:** 如何集成 ABS（如果支持）或外部向量数据库，以支持 Agent 的语义记忆检索？

## 10. 成功指标 (Success Metrics)

*   **功能采用率:** 创建的数据库 (Base) 数量、数据表数量、配置了记忆存储的 Agent 比例。
*   **指令使用频率:** 各数据库指令在工作流中的调用次数。
*   **任务成功率:** 使用了数据库指令的工作流和 Agent 的任务执行成功率。
*   **用户反馈:** 通过问卷、访谈收集开发者对数据库模块易用性、功能满足度和稳定性的评价。
*   **支持工单:** 与数据库功能相关的咨询和报障工单数量变化。

### 7.4 错误处理与用户反馈机制 (V1.0)

系统需要提供清晰、一致且有用的错误处理和用户反馈机制，覆盖从 UI 交互到后端 API 调用，再到工作流指令执行和 Agent 记忆集成的各个环节。

#### 7.4.1 通用原则

1.  **一致性 (Consistency):** 错误消息的格式、展示位置和反馈类型（如提示框、通知）应在整个数据库模块中保持一致。
2.  **清晰性 (Clarity):** 错误消息应使用用户易于理解的语言，避免显示原始的、未经处理的 API 错误码或堆栈跟踪信息给最终用户。应明确指出问题所在以及可能的原因。
3.  **及时性 (Timeliness):** 对于耗时操作，应提供即时的进度反馈（如加载指示器）。操作完成后，无论成功或失败，都应立即给出反馈。
4.  **引导性 (Guidance):** 在可能的情况下，错误消息应提供解决问题的建议或引导用户进行下一步操作（例如，"请检查您的网络连接"，"该名称已存在，请尝试其他名称"）。
5.  **非阻塞性 (Non-Blocking):** 对于非关键错误，应尽量避免使用模态对话框中断用户流程，优先使用非侵入式的通知（如 Toast 消息）。关键错误（如权限不足导致无法加载核心数据）可能需要更强的提示。
6.  **日志记录 (Logging):** 所有重要的后端错误和服务间调用失败都应被详细记录，便于排查问题和监控系统状态。用户界面上的错误也应有适当的前端日志。

#### 7.4.2 UI 层面反馈

1.  **加载状态 (Loading States):**
    *   **场景:** 加载数据库列表、数据表列表、表记录、执行创建/更新/删除操作时。
    *   **反馈:**
        *   列表加载：使用骨架屏 (Skeleton Screens) 或局部加载指示器 (Spinners)。
        *   操作执行：按钮显示加载状态 (如按钮内嵌 Spinner，按钮禁用)，或全局/局部加载遮罩。
2.  **成功反馈 (Success Feedback):**
    *   **场景:** 创建数据库/数据表成功、保存配置成功、添加/编辑/删除记录成功。
    *   **反馈:**
        *   通常使用非侵入式的 Toast 通知（例如，"数据库'营销活动'创建成功"）。
        *   对于关键操作或用户期待明确确认的场景，可以有更明显的成功提示。
        *   列表自动刷新以显示最新状态。
3.  **错误反馈 (Error Feedback):**
    *   **输入验证错误:**
        *   **场景:** 用户在表单中输入不符合规范的内容（如名称为空、名称包含非法字符、字段类型选择不当）。
        *   **反馈:** 在对应输入框下方或旁边显示红色错误提示文本。提交按钮在表单验证通过前保持禁用或点击后提示。
    *   **操作失败错误:**
        *   **场景:** 调用 ABS API 失败（如网络问题、ABS 服务内部错误、权限不足、资源冲突如名称重复）。
        *   **反馈:**
            *   **非关键操作:** 使用 Toast 通知或页面顶部横幅提示错误信息（例如，"无法加载数据表，请稍后重试"）。
            *   **关键操作 (如创建数据库失败):** 可以在模态框内提示错误，并提供"重试"或"关闭"选项。
            *   明确指出错误原因，如"数据库名称已存在"、"无权执行此操作"。
    *   **权限不足错误:**
        *   **场景:** 用户尝试执行其角色不允许的操作（如"查看者"尝试编辑数据）。
        *   **反馈:** 禁用相关操作按钮/菜单项，并给出提示。如果用户尝试通过非常规途径触发，则明确提示"权限不足"。
4.  **空状态 (Empty States):**
    *   **场景:** Bots 空间下没有任何数据库、数据库下没有任何数据表、数据表内没有任何记录。
    *   **反馈:** 在列表区域显示友好的提示信息和引导操作，例如："当前空间还没有数据库，立即[创建第一个数据库]？"或"此表暂无数据，尝试[添加第一条记录]？"。

#### 7.4.3 工作流指令执行反馈

1.  **指令执行状态:**
    *   每个数据库相关的指令节点在执行后，都应在其输出参数中明确包含执行结果状态（如 `success: true/false`）。
2.  **错误信息传递:**
    *   若指令执行失败（例如，ABS API 调用失败、参数校验失败），应在输出参数中提供详细的 `errorMessage` 字段。
    *   `errorMessage` 应包含可供工作流开发者判断和处理的错误类型或代码（可选），以及对用户友好的错误描述。
    *   例如："添加记录失败：目标数据表不存在 (ID: table-xyz)" 或 "获取记录失败：查询语法错误"。
3.  **超时处理:**
    *   对 ABS API 的调用应设置合理的超时时间。超时后，指令应视为执行失败，并返回相应的错误信息。
4.  **调试信息:**
    *   在工作流的调试/日志模式下，可以输出更详细的指令执行信息和从 ABS 返回的原始错误（如果安全的话），帮助开发者排查问题。

#### 7.4.4 Agent 长期记忆集成反馈

1.  **配置阶段:**
    *   **成功:** 保存记忆库配置成功后，给出 Toast 提示。
    *   **失败:**
        *   选择的数据库/数据表不存在或无法访问：在选择组件旁提示错误。
        *   保存配置失败（如网络问题）：给出 Toast 提示。
2.  **Agent 运行时:**
    *   当 Agent 尝试调用数据库工具（隐式或显式）进行记忆操作时：
        *   **成功:** 操作对用户通常是透明的，除非 Agent 的回复内容体现了记忆的成功存取。
        *   **失败 (例如，配置的表已被删除、Agent 权限变更导致无法访问):**
            *   Agent 内部应能捕获此类错误。
            *   Agent 的回复应能优雅地处理此问题，例如："抱歉，我现在无法访问我的记忆库，请稍后再试或联系管理员检查我的配置。"
            *   系统应记录此类错误，便于管理员排查。
    *   **无效工具调用:** 如果 Agent 尝试以错误的方式使用数据库工具（如提供了错误的参数格式），工具本身应能返回错误，Agent 应能处理。

#### 7.4.5 常见错误场景与处理建议

| 错误场景                               | 可能原因                                                              | 用户反馈建议 (UI/Agent)                                                                 | 后端/系统处理                                                                                             |
| :------------------------------------- | :-------------------------------------------------------------------- | :-------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------- |
| **ABS 服务不可达/超时**                  | 网络问题、ABS 服务故障、防火墙配置                                        | UI: "无法连接到数据库服务，请检查您的网络或稍后重试。" Agent: "抱歉，我现在无法连接到记忆存储。"             | 指令/API调用层面：实现重试机制（对某些幂等操作），记录错误，返回明确的错误状态。                                   |
| **权限不足 (F-PERM-01, F-PERM-02)**   | 用户 Bots 空间角色权限不足，ABS 端权限未正确同步或配置错误                 | UI: "您没有权限执行此操作。" / 禁用相关功能。 Agent: "抱歉，我没有权限访问或修改这些信息。"                 | 严格执行权限校验。UI 层根据权限动态展示/禁用功能。API 层在每次操作前校验权限。记录权限相关的错误日志。            |
| **资源不存在 (Not Found)**              | 尝试访问的数据库/数据表/记录已被删除或ID错误                               | UI: "目标资源未找到，可能已被删除或ID不正确。"                                                     | API 返回清晰的 404 或自定义错误码。工作流指令返回 `success: false` 及错误信息。                               |
| **名称/标识符冲突 (Conflict)**          | 创建数据库/数据表时名称已存在                                               | UI: "名称 '{name}' 已被使用，请选择其他名称。"                                                     | API 返回冲突错误码 (如 409)。                                                                             |
| **输入参数无效 (Bad Request)**          | API 请求参数不符合规范，工作流指令参数错误，用户输入数据格式错误                | UI: 表单内联提示，或 "请求参数错误，请检查您的输入。"                                                 | API 层进行严格的参数校验，返回详细的错误字段和原因。工作流指令校验输入参数。                                |
| **ABS 内部错误 (Internal Server Error)** | ABS 服务自身发生未预期的错误                                              | UI: "数据库服务发生内部错误，请稍后重试或联系技术支持。" Agent: "抱歉，记忆存储服务暂时出现问题。"         | 捕获 ABS 返回的 5xx 类错误，向用户显示通用错误信息，详细记录错误细节（包括请求ID）以便排查。                       |
| **资源限制 (如存储 quota)**           | （如果 ABS 有此类限制）用户空间/数据库的存储已达上限                         | UI: "操作失败，已达到存储上限。"                                                              | 根据 ABS 的反馈，提示用户。                                                                                |

### 7.5 与现有 ABS 用户的兼容性与数据接入策略 (V1.0)

本节探讨如何允许已经直接使用 ABS (如 NocoDB、Baserow) 的用户将其现有的数据资源接入到 Bots 平台中，以便在 Bots 空间内进行管理和使用。

#### 7.5.1 目标与原则

1.  **目标:**
    *   为已拥有 ABS 工作空间的用户提供一种将其现有数据和结构平滑接入 Bots 平台的方式。
    *   使用户能够在 Bots 平台内利用其已有的 ABS 数据，通过工作流指令和 Agent 长期记忆功能进行交互。
2.  **核心原则:**
    *   **优先"接入/链接"而非"迁移":** 尽可能通过建立 Bots 空间与现有 ABS 工作空间的链接关系来整合，避免复杂的数据复制和迁移过程。
    *   **Bots 平台主导管理:** 一旦现有 ABS 工作空间被接入某个 Bots 空间，其在该 Bots 空间上下文中的权限和访问应主要通过 Bots 平台进行管理，以确保一致性和安全性。
    *   **数据完整性与安全:** 在接入过程中，必须确保现有数据的完整性和安全性，明确权限变更的潜在影响。
    *   **清晰的用户指引:** 用户应清楚了解接入流程、权限如何工作以及对其现有 ABS 工作空间管理方式的潜在影响。

#### 7.5.2 现有 ABS 资源的识别与授权

1.  **用户授权机制:**
    *   用户需要一种方式授权 Bots 平台访问其已有的 ABS 实例/账户。
    *   这可能通过要求用户提供其 ABS 实例的 API 密钥或特定的访问令牌来实现。
    *   如果 ABS 支持 OAuth2 等协议，应优先考虑使用更安全的授权流程。
2.  **资源发现:**
    *   授权成功后，Bots 平台应能列出用户在指定 ABS 实例中拥有或有权管理的现有 ABS 工作空间 (Workspaces/Bases)。
    *   用户界面需要清晰展示这些可供选择的现有资源。
3.  **权限验证:**
    *   在允许用户链接一个现有 ABS 工作空间之前，系统需要确认发起链接操作的用户对该 ABS 工作空间拥有足够的管理权限（例如，所有者或管理员级别），以避免未经授权的接入。

#### 7.5.3 数据接入流程 (推荐 V1.0 方案: 链接现有 ABS 工作空间)

对于 V1.0，主要支持将一个**完整**的、用户已有的 ABS 工作空间链接到一个 Bots 空间。

**场景1: 为新的 Bots 空间链接现有 ABS 工作空间**

*   在创建 Bots 空间时，或首次在该空间内访问数据库模块时，除了"创建新的 ABS 工作空间"选项外，提供"链接现有的 ABS 工作空间"选项。
*   **流程:**
    1.  用户选择"链接现有"。
    2.  系统引导用户完成对其 ABS 实例的授权（见 7.5.2）。
    3.  系统列出用户可选的、尚未被其他 Bots 空间管理的 ABS 工作空间。
    4.  用户选择一个希望链接的 ABS 工作空间。
    5.  Bots 平台在其中央映射表（`BotsSpaceID` <-> `ABSWorkspaceID`）中记录此链接关系。
    6.  **权限同步:**
        *   Bots 平台将尝试根据当前 Bots 空间的标准角色权限模型（见 `5.5.1`）在被链接的 ABS 工作空间上设置或同步相应的权限。
        *   **重要提示:** 必须向用户明确说明，为了确保 Bots 平台内管理的一致性，Bots 平台的角色权限将主导通过 Bots 平台访问该 ABS 工作空间时的行为。预先存在于 ABS 工作空间内部直接设置的、与 Bots 空间成员相关的权限可能会被覆盖或调整。
        *   建议提供预览或确认步骤，告知用户权限变更的细节。

**场景2: 为已存在的 Bots 空间 (尚无数据库) 链接现有 ABS 工作空间**

*   如果一个 Bots 空间已存在但尚未使用数据库模块（即没有关联的 ABS 工作空间），用户可以在数据库模块的入口界面选择链接现有 ABS 工作空间。
*   流程与场景1类似。

#### 7.5.4 链接后的权限管理

1.  **Bots 平台主导:**
    *   一旦一个 ABS 工作空间被成功链接到一个 Bots 空间，针对该 Bots 空间成员的访问权限，应由 Bots 平台的角色（所有者、管理员、编辑者、查看者等）来决定。
    *   Bots 平台将负责将这些角色映射到对应的 ABS 工作空间、Base 和 Table 的权限上。
2.  **处理预先存在的直接 ABS 权限:**
    *   对于那些**同时也是 Bots 空间成员**的用户，他们在被链接的 ABS 工作空间中直接拥有的、与 Bots 平台角色不一致的旧权限，在通过 Bots 平台访问时，应以 Bots 平台的权限为准。
    *   对于那些**并非 Bots 空间成员**但仍通过 ABS 直接访问该（可能共享的）ABS 工作空间的用户，他们的直接权限理论上不受影响，但这增加了管理复杂性。平台应推荐用户通过 Bots 空间成员身份来管理协作。
    *   **用户沟通:** 必须清晰地告知用户，为了集成和管理的一致性，建议通过 Bots 平台管理所有与该空间相关的用户对所链接 ABS 资源的访问。

#### 7.5.5 关于"数据迁移"的说明 (V1.0 及以后)

1.  **V1.0 范围:**
    *   V1.0 的核心是实现现有 ABS 工作空间的"**链接与管理接入**"，而不是物理上的数据表或记录的"迁移"。这意味着数据仍然存储在用户原有的 ABS 实例中，Bots 平台通过 API 与其交互。
2.  **未来的数据迁移可能性:**
    *   **表级迁移/复制:** 未来可以考虑支持将某个（或某些）数据表从一个 ABS Base 复制到另一个（由 Bots 管理的）ABS Base。
    *   **导入/导出:** 允许用户通过 Bots 界面，利用 ABS 本身可能具备的导入/导出功能（如 CSV 导入/导出）来迁移数据到 Bots 管理的表中。
    *   这些功能将作为后续版本的增强功能进行规划，因为它们涉及更复杂的数据处理和校验逻辑。

#### 7.5.6 注意事项与 V1.0 限制

1.  **接入粒度:** V1.0 专注于链接整个 ABS 工作空间。不支持从多个不同的、未被管理的 ABS 工作空间中挑选个别 Base 或 Table 混搭链接到同一个 Bots 空间。
2.  **避免双重管理混乱:** 强烈建议用户在将一个 ABS 工作空间链接到 Bots 平台后，主要通过 Bots 平台来管理与该空间相关的用户权限和配置。同时在 ABS 端和 Bots 平台端对同一资源进行大幅度的、不协调的管理操作可能会导致冲突和不可预期的行为。
3.  **API 版本兼容性:** 需要确保 Bots 平台与用户 ABS 实例的 API 版本兼容。
4.  **孤立资源的处理:** 如果用户解除了 Bots 空间与 ABS 工作空间的链接，需要明确该 ABS 工作空间在 ABS 端的状态（例如，是否恢复到链接前的权限状态，或保留 Bots 设置的最后状态但不再同步）。这需要进一步定义。对于 V1.0，可能简单地断开链接，不再管理。
