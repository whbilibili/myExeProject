# PRD: Bots 平台数据库模块 (基于 ABS 集成) - V1.0

**版本历史:**

| 版本  | 日期       | 作者     | 变更说明         |
| :---- | :--------- | :------- | :--------------- |
| 1.0   | 2024-XX-XX | Gemini Pro | 初始草案         |

## 1. 概述 (Overview)

### 1.1 背景

当前的 Bots 平台缺乏内置的、用户友好的结构化数据存储和管理能力。开发者在构建需要持久化存储、复杂数据查询或状态管理的工作流和智能体 (Agent) 时，面临诸多不便，往往需要依赖外部数据库或复杂的变量管理。市面上主流的智能体平台（如 Coze, BetterYeah）均提供了集成的数据库功能，允许用户方便地创建、管理数据表，并将其应用于工作流和 Agent 记忆中。

我们拥有一个基于 NocoDB 二次开发的成熟平台 ABS，它提供了强大的多维表格（类数据库）能力，包含空间、应用（Base）、表格等层级。

### 1.2 目标

本方案旨在将 ABS 的核心能力作为**数据库模块**无缝集成到 Bots 平台中，为开发者提供强大、易用且原生的数据存储与管理功能。具体目标包括：

*   为 Bots 工作流提供可靠的结构化数据存储和读写能力。
*   为 Bots 智能体 (Agent) 提供可配置的、基于 ABS 的长期记忆存储机制。
*   在 Bots 平台内提供统一的界面来创建和管理这些“数据库”（ABS 应用）。
*   确保 Bots 空间与 ABS 空间的逻辑关联，实现一致的组织和权限基础。

### 1.3 核心理念

*   **ABS 应用即 Bots 数据库:** 将 ABS 中的“应用 (Base)”概念映射为 Bots 中的“数据库”。每个“数据库”是一个表格的集合。
*   **空间对齐:** Bots 平台的顶层结构“空间”与 ABS 平台的“空间”建立一对一的映射关系。一个 Bots 空间对应一个专属的 ABS 空间，该 Bots 空间下创建的所有“数据库”（ABS 应用）都将位于其对应的 ABS 空间内。
*   **指令驱动交互:** 工作流通过专门设计的数据库指令（已定义）与这些“数据库”进行交互。
*   **记忆工具化:** 智能体 (Agent) 将这些数据库指令作为工具，访问指定的 ABS 表以实现长期记忆。

## 2. 目标用户 (Target Users)

*   **工作流开发者/设计者:** 需要在自动化流程中存储、查询、更新结构化数据的人员。
*   **智能体 (Agent) 创建者/开发者:** 需要为 Agent 构建长期记忆、知识库或需要 Agent 操作结构化数据的场景。
*   **Bots 平台管理员:** 需要管理平台数据存储资源和权限的人员。
*   **最终用户 (间接):** 与使用了数据库功能的工作流或 Agent 交互的用户，将体验到更智能、更连贯、功能更强大的服务。

## 3. 范围 (Scope)

### 3.1 V1.0 范围内 (In Scope)

*   **空间映射机制:** 建立 Bots 空间与 ABS 空间的关联机制（具体实现待定，可能是按需创建或后台同步）。
*   **数据库模块 UI:** 在 Bots 平台内提供一个专门的“数据库”导航入口和管理界面。
*   **创建数据库 (ABS 应用):** 用户可以在 Bots UI 内，在当前空间下创建新的“数据库”（对应在关联的 ABS 空间下创建 Base/应用）。输入字段包括数据库名称、描述。
*   **查看数据库列表:** 在数据库模块 UI 中展示当前 Bots 空间下的所有“数据库”（ABS 应用）列表。
*   **创建数据表 (ABS 表格):** 用户可以在选定的“数据库”下创建新的数据表。输入字段包括表名、描述（V1.0 可能仅支持创建空表或带默认字段）。
*   **查看数据表列表:** 在选定的“数据库”详情页展示其下的数据表列表。
*   **工作流指令集成:** 实现已定义的数据库相关指令：
    *   `新建数据库` (CreateDatabase / ABS 应用)
    *   `新建数据表` (CreateTable)
    *   `连接数据表` (ConnectDataTable)
    *   `添加记录` (AddRecord)
    *   `获取记录` (GetRecords)
    *   `编辑记录` (UpdateRecord)
    *   `删除记录` (DeleteRecord)
    *   `SQL自定义节点` (ExecuteCustomSQL, V1.0 限制于操作当前 Base)
*   **Agent 长期记忆配置:** 允许在 Agent 配置中指定一个 ABS 数据库 (Base) 和数据表 (Table) 作为其长期记忆存储。
*   **Agent 工具授权:** 自动为配置了记忆存储的 Agent 授权使用上述数据库指令（操作其指定的记忆库）。
*   **基础权限映射:** 实现基于 Bots 空间角色的基础权限映射。例如，Bots 空间管理员默认拥有对应 ABS 空间的管理权限（包括创建/删除应用/数据库），空间成员拥有读写权限（需细化）。

### 3.2 V1.0 范围外 (Out of Scope)

*   **复杂的数据库/表结构管理:** 在 Bots UI 内进行复杂的字段添加/编辑/删除、视图创建/管理、关系设置等高级 ABS 功能（用户如有需要可引导至 ABS 平台操作）。
*   **在 Bots UI 内直接浏览和编辑数据记录:** V1.0 重点在于创建、管理元数据以及提供给工作流/Agent 的接口。数据浏览/编辑可能需要跳转到 ABS 或后续版本迭代。
*   **跨 Bots 空间访问数据库:** V1.0 的数据库操作限制在当前空间对应的 ABS 空间内。
*   **精细化的表/字段/行级权限控制:** V1.0 依赖于基于空间角色的粗粒度权限映射。
*   **数据库备份、恢复、迁移等运维功能:** 这些仍依赖于 ABS 平台自身。
*   **实时数据同步/推送机制:** (除非 ABS/NocoDB 天然支持并通过 API 暴露)。

## 4. 核心概念与映射 (Core Concepts & Mapping)

| Bots 平台概念          | ABS 平台概念           | 说明                                       |
| :--------------------- | :--------------------- | :----------------------------------------- |
| Bots 空间 (Space)      | ABS 空间 (Workspace)   | 顶层组织单元，建立一对一关联。             |
| **Bots 数据库 (Database)** | **ABS 应用 (Base)**    | **核心映射**。Bots 中管理和引用的数据库实例。 |
| Bots 数据表 (Table)    | ABS 表格 (Table)       | 数据库 (Base) 内的数据存储单元。           |
| Bots 记录 (Record)     | ABS 记录 (Row)         | 数据表中的一行数据。                       |
| Bots 字段 (Field)      | ABS 列 (Column/Field)  | 数据表中的一列定义。                       |
| Bots 数据库模块 (UI)   | N/A (Bots 平台界面)  | Bots 内用于管理“数据库”(ABS Bases) 的界面。 |

## 5. 功能需求 (Functional Requirements)

### 5.1 空间与数据库管理 (UI & Backend)

| ID      | 模块         | 需求描述                                                                                                | 优先级 | 备注                                                                                                                                 |
| :------ | :----------- | :------------------------------------------------------------------------------------------------------ | :----- | :----------------------------------------------------------------------------------------------------------------------------------- |
| F-DB-01 | 空间关联     | 当用户首次访问 Bots 空间的数据库模块时，系统应检查并确保存在一个对应的 ABS 空间。如果不存在，应自动创建或引导创建。 | 高     | 实现细节需讨论：是首次访问惰性创建？还是创建 Bots 空间时同步创建？需处理创建失败情况。                                                          |
| F-DB-02 | 数据库模块 UI | 在 Bots 主导航中增加“数据库”入口。点击后进入数据库管理页面，默认展示当前空间下的数据库列表。                           | 高     |                                                                                                                                      |
| F-DB-03 | 数据库列表   | 数据库管理页面以列表或卡片形式展示当前空间下的所有数据库（ABS 应用）。应显示数据库名称、描述、创建时间、创建者（可选）等。      | 高     | 需要调用 ABS API 获取当前 ABS 空间下的应用列表。                                                                                       |
| F-DB-04 | 创建数据库   | 提供“新建数据库”按钮。点击后弹出表单，用户输入数据库名称（必填，需校验唯一性和规则）、描述（可选）。提交后调用 ABS API 创建新应用。 | 高     | 对应 `新建数据库` 指令的核心功能。需处理命名冲突、权限不足等错误。成功后列表应刷新。                                                             |
| F-DB-05 | 查看数据库   | 点击数据库列表中的条目，可以进入该数据库的详情页（或直接展示其下的数据表列表）。                                        | 高     |                                                                                                                                      |
| F-DB-06 | 删除数据库   | （V1.0 可选）在数据库列表或详情页提供“删除”操作。需有二次确认，明确告知删除的风险（数据将丢失，关联的工作流/Agent 可能失败）。 | 中     | 需要谨慎处理：删除 ABS 应用是高危操作。需检查依赖关系？软删除？                                                                              |
| F-DB-07 | 数据库搜索/过滤 | （V1.0 可选）提供基于数据库名称的搜索或过滤功能。                                                                | 低     | 如果数据库数量不多，V1.0 可省略。                                                                                                  |

### 5.2 数据表管理 (UI & Backend)

| ID      | 模块     | 需求描述                                                                                                  | 优先级 | 备注                                                                       |
| :------ | :------- | :-------------------------------------------------------------------------------------------------------- | :----- | :------------------------------------------------------------------------- |
| F-TBL-01 | 数据表列表 | 在数据库详情页中，展示该数据库（ABS 应用）下的所有数据表列表。应显示表名、描述（可选）、记录数（可选）等。                     | 高     | 需要调用 ABS API 获取指定 Base 下的表格列表。                                |
| F-TBL-02 | 创建数据表 | 在数据库详情页提供“新建数据表”按钮。点击后弹出表单，用户输入表名（必填，需校验应用内唯一性和规则）、描述（可选）。提交后调用 ABS API 创建新表格。 | 高     | 对应 `新建数据表` 指令的核心功能。V1.0 创建空表或带基础系统字段（如 ID）。 |
| F-TBL-03 | 删除数据表 | （V1.0 可选）在数据表列表提供“删除”操作。需二次确认。                                                          | 中     | 同删除数据库，需谨慎。                                                       |
| F-TBL-04 | 跳转至 ABS | （V1.0 推荐）在数据库或数据表层面，提供一个明显的链接或按钮，可以跳转到对应的 ABS 平台界面进行高级操作（如编辑表结构、管理视图、浏览数据等）。 | 高     | 避免在 Bots 中重复造轮子，引导用户到功能更全的 ABS 进行高级管理。            |

### 5.3 工作流指令集成

| ID      | 模块   | 需求描述                                                                     | 优先级 | 备注                                     |
| :------ | :----- | :--------------------------------------------------------------------------- | :----- | :--------------------------------------- |
| F-WF-01 | 指令实现 | 实现 `新建数据库`, `新建数据表`, `连接数据表`, `添加记录`, `获取记录`, `编辑记录`, `删除记录`, `SQL自定义节点` 指令的后端逻辑，使其能够与 ABS API 交互，并在正确的空间和应用/表上下文中执行。 | 高     | 遵循已定义的指令文档规范。                 |
| F-WF-02 | 指令可用 | 在工作流编辑器的节点面板中，提供这些数据库相关的指令供用户选择和使用。             | 高     | 需要规划好指令的分类（例如放在“数据库”或“存储”类别下）。 |
| F-WF-03 | 上下文注入 | 工作流运行时，系统需要自动为这些指令注入正确的 `token` 和 `workspaceID`。      | 高     | 核心机制，确保安全和正确执行。             |

### 5.4 Agent 长期记忆集成

| ID      | 模块     | 需求描述                                                                                             | 优先级 | 备注                       |
| :------ | :------- | :--------------------------------------------------------------------------------------------------- | :----- | :------------------------- |
| F-MEM-01 | 配置界面 | 在 Agent 配置界面，增加“长期记忆存储”设置项，允许用户选择一个当前空间下的 ABS 数据库 (Base) 和数据表 (Table) 作为记忆库。 | 高     | 存储 `base_id` 和 `table_id`。 |
| F-MEM-02 | 工具授权 | 当 Agent 配置了记忆存储后，自动为其添加可用的数据库操作指令（`AddRecord`, `GetRecords` 等）作为其可用工具。       | 高     |                            |
| F-MEM-03 | Prompt指导 | 提供默认的或推荐的 System Prompt 模板片段，指导 Agent 如何使用数据库工具进行记忆的存、取、改、查。                 | 高     | 结合推荐的记忆表结构。       |
| F-MEM-04 | 执行上下文 | Agent 调用数据库工具时，系统需确保操作目标是其配置的记忆库，并使用正确的凭证和上下文。                               | 高     |                            |

### 5.5 权限管理

| ID      | 模块   | 需求描述                                                                                                                               | 优先级 | 备注                                                                               |
| :------ | :----- | :------------------------------------------------------------------------------------------------------------------------------------- | :----- | :--------------------------------------------------------------------------------- |
| F-PERM-01 | 基础映射 | 实现基于 Bots 空间角色的权限映射。例如：<br>- Bots 空间管理员 -> 对应 ABS 空间管理员权限 (可创建/删除 Base)<br>- Bots 空间成员 -> 对应 ABS 空间成员权限 (可创建表、读写记录，需细化) | 高     | V1.0 的简化模型。需要与 ABS 权限体系对接。                                           |
| F-PERM-02 | 指令校验 | 每个数据库指令执行前，需校验调用者（工作流触发者或 Agent 所用凭证）是否具有执行该操作所需的（映射后的）ABS 权限。                                         | 高     | 例如，`AddRecord` 需要校验是否有对应表的写入权限。                                     |

## 6. 非功能性需求 (Non-Functional Requirements)

*   **性能 (Performance):**
    *   数据库模块 UI 加载速度应在可接受范围内（< 3秒）。
    *   工作流指令的执行耗时应主要取决于 ABS API 响应时间和网络延迟。简单操作（如 Add/Get 单条记录）应在数百毫秒内完成。
    *   `SQL自定义节点` 的性能取决于 SQL 本身和目标数据库。
*   **可扩展性 (Scalability):**
    *   Bots 平台应能支持管理大量空间及其对应的 ABS 空间。
    *   单个空间下支持创建合理数量的数据库（ABS 应用）和数据表（取决于 ABS 自身限制）。
*   **可靠性 (Reliability):**
    *   与 ABS API 的交互应有健壮的错误处理和重试机制（针对网络抖动等）。
    *   指令执行失败时，应返回清晰的错误码和信息。
    *   空间映射关系应持久可靠。
*   **安全性 (Security):**
    *   与 ABS API 的通信需使用 HTTPS。
    *   用于调用 ABS API 的 `token` 需安全存储和管理，避免泄露。
    *   严格执行权限校验，防止越权操作。
    *   `SQL自定义节点` 必须强制使用参数化查询防止 SQL 注入。
*   **易用性 (Usability):**
    *   数据库模块的 UI 应简洁直观，易于理解和操作。
    *   工作流指令的配置应清晰明了。
    *   Agent 记忆的配置和使用应有良好的文档和示例指导。

## 7. 设计注意事项 (Design Considerations)

### 7.1 UI/UX 设计

*   **无缝集成:** 数据库模块的界面风格、交互模式应与 Bots 平台整体保持一致。
*   **概念清晰:** 在 UI 上明确展示 Bots 概念（数据库、数据表）与 ABS 概念（应用/Base、表格）的对应关系，帮助用户理解。
*   **操作引导:** 对于创建数据库/表等操作，提供清晰的指引和必要的输入校验。
*   **简化与抽象:** 隐藏底层 ABS 的复杂性，例如用户不需要关心 ABS 的具体 API 调用细节和认证流程。
*   **反馈及时:** 所有操作（创建、删除、指令执行）都应有明确的成功或失败反馈。
*   **高级操作入口:** 提供方便的入口跳转到 ABS 平台进行高级设置和数据管理。

### 7.2 技术架构

*   **API 封装层:** 建议在 Bots 后端增加一个 ABS Service/Adapter 层，封装对 ABS API 的调用，处理认证、错误映射、上下文注入等逻辑。
*   **空间映射存储:** 需要设计数据库表或配置来存储 Bots Space ID 和 ABS Workspace ID 的映射关系。
*   **认证机制:** 确定 Bots 后端如何获取和管理用于调用 ABS API 的有效凭证（`token`）。可能是基于用户登录态转换，或使用平台级的服务账号。
*   **指令执行器:** 工作流引擎需要集成新的数据库指令执行逻辑。
*   **Agent Runtime:** Agent 运行时需要能够访问其配置的记忆库信息 (`base_id`, `table_id`) 和授权的数据库工具。

## 8. 未来考虑与开放问题 (Future Considerations & Open Questions)

*   **更精细的权限模型:** 未来是否支持在 Bots 平台内进行更细粒度的 ABS 权限配置（如表级、字段级）？
*   **数据浏览与编辑:** 是否需要在 Bots UI 内提供更完善的数据查看和编辑功能？何时提供？
*   **高级表结构管理:** 是否需要在 Bots UI 内支持更多字段类型、视图、关联关系的配置？
*   **跨空间数据库共享/引用:** 是否允许工作流或 Agent 访问其他空间的数据库？如何控制权限？
*   **ABS 空间创建失败处理:** 如果自动创建 ABS 空间失败（如 ABS 配额满、权限问题），应如何向用户反馈并处理？
*   **与 NocoDB 版本的兼容性:** 明确支持的 ABS (NocoDB) 版本范围。
*   **向量数据库与 RAG:** 如何集成 ABS（如果支持）或外部向量数据库，以支持 Agent 的语义记忆检索？

## 9. 成功指标 (Success Metrics)

*   **功能采用率:** 创建的数据库 (Base) 数量、数据表数量、配置了记忆存储的 Agent 比例。
*   **指令使用频率:** 各数据库指令在工作流中的调用次数。
*   **任务成功率:** 使用了数据库指令的工作流和 Agent 的任务执行成功率。
*   **用户反馈:** 通过问卷、访谈收集开发者对数据库模块易用性、功能满足度和稳定性的评价。
*   **支持工单:** 与数据库功能相关的咨询和报障工单数量变化。
