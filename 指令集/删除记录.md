# 【设计中】官方指令 - 删除记录 - V1.0.0

## 指令名称

DeleteRecord / 删除记录

## 功能描述

从指定的 ABS 数据表（由 `base_id` 和 `table_id` 标识）中，根据设定的筛选条件删除符合条件的所有记录。支持多条件组合筛选,可用于批量数据清理。

## 使用说明

1. 在工作流画布中添加"删除记录"节点。
2. 配置节点的输入参数，需要提供：
   * **所属数据库 Base ID (`base_id`) (必填):** 目标数据表所在的 ABS 数据库的 ID。
   * **目标数据表 Table ID (`table_id`) (必填):** 要删除记录的数据表的 ID。
   * **筛选条件 (`filter`) (必填):** 用于确定要删除哪些记录的条件对象。包含条件数组和条件组合方式。
3. 将节点的输入连接到前序节点（获取 `base_id`, `table_id` 等）。
4. 执行工作流。
5. 检查节点的输出，确认符合条件的记录是否成功删除。

## 注意事项

* **权限:** 执行此操作需要在目标 ABS 数据表上拥有**删除**记录的权限。
* **不可逆操作:** 删除记录是**不可恢复**的操作。使用筛选条件时要特别谨慎,建议先用相同条件测试查询,确认影响范围。
* **筛选条件验证:** 确保 filter 中指定的字段名存在且类型匹配,操作符使用正确。
* **数据量控制:** 筛选条件可能匹配大量记录,注意控制单次删除的数据量。
* **性能影响:** 复杂的筛选条件可能影响执行效率,建议优化查询条件。
* **批量删除:** 当一次性删除大量记录时,操作可能被拆分为多个批次执行。

## 适用场景

* 批量清理过期或归档的数据记录（例如：删除30天前的已完成任务）。
* 删除满足特定业务条件的记录（例如：清理所有未关联客户的订单）。
* 数据维护时批量删除不合规范的记录（例如：删除所有标题为空的草稿）。

## 入参

| 参数名      | 参数说明                                                     | 是否必填 | 用户是否配置 |
| :---------- | :--------------------------------------------------------- | :------- | :----------- |
| base_id     | 所属 ABS 数据库的 Base ID                                   | 是       | 是           |
| table_id    | 目标 ABS 数据表的 Table ID                                  | 是       | 是           |
| filter      | 删除条件对象,用于筛选要删除的记录                           | 是       | 是           |
| token       | ABS 调用令牌                                                | 是       | 否(系统获取) |
| workspaceID | 对应的 ABS 空间 ID（可能需要用于 API 调用上下文）           | 是       | 否(系统获取) |

**filter 对象结构说明:**
```json
{
  "conditions": [  // 条件数组,支持多个条件
    {
      "field": "状态",      // 字段名
      "operator": "=",      // 操作符
      "value": "已完成"     // 比较值
    },
    {
      "field": "创建时间",
      "operator": "<=",  
      "value": "2024-01-01"
    }
  ],
  "conjunction": "AND"  // 条件组合方式: "AND" 或 "OR"
}
```

**支持的操作符:**
- `=`: 等于
- `!=`: 不等于
- `>`: 大于
- `>=`: 大于等于
- `<`: 小于
- `<=`: 小于等于
- `CONTAINS`: 包含
- `NOT_CONTAINS`: 不包含
- `IS_EMPTY`: 为空
- `IS_NOT_EMPTY`: 不为空

**请求体示例:**
```json
{
  "base_id": "base_xyz789",
  "table_id": "tbl_abc123",
  "filter": {
    "conditions": [
      {
        "field": "状态",
        "operator": "=",
        "value": "已归档"
      },
      {
        "field": "更新时间",
        "operator": "<=",
        "value": "2023-12-31"
      }
    ],
    "conjunction": "AND"
  }
}
```

## 出参

| 参数名         | 参数说明                                                   |
| :------------- | :-------------------------------------------------------- |
| success        | 布尔值,指示删除操作是否成功执行                            |
| matched_count  | 匹配筛选条件的记录总数                                     |
| deleted_count  | 实际成功删除的记录数                                       |
| errors         | (可选) 删除过程中遇到的错误信息                            |
| filter_error   | (可选) 筛选条件相关的错误信息                              |
| message        | 操作结果的总体消息                                         |
| error_code     | (如果 success 为 false) 错误代码                          |

**响应体示例 (成功):**
```json
{
  "success": true,
  "matched_count": 5,
  "deleted_count": 5,
  "errors": [],
  "message": "Successfully deleted 5 records."
}
```

**响应体示例 (部分成功):**
```json
{
  "success": true,
  "matched_count": 3,
  "deleted_count": 2,
  "errors": [
    {
      "record_id": "rec_xyz999",
      "error_code": "DB005",
      "message": "Permission denied for this record."
    }
  ],
  "message": "Partially succeeded: 2 out of 3 matched records deleted."
}
```

**响应体示例 (筛选条件错误):**
```json
{
  "success": false,
  "matched_count": 0,
  "deleted_count": 0,
  "filter_error": {
    "field": "状态A",
    "message": "字段不存在",
    "error_code": "DB034"
  },
  "message": "Invalid filter condition: Field '状态A' does not exist."
}
```

## XML 语法

```xml
<DeleteRecord baseId="{{base_id}}" tableId="{{table_id}}">
  <Filter>
    <Conditions>
      <Condition>
        <Field>状态</Field>
        <Operator>=</Operator>
        <Value>已归档</Value>
      </Condition>
      <Condition>
        <Field>更新时间</Field>
        <Operator><=</Operator>
        <Value>2023-12-31</Value>
      </Condition>
    </Conditions>
    <Conjunction>AND</Conjunction>
  </Filter>
</DeleteRecord>
```

## Groovy 语法

```groovy
def filter = [
  conditions: [
    [field: '状态', operator: '=', value: '已归档'],
    [field: '更新时间', operator: '<=', value: '2023-12-31']
  ],
  conjunction: 'AND'
]

def deleteResult = engine.execute('DeleteRecord', [
  base_id: workflow.getVariable('target_base_id'),
  table_id: workflow.getVariable('target_table_id'),
  filter: filter
])

if (deleteResult.success) {
  println("匹配记录数: ${deleteResult.output.matched_count}")
  println("成功删除: ${deleteResult.output.deleted_count} 条记录")
  if (deleteResult.output.errors) {
    println("部分记录删除失败:")
    deleteResult.output.errors.each { err -> 
      println(" - ${err.message}")
    }
  }
} else {
  if (deleteResult.output.filter_error) {
    println("筛选条件错误: ${deleteResult.output.filter_error.message}")
  } else {
    println("删除失败: ${deleteResult.error.message}")
  }
}
```

## 使用案例

1. **清理过期数据:**
```json
{
  "filter": {
    "conditions": [
      {
        "field": "状态",
        "operator": "=",
        "value": "已完成"
      },
      {
        "field": "完成时间",
        "operator": "<=",
        "value": "2023-06-30"
      }
    ],
    "conjunction": "AND"
  }
}
```

2. **删除无效记录:**
```json
{
  "filter": {
    "conditions": [
      {
        "field": "标题",
        "operator": "IS_EMPTY"
      },
      {
        "field": "创建时间",
        "operator": "<=",
        "value": "2023-12-31"
      }
    ],
    "conjunction": "AND"
  }
}
```

## 分类与标签

数据库, Database, 数据表, Table, ABS, 删除, Delete, Remove, Record, Data Management, CRU**D** (Delete), 批量删除, 条件删除

## 错误码与异常说明

| 错误码 | 说明                     | 处理建议                                                     |
| :----- | :----------------------- | :----------------------------------------------------------- |
| DB000  | 未知错误                 | 查看工作流执行日志，联系平台管理员                           |
| DB002  | 身份验证失败             | 检查系统配置的 ABS Token 是否有效                            |
| DB005  | 权限不足                 | 确认执行权限                                                 |
| DB008  | 数据库不存在或无权访问    | 检查 base_id 是否正确                                       |
| DB010  | 数据表未找到             | 检查 table_id 是否正确                                      |
| DB034  | 筛选条件字段不存在       | 检查字段名是否正确                                           |
| DB035  | 筛选条件操作符不支持     | 检查操作符是否在支持范围内                                   |
| DB036  | 筛选条件值类型不匹配     | 检查值的类型是否与字段类型匹配                               |

## 权限与安全要求

* **需要登录:** 是
* **涉及敏感操作:** 是。批量删除数据是高风险操作
* **具体权限:** 需要对目标表有删除权限
* **数据安全:** 建议在执行前确认筛选条件的影响范围

## 依赖关系与前置条件

* **数据库和数据表:** 必须存在且可访问
* **有效凭证:** 系统必须有删除权限的有效 Token
* **筛选条件:** 必须指定有效的筛选条件
* **字段存在:** filter 中引用的字段必须在表中存在
