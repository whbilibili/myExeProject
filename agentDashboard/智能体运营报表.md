好的，我已经将 `文档/智能体运营报表.md` 的内容整理成了更易读的 Markdown 格式。

# 智能体消耗分析仪表盘 - PRD V1.0

- **版本**: V1.0
- **作者**: 
- **最后更新**: 2025-11-14
- **状态**: 需求评审

## 1. 核心目的

评估每个智能体的成本、使用情况、性能和投资回报率（ROI），找出高成本、高价值和低效的智能体。

## 2. 全局筛选

- **时间 (Date Range)**: 必须支持自定义时间范围，并提供快捷选项：今天, 最近7天, 最近一个月, 最近180天, 最近一年。
- **租户 (Tenant)**: 必须支持多选或不选（即查看所有租户）。

## 3. 快捷导航

页面顶部应有锚点链接（Anchor Links），允许用户点击后平滑滚动到相应区域：
`[关键指标]` `[Top10趋势]` `[成本使用分析]` `[群体分布]` `[详细数据表]`

## 4. 📈 智能体关键指标 (Agent Key KPIs)

- **位置**： 页面最上方。
- **描述**： 一系列突出的“数字卡片”，显示选定时间范围内的全体智能体的聚合数据。

### 活跃智能体总数 (Active Agents)
- **定义**：在选定时间内，至少产生过1轮对话的智能体总数。
- **目的**： 正在产生价值或成本的“活跃资产”，而不是那些创建了但从未被使用过的“沉没资产”。

### 智能体总花费 (Total Agent Cost)
- **定义**： 所有智能体消耗的 Token 总成本 (￥)。
- **目的**： 了解智能体这一资源类型的总体成本。

### 智能体总Token消耗 (Total Token Cost)
- **定义**： 所有智能体的 Token 总消耗。
- **目的**： 了解智能体这一资源类型的token消耗。

### 智能体总对话轮次 (Total Agent Calls)
- **定义**： 所有智能体被调用的总次数，即智能体的总对话轮次（一问一答为一次）。
- **目的**： 了解智能体的总体使用频率。

### 平均每轮对话成本 (Avg. Cost per Call)
- **公式**： `智能体总花费 / 智能体总对话轮次`。
- **目的**： 衡量智能体调用的平均成本效率。

### 平均每轮对话Token消耗 (Avg. Tokens per Call)
- **公式**： `智能体总Token消耗 / 智能体总对话轮次`。
- **目的**： 衡量智能体调用的平均复杂度（“啰嗦”程度）。

### 平台平均调用成功率 (Platform Avg. Success Rate)
- **定义**： 选定时间内，所有智能体调用的`总成功次数 / 总对话轮次`。
- **理由**： 这让管理层对平台的整体稳定性有一个宏观体感，与`平均每次调用成本`共同构成“成本-质量”的顶层视角。

### 成本最高的智能体 (Most Expensive Agent)
- **定义**： （显示名称）花费最多的智能体。
- **目的**： 立即高亮最大的成本来源。

### 调用最频繁的智能体 (Most Used Agent)
- **定义**： （显示名称）对话轮次最多的智能体。
- **目的**： 立即高亮最受欢迎的智能体。

## 5. 📊 核心图表：智能体成本与使用分析

**交互设计**: 顶部提供 Tabs 切换器： `[Token 消耗] | [费用消耗] | [对话轮次]`

### 图表 1: 智能体Token消耗 Top10 & 趋势分析
- **类型**： 堆叠面积图 (Stacked Area Chart) + 明细表。
- **主图 (堆叠面积图)**:
    - **目的**： 展示消耗头部智能体的消耗趋势及其内部构成。使用堆叠面积图以避免10条折线交叉导致的“意大利面条图”问题。
    - **X轴**： 时间 (根据全局筛选器自动选择日/周/月粒度)。
    - **Y轴**： Token消耗。
    - **图例 (Series)**： 选定时间范围内，Token总消耗排名前10的智能体 + 其他所有 (Others)。
- **附表 (明细表)**:
    - **列**： 排行, 智能体名称, 总Token消耗，最高消耗，平均消耗， 创建人。

### 图表 2: 智能体费用消耗 Top10 & 趋势分析
- **类型**： 堆叠面积图 (Stacked Area Chart) + 明细表。
- **主图 (堆叠面积图)**:
    - **目的**： 展示费用头部智能体的消耗趋势及其内部构成。
    - **X轴**： 时间。
    - **Y轴**： 费用消耗 (￥)。
    - **图例 (Series)**： 选定时间范围内，费用总消耗排名前10的智能体 + 其他所有 (Others)。
- **附表 (明细表)**:
    - **列**： 排行, 智能体名称, 总费用消耗 (￥), 最高消耗，平均消耗，创建人。

### 图表 3: 智能体对话轮次 Top10 & 趋势分析
- **类型**： 堆叠面积图 (Stacked Area Chart) + 明细表。
- **主图 (堆叠面积图)**:
    - **目的**： 展示调用头部智能体的活跃趋势及其内部构成。
    - **X轴**： 时间。
    - **Y轴**： 对话轮次。
    - **图例 (Series)**： 选定时间范围内，总对话轮次排名前10的智能体 + 其他所有 (Others)。
- **附表 (明细表)**:
    - **列**： 排行, 智能体名称, 总对话轮次, 最高对话轮次，平均对话轮次，创建人。

### 图表 4：智能体成本 vs. 使用情况（四象限分析图）
- **核心目的**： 评估每个智能体的成本效率与使用价值，快速识别出四类关键智能体。
- **类型**： 气泡图 (Bubble Chart)

#### 数据维度 (Data Mapping)

| 视觉元素 | 数据指标 | 坐标轴/属性设置 | 业务含义 |
| :--- | :--- | :--- | :--- |
| **X 轴** | 总对话轮次 (Total Calls) | 对数坐标 (Log Scale) | 使用广度。使用 Log 轴是为了防止头部效应导致 99% 的点挤在左下角。<br>**容错逻辑**：渲染图表前，必须清洗数据。若值为 0 或 null，强制赋一个极小值（如 0.1）或直接剔除，确保图表不崩溃。 |
| **Y 轴** | 平均单轮对话成本 (Avg. Cost/Call) | 对数坐标 (Log Scale) | 使用成本。衡量智能体的“贵”与“便宜”。<br>**容错逻辑**：同上。 |
| **气泡大小 (Size)** | 活跃用户数 (Active Users) | 线性映射 (Linear) | 受众规模 / 财务影响。气泡越大，影响面越广或越烧钱。 |
| **气泡颜色 (Color)** | 智能体分类 (由象限决定) | 离散色 | 质量/风险。一眼识别“又贵又坏”的毒药应用。 |

#### 象限判定逻辑
- 使用 `>=` (大于等于) 逻辑，归入“高”区。
- **气泡颜色**: 映射“象限分类”。
    - 后端（或前端）计算 **「对话轮次中位数」** 和 **「平均成本中位数」**。
    - 为每个数据点（智能体）添加分类标签 `quadrant_type`。
    - `quadrant_type` 的值为：`"高轮次高消耗"`, `"高轮次低消耗"`, `"低轮次高消耗"`, `"低轮次低消耗"`。
    - 使用 ECharts `visualMap` 的 `piecewise` 或 `categories` 功能，将这四个分类映射到四种固定颜色（例如：红色, 绿色, 橙色, 灰色）。

#### 核心功能：动态四象限分析线
- **垂直中位数线 (Y-Axis Median)**:
    - **定义**: 在Y轴上，绘制一条虚线，其位置为当前视图中所有智能体`平均每轮对话成本`的**中位数**。
    - **标签**: `成本中位数`
- **水平中位数线 (X-Axis Median)**:
    - **定义**: 在X轴上，绘制一条虚线，其位置为当前视图中所有智能体`对话轮次`的**中位数**。
    - **标签**: `轮次中位数`
- **要求**: 这两条线的位置必须根据全局筛选器（时间和租户）的结果动态重新计算。
- **(V1.1 预留能力)**: 后端需支持未来扩展“固定阈值”分割。

#### 图例 (Legend)
- 图例应显示四种象限分类：`"高轮次高消耗"` (红), `"高轮次低消耗"` (绿), `"低轮次高消耗"` (橙), `"低轮次低消耗"` (灰)。

#### 交互设计 (Interaction)
- **Hover (悬停)**:
    - 必须在气泡上显示一个丰富的 Tooltip (信息提示框)，清晰列出：
    `智能体名称`, `智能体ID`, `创建者`, `象限分类`, `总对话轮次`, `平均每轮对话成本`, `活跃用户数`, `总费用消耗`。
- **Click (点击)**: 遵循全局“交叉高亮” (Cross-Highlighting) 规范。

#### 技术与交互要求
- **技术要求**： 必须使用 Canvas 渲染（如 ECharts），确保上千个数据点下依然高性能。
- **交互要求**： 必须支持鼠标滚轮缩放 (Zoom)，以便用户放大查看密集的区域（如左下角）。

#### 气泡类型解读 (Analysis Quadrants)
- **高调用, 高成本: “明星但昂贵”**
    - **特征**： 使用广泛，但单次成本高于中位数。
    - **运营行动**： 重点优化对象。联系创建者，看是否能用更便宜的模型、或优化Prompt来降低平均每次调用成本。
- **高调用, 低成本： “明星且高效”**
    - **特征**： 平台的“价值之星” (ROI之王)。使用广泛，且成本效率极高。
    - **运营行动**： 全公司表彰。总结其设计模式，作为最佳实践（Best Practice）推广。
- **低调用, 高成本： “问题/小众智能体”**
    - **特征**： 用的人很少，但用一次极其昂贵。
    - **运营行动**： 重点排查对象。检查活跃用户数（气泡大小），如果用户很多，说明是“小众但重要”的高价值工具。如果用户很少，立即联系创建者，确认是否为“测试中”或“已废弃”的智能体，避免成本浪费。
- **低调用, 低成本: “长尾智能体”**
    - **特征**： 大量的、低成本、低使用的智能体。
    - **运营行动**： 暂时忽略。它们是平台的“毛细血管”，符合预期。

#### 侧栏设计：洞察与行动 (Sidebar: Insights & Actions)
- **位置**：图表右侧 (Flex布局，固定宽度 320px)。
- **交互逻辑**：分为「全局概览」和「个体诊断」两种状态。

##### 状态 A：全局概览 (Default State)
- **触发条件**：未点击任何气泡，或点击了图表空白处。
- **核心基准 (Benchmark)**:
    - 展示当前视角的划分标准，帮助用户理解为何某些点是红色/绿色。
    - **成本中位数**: ¥0.45 /轮 (高于此为昂贵)
    - **热度中位数**: 128 轮 (高于此为热门)
- **象限分布与一键筛选 (Distribution)**:
    - **🔴 重点优化 (High Cost)**
        - **Stats**: 5个 (占比 2%) - Avg Cost: ¥1.2
        - **Action**: `[查看列表]` (点击后仅高亮红色气泡)
        - **Insight**: "这些应用消耗了总预算的 45%，是降本的首要目标。"
    - **🟢 明星应用 (Best ROI)**
        - **Stats**: 12个 (占比 8%)
        - **Action**: `[查看列表]`
        - **Insight**: "高频低价，建议分析其 Prompt 模式进行推广。"
    - **🟠 需排查 (Check)**
        - **Stats**: 8个 (占比 5%)
        - **Insight**: "低频但极贵，请确认是否为废弃的测试应用。"

##### 状态 B：个体诊断 (Selected State)
- **触发条件**：点击了某个气泡。
- **身份卡片 (Identity)**:
    - **标题**: 智能体名称 (支持跳转详情页)
    - **标签**: 🔴 重点优化 (动态计算)
    - **归属**: 创建者 / 部门
- **智能诊断 (Auto-Diagnosis)**:
    - *此部分基于前端现有数据进行简单的逻辑判断，无需复杂后端。*
    - **逻辑规则库 (Dev Logic)**:
        - **判断模型**:
            - **Rule**: If `model` includes `'gpt-4'` or `'opus'`
            - **Show**: "⚠️ 昂贵模型预警: 当前使用 GPT-4，建议测试是否可用 GPT-4o-mini 替代，预计可节省 90%。"
        - **判断输入输出比**:
            - **Rule**: If `input_tokens / output_tokens > 10`
            - **Show**: "📝 Prompt 过长: 输入Token占比过高。建议开启 Context Caching 或精简提示词。"
        - **判断成功率**:
            - **Rule**: If `success_rate < 90%`
            - **Show**: "❌ 稳定性差: 失败率达 10%以上，重试机制可能导致了隐形成本浪费。"

### 图表 5：智能体核心指标分布 (直方图)
- **核心目的**： 快速了解平台所有智能体在关键指标上的整体分布形态。用于回答：“大部分智能体的成本/用量是怎样的？我们是否存在严重的‘长尾’或‘头部集中’效应？”
- **类型**： 直方图 (Histogram)
- **设计**:
    - **指标切换器**： 使用下拉菜单或Tabs，允许用户选择查看以下任一指标的分布：
        - 智能体费用消耗 (默认)
        - 智能体Token消耗
        - 智能体对话轮次
        - 智能体用户数
    - **X轴 (X-Axis)**: 选定指标的数据区间。**要求**：必须使用动态分桶 (Dynamic Binning) 逻辑，不能写死组距。
    - **Y轴 (Y-Axis)**: 智能体数量 (个) (即“频数”)。
    - **交互**： Hover柱状时，显示该区间的具体范围和智能体数量。（例如：“费用区间: 0-10元, 智能体数量: 850个”）

## 6. 📋 智能体详细数据表 (Agent Detail Table)

- **描述**： 这是仪表盘的主体。一个可排序、可筛选的表格，列出所有智能体的详细指标（受全局筛选器影响）。

### 关键指标（列）

#### (A) 标识信息
- 智能体名称 (Agent Name)
- 智能体 ID (Agent ID)
- 创建者 (Owner): 成本归属和问题定位到人。
- 所属租户 (Owner's Department): 成本归属到租户。
- 创建日期 (Created Date)
- 智能体类型 (Agent Type)： 分类字段：“官方创建”、“用户创建”。
- 智能体状态 (Agent Status)：分类字段：“已发布”、“草稿”、“已归档/已下线”。
- 最后更新时间 (Last Updated): 智能体配置的最后更新时间。
- 最后运行时间 (Last Used Date)：该智能体最后一次被调用的时间戳。

#### (B) 成本指标 (Cost Metrics)
- **总花费 (￥) (Total Cost)**: [默认按此列降序排]
- 总 Token 消耗 (Total Tokens)
- 输入 Token (Prompt Tokens)
- 输出 Token (Completion Tokens)
- 输入/输出 Token 比
- 成本占比 (Cost %): `该智能体的总花费 / 所有智能体的总花费`

#### (C) 使用指标 (Usage Metrics)
- 总对话轮次 (Total Calls): [可排序]，一问一答为一个轮次。
- 活跃用户数 (Active Users): 有多少个不同的人调用了它。
- 人均对话轮次 (Calls per User): `总对话轮次 / 活跃用户数`。
- 总会话数 (Total Sessions): 总的会话次数（例如，用户开启新对话的次数）。
- 平均每会话对话轮次 (Calls per Session): `总对话轮次 / 总会话数`。(衡量对话深度或粘性)

#### (D) 效率与性能 (Efficiency & Performance)
- 平均每次调用成本 (￥) (Avg. Cost per Call): [可排序]
- 平均每次调用 Token (Avg. Tokens per Call): (如果此数值过高，说明 Prompt 或响应过长)
- 调用成功率 (%) (Success Rate): [可排序，升序]。
    - **失败定义**： 所有非业务成功（非HTTP 200或有明确error flag）的调用。
- 平均响应时间 (ms) (Avg. Latency): (响应太慢会影响用户体验)

#### (E) 关键归因 (Attribution)
- 花费最多模型 (Primary Model Used): 成本贡献最大的模型 (例如：GPT-4)。
- 花费最多工作流 (Linked Workflows): (可选) 成本贡献最大的关联工作流。

### 表格功能要求

- **搜索框**: 按智能体名称/ID 搜索。
- **默认列顺序 (Default View)**:
    - 为了最佳的开箱体验，默认显示的列顺序应为：
    `智能体名称`, `总花费 (￥)` [默认排序], `总对话轮次`, `平均每次调用成本 (￥)`, `调用成功率 (%)`, `创建者`, `智能体类型`, `智能体状态`, `花费最多模型`, `最后运行时间`。
- **自定义列 (Custom Columns)**:
    - 必须在表格右上角提供一个“自定义列”按钮。
    - 允许用户通过勾选/取消勾选来显示/隐藏所有可用字段（A-E）。
    - 允许用户拖拽排序自定义的列顺序。
    - （可选V1.5）允许用户“保存视图”。
- **🆕 导出 (Export)**:
    - **按钮位置**: 表格右上角，显著位置。
    - **功能**: 点击下载 `.xlsx` 或 `.csv` 文件。
    - **导出内容**: 导出 **当前筛选条件下** 的所有全量数据（不仅仅是当前分页数据），包含所有可见及隐藏列。
    - **文件名格式**: `Agent_Analysis_{StartTime}_{EndTime}.xlsx`。

## 7. 🚀 运营行动建议 (Actionable Insights)

此部分为仪表盘的“使用指南”，可作为帮助文档内容。

### 识别成本黑洞
1.  在【详细数据表】中，按 **总花费 (￥)** 降序排序。
2.  查看前 5 名。看它们的 **花费最多模型** 列。如果都是 GPT-4，再看 **平均每次调用成本**。
3.  **行动**： 找到这些智能体的 **创建者**，讨论是否有必要使用昂贵模型，或能否优化 Prompt。

### 发现“坏”智能体
1.  在【详细数据表】中，按 **调用成功率 (%)** 升序排序。
2.  查看所有成功率低于 90% 的智能体。
3.  **行动**： 联系 **创建者** 修复这些有问题的智能体，它们在浪费对话轮次（可能也在花钱）并导致用户体验下降。

### 找到明星应用
1.  在【四象限图】中，寻找“明星应用”（高调用, 低成本）。
2.  **行动**： 总结这些应用的共同点，并在公司内部分享最佳实践。

### 定位潜在滥用
1.  在【详细数据表】中，按 **人均对话轮次** 降序排序。
2.  如果某个智能体的 **活跃用户数** 很少（比如1-2个），但 **人均对话轮次** 极高。
3.  **行动**： 这可能是一个自动化脚本在刷量。联系 **创建者** 确认其行为是否符合预期。

## 8. 🎮 交互设计 (Interaction Design)

### 8.1 交叉高亮 (Cross-Highlighting)
- **目的**： 允许用户查看“个体在群体中的位置”，这是分析的核心。
- **规则**： 禁止使用“点击图表元素过滤整个页面”的交互。应使用“高亮”代替。
- **示例**：
    - 当用户在【详细数据表】中点击（或Hover）“智能体A”这一行时：
        - 【四象限图】中，“智能体A”对应的气泡应高亮（例如发光、描边）。
        - 【Top10 趋势图】中，“智能体A”对应的面积图区域应高亮。
        - 【箱线图】中，如果“智能体A”是一个异常值，那个“点”应高亮。

### 8.2 钻取 (Drill-Down)
- **目的**： 查看单个智能体的详细信息。
- **规则**： 当用户在任何图表或表格中点击一个智能体名称时（例如，在详细数据表的第一列），应触发“钻取”。
- **实现**： 打开一个新页面（或全屏模态框），该页面是“智能体详情页”，展示该智能体自己的KPI、趋势、调用日志、以及按人员分析的详细数据。