<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºèƒ½ä½“æ¶ˆè€—åˆ†æä»ªè¡¨ç›˜</title>
  <link rel="stylesheet" href="./css/style.css">
  <!-- å¼•å…¥ ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <!-- å¼•å…¥ Vue 3 -->
  <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
  <!-- å¼•å…¥ Element Plus (å¯é€‰ï¼Œè¿™é‡Œä¸ºäº†è½»é‡åŒ–æˆ‘ä»¬å°½é‡æ‰‹å†™æˆ–ç”¨ç®€å•çš„ç»„ä»¶ï¼Œä½†ä¸ºäº†è¡¨æ ¼æ–¹ä¾¿å¦‚æœå…è®¸å¯ä»¥å¼•å…¥) -->
  <!-- è¿™é‡Œæˆ‘ä»¬çº¯æ‰‹å†™ç®€å•æ ·å¼ï¼Œä¸ä¾èµ–é‡å‹UIåº“ä»¥ä¿æŒè½»é‡å’Œå¯æ§ -->
</head>
<body>
  <div id="app" v-cloak>
    
    <!-- 1. é¡¶éƒ¨å¯¼èˆªä¸ç­›é€‰ -->
    <header class="app-header">
      <div class="header-left">
        <h1>æ™ºèƒ½ä½“æ¶ˆè€—åˆ†æ</h1>
        <span class="tag">PRD V1.0</span>
      </div>
      <div class="header-right">
        <div class="filter-group">
          <label>æ—¶é—´èŒƒå›´:</label>
          <select v-model="filters.timeRange" @change="handleFilterChange">
            <option value="today">ä»Šå¤©</option>
            <option value="7days">æœ€è¿‘7å¤©</option>
            <option value="30days">æœ€è¿‘30å¤©</option>
            <option value="180days">æœ€è¿‘180å¤©</option>
          </select>
        </div>
        <div class="filter-group">
          <label>ç§Ÿæˆ·:</label>
          <select v-model="filters.department" @change="handleFilterChange">
            <option value="all">å…¨éƒ¨ç§Ÿæˆ·</option>
            <option v-for="dept in departments" :value="dept">{{ dept }}</option>
          </select>
        </div>
      </div>
    </header>

    <!-- å¿«æ·é”šç‚¹ -->
    <nav class="anchor-nav">
      <a href="#kpi">å…³é”®æŒ‡æ ‡</a>
      <a href="#top10">Top10è¶‹åŠ¿</a>
      <a href="#quadrant">æˆæœ¬ä½¿ç”¨åˆ†æ</a>
      <a href="#distribution">ç¾¤ä½“åˆ†å¸ƒ</a>
      <a href="#detail">è¯¦ç»†æ•°æ®è¡¨</a>
    </nav>

    <!-- 2. KPI å…³é”®æŒ‡æ ‡ -->
    <section id="kpi" class="section kpi-section">
      <div class="kpi-card" v-for="kpi in kpiData" :key="kpi.label">
        <div class="kpi-label">{{ kpi.label }}</div>
        <div class="kpi-value" :class="{ 'highlight': kpi.highlight }">{{ kpi.value }}</div>
        <div class="kpi-sub" v-if="kpi.sub">{{ kpi.sub }}</div>
      </div>
    </section>

    <!-- 3. Top 10 è¶‹åŠ¿ -->
    <section id="top10" class="section">
      <div class="section-header">
        <h2>Top 10 è¶‹åŠ¿åˆ†æ</h2>
        <div class="tabs">
          <button :class="{ active: top10Tab === 'totalTokens' }" @click="top10Tab = 'totalTokens'">Tokenæ¶ˆè€—</button>
          <button :class="{ active: top10Tab === 'totalCost' }" @click="top10Tab = 'totalCost'">è´¹ç”¨æ¶ˆè€—</button>
          <button :class="{ active: top10Tab === 'callCount' }" @click="top10Tab = 'callCount'">å¯¹è¯è½®æ¬¡</button>
        </div>
      </div>
      <div class="chart-container-wrapper">
        <div id="chart-top10" class="chart-box"></div>
        <div class="top10-table">
          <table>
            <thead>
              <tr>
                <th>æ’å</th>
                <th>æ™ºèƒ½ä½“åç§°</th>
                <th>æ•°å€¼</th>
                <th>åˆ›å»ºäºº</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="(item, index) in top10TableData" :key="item.id" @mouseenter="highlightAgent(item.id)" @mouseleave="clearHighlight">
                <td>{{ index + 1 }}</td>
                <td class="truncate" :title="item.name">{{ item.name }}</td>
                <td>
                  <span v-if="top10Tab === 'totalCost'">{{ formatCurrency(item[top10Tab]) }}</span>
                  <span v-else-if="top10Tab === 'totalTokens'">{{ formatToken(item[top10Tab]) }}</span>
                  <span v-else>{{ formatNumber(item[top10Tab]) }}</span>
                </td>
                <td>{{ item.creator }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 4. æˆæœ¬ vs ä½¿ç”¨ (å››è±¡é™) -->
    <section id="quadrant" class="section">
      <div class="section-header">
        <h2>æ™ºèƒ½ä½“æˆæœ¬ vs ä½¿ç”¨æ•ˆç‡åˆ†æ</h2>
        <div class="controls">
           <label><input type="checkbox" v-model="quadrantConfig.xLog"> Xè½´å¯¹æ•°</label>
           <label><input type="checkbox" v-model="quadrantConfig.yLog"> Yè½´å¯¹æ•°</label>
        </div>
      </div>
      
      <div class="quadrant-layout">
        <!-- å·¦ä¾§å›¾è¡¨ -->
        <div class="quadrant-chart-wrapper">
          <div id="chart-quadrant" class="chart-box large"></div>
        </div>
        
        <!-- å³ä¾§æ™ºèƒ½æ´å¯Ÿä¾§è¾¹æ  -->
        <div class="insights-sidebar" :class="sidebarState">
          
          <!-- çŠ¶æ€ A: å…¨å±€æ¦‚è§ˆ -->
          <div v-if="sidebarState === 'global'" class="sidebar-content">
            <h3>ğŸ” å…¨å±€æ´å¯Ÿ</h3>
            <div class="benchmark-info">
              <p><strong>æˆæœ¬ä¸­ä½æ•°:</strong> {{ formatCurrency(quadrantStats.medianCost) }} /è½®</p>
              <p><strong>è½®æ¬¡ä¸­ä½æ•°:</strong> {{ formatNumber(quadrantStats.medianCalls) }} è½®</p>
            </div>
            
            <div class="quadrant-stat-list">
              <div class="stat-item red">
                <div class="title">ğŸ”´ é‡ç‚¹ä¼˜åŒ– (é«˜è€—é«˜é¢‘)</div>
                <div class="desc">å æ¯” {{ quadrantStats.q1.percent }}% ({{ quadrantStats.q1.count }}ä¸ª), æ¶ˆè€—äº†å¤§é‡é¢„ç®—ã€‚</div>
              </div>
              <div class="stat-item orange">
                <div class="title">ğŸŸ  éœ€æ’æŸ¥ (é«˜è€—ä½é¢‘)</div>
                <div class="desc">å æ¯” {{ quadrantStats.q2.percent }}% ({{ quadrantStats.q2.count }}ä¸ª), å•æ¬¡æˆæœ¬è¿‡é«˜ã€‚</div>
              </div>
              <div class="stat-item green">
                <div class="title">ğŸŸ¢ æ˜æ˜Ÿåº”ç”¨ (ä½è€—é«˜é¢‘)</div>
                <div class="desc">å æ¯” {{ quadrantStats.q4.percent }}% ({{ quadrantStats.q4.count }}ä¸ª), ROI æœ€ä½³ã€‚</div>
              </div>
            </div>
          </div>

          <!-- çŠ¶æ€ B: ä¸ªä½“è¯Šæ–­ -->
          <div v-else class="sidebar-content">
            <div class="sidebar-header">
              <button class="back-btn" @click="clearSelection">â† è¿”å›</button>
              <h3>ä¸ªä½“è¯Šæ–­</h3>
            </div>
            
            <div class="agent-profile" v-if="selectedAgent">
              <div class="agent-name">{{ selectedAgent.name }}</div>
              <div class="agent-meta">
                <span class="badge">{{ selectedAgent.type }}</span>
                <span class="author">by {{ selectedAgent.creator }}</span>
              </div>
            </div>

            <div class="diagnosis-list" v-if="selectedAgentDiagnosis.length > 0">
              <div v-for="(diag, idx) in selectedAgentDiagnosis" :key="idx" class="diagnosis-card" :class="diag.type">
                <div class="diag-icon">{{ diag.icon }}</div>
                <div class="diag-content">
                  <strong>{{ diag.title }}</strong>
                  <p>{{ diag.message }}</p>
                </div>
              </div>
            </div>
            <div v-else class="empty-diagnosis">
              âœ… è¯¥æ™ºèƒ½ä½“å„é¡¹æŒ‡æ ‡æ­£å¸¸
            </div>

            <div class="action-area" v-if="selectedAgent">
               <button class="btn-primary" @click="alert('è·³è½¬åˆ°è¯¦æƒ…é¡µ: ' + selectedAgent.id)">æŸ¥çœ‹è¯¦ç»†æ•°æ®</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 5. ç¾¤ä½“åˆ†å¸ƒ -->
    <section id="distribution" class="section">
       <div class="section-header">
        <h2>æ ¸å¿ƒæŒ‡æ ‡åˆ†å¸ƒ</h2>
        <select v-model="histoMetric">
          <option value="totalCost">è´¹ç”¨æ¶ˆè€—</option>
          <option value="totalTokens">Tokenæ¶ˆè€—</option>
          <option value="callCount">å¯¹è¯è½®æ¬¡</option>
          <option value="userCount">ç”¨æˆ·æ•°</option>
        </select>
      </div>
      <div id="chart-histogram" class="chart-box"></div>
    </section>

    <!-- 6. è¯¦ç»†æ•°æ®è¡¨ -->
    <section id="detail" class="section">
      <div class="section-header">
        <h2>æ™ºèƒ½ä½“è¯¦ç»†æ•°æ®è¡¨</h2>
        <div class="table-actions">
          <input type="text" v-model="searchQuery" placeholder="æœç´¢æ™ºèƒ½ä½“åç§°/ID...">
          <button @click="exportData">å¯¼å‡º CSV</button>
        </div>
      </div>
      <div class="data-table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th @click="sort('name')">æ™ºèƒ½ä½“åç§° <span class="sort-icon">â‡…</span></th>
              <th @click="sort('totalCost')">æ€»èŠ±è´¹ <span class="sort-icon">â‡…</span></th>
              <th @click="sort('callCount')">å¯¹è¯è½®æ¬¡ <span class="sort-icon">â‡…</span></th>
              <th @click="sort('avgCostPerCall')">å¹³å‡æˆæœ¬ <span class="sort-icon">â‡…</span></th>
              <th @click="sort('successRate')">æˆåŠŸç‡ <span class="sort-icon">â‡…</span></th>
              <th @click="sort('creator')">åˆ›å»ºè€… <span class="sort-icon">â‡…</span></th>
              <th @click="sort('status')">çŠ¶æ€ <span class="sort-icon">â‡…</span></th>
              <th>æ¨¡å‹</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="agent in paginatedData" :key="agent.id" 
                :class="{ 'selected': selectedAgent && selectedAgent.id === agent.id }"
                @click="selectAgent(agent)"
                @mouseenter="highlightAgent(agent.id)"
                @mouseleave="clearHighlight">
              <td class="fw-bold">{{ agent.name }}</td>
              <td>{{ formatCurrency(agent.totalCost) }}</td>
              <td>{{ formatNumber(agent.callCount) }}</td>
              <td>{{ formatCurrency(agent.avgCostPerCall) }}</td>
              <td :class="{'text-danger': agent.successRate < 90}">{{ agent.successRate }}%</td>
              <td>{{ agent.creator }}</td>
              <td><span class="status-badge" :class="agent.status === 'å·²å‘å¸ƒ' ? 'success' : 'draft'">{{ agent.status }}</span></td>
              <td>{{ agent.primaryModel }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="pagination">
        <button :disabled="currentPage === 1" @click="currentPage--">ä¸Šä¸€é¡µ</button>
        <span>ç¬¬ {{ currentPage }} / {{ totalPages }} é¡µ</span>
        <button :disabled="currentPage === totalPages" @click="currentPage++">ä¸‹ä¸€é¡µ</button>
      </div>
    </section>

  </div>

  <!-- è„šæœ¬å¼•å…¥ -->
  <script src="./js/utils.js"></script>
  <script src="./js/mock.js"></script>
  <script src="./js/charts.js"></script>
  <script src="./js/app.js"></script>
</body>
</html>

