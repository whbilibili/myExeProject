<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>用户管理 - 用户列表</title>
  
  <!-- Element Plus CSS -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/dist/index.css">
  
  <!-- 自定义CSS -->
  <link rel="stylesheet" href="./assets/css/feishu-design.css">
  
  <style>
    .user-list-page {
      min-height: 100vh;
      background: var(--bg-gray-1);
    }

    .dashboard {
      margin-bottom: var(--space-6);
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-4);
    }

    .filter-section {
      margin-bottom: var(--space-4);
    }

    /* 使用组件默认表格样式，移除全局覆盖 */

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-lg);
      margin-right: var(--space-3);
      border: 1px solid var(--border-1);
    }

    .user-name-cell {
      display: flex;
      align-items: center;
      cursor: pointer;
      color: var(--text-primary);
      font-weight: 500;
      transition: all var(--transition-fast);
      padding: var(--space-2) 0;
    }

    .user-name-cell:hover {
      color: var(--primary-color);
    }

    .user-name-cell:hover .user-avatar {
      transform: scale(1.05);
      box-shadow: var(--shadow-sm);
    }

    .tenants-cell {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      align-items: center;
    }

    .contact-cell {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
    }
    
    .balance-cell {
      cursor: pointer;
      color: var(--primary-color);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--font-size-base);
      transition: all var(--transition-fast);
      padding: var(--space-2);
      border-radius: var(--radius-md);
      margin: calc(-1 * var(--space-2));
    }

    .balance-cell:hover {
      background: var(--bg-primary);
      color: var(--primary-hover);
    }

    .status-cell {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }
    .status-dot.ok { background: var(--success-color); }
    .status-dot.warn { background: var(--warning-color); }

    .mono-id {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: var(--text-secondary);
      font-size: 12px;
      letter-spacing: 0.2px;
    }

    .action-buttons {
      display: flex;
      gap: var(--space-2);
      align-items: center;
    }

    @media (max-width: 1200px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="app" class="user-list-page">
    <!-- 导航栏 -->
    <div class="navbar">
      <div class="navbar-content">
        <div class="navbar-title">
          <el-icon size="24"><el-icon-user /></el-icon>
          <span>用户管理系统</span>
        </div>
        <div>
          <el-tag type="info" size="small">运营后台 V1.1</el-tag>
        </div>
      </div>
    </div>

    <!-- 主内容区 -->
    <div class="main-content">
      <!-- 仪表盘 -->
      <div class="dashboard">
        <div class="dashboard-grid">
          <div class="stat-card">
            <div class="stat-card-header">
              <div class="stat-card-label">
                用户总数
              </div>
              <div class="stat-card-icon primary">
                <el-icon><el-icon-user /></el-icon>
              </div>
            </div>
            <div class="stat-card-value">{{ stats.total }}</div>
            <div class="stat-card-trend">
              平台注册用户总量
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-card-header">
              <div class="stat-card-label">
                正常用户
              </div>
              <div class="stat-card-icon success">
                <el-icon><el-icon-select /></el-icon>
              </div>
            </div>
            <div class="stat-card-value">{{ stats.normal }}</div>
            <div class="stat-card-trend">
              账号状态正常的用户
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-card-header">
              <div class="stat-card-label">
                已禁用用户
              </div>
              <div class="stat-card-icon warning">
                <el-icon><el-icon-close /></el-icon>
              </div>
            </div>
            <div class="stat-card-value">{{ stats.disabled }}</div>
            <div class="stat-card-trend">
              已被管理员禁用的账号
            </div>
          </div>
        </div>
      </div>

      <!-- 筛选器 -->
      <div class="filter-section">
        <div class="filter-bar">
          <div class="filter-row">
            <div class="filter-item" style="flex: 2; min-width: 300px;">
              <label class="filter-item-label">搜索</label>
              <el-input
                v-model="filters.search"
                placeholder="搜索用户名称、用户ID、手机号、邮箱号、MIS号"
                clearable
                size="default"
                @input="handleSearch"
              >
                <template #prefix>
                  <el-icon><el-icon-search /></el-icon>
                </template>
              </el-input>
            </div>

            <div class="filter-item" style="min-width: 160px;">
              <label class="filter-item-label">状态</label>
              <el-select
                v-model="filters.status"
                placeholder="全部"
                style="width: 100%;"
                @change="handleFilter"
              >
                <el-option label="全部" value="全部" />
                <el-option label="正常" value="正常" />
                <el-option label="已禁用" value="已禁用" />
              </el-select>
            </div>

            <div class="filter-item" style="min-width: 200px;">
              <label class="filter-item-label">归属租户</label>
              <el-select
                v-model="filters.tenants"
                placeholder="全部租户"
                multiple
                filterable
                clearable
                collapse-tags
                collapse-tags-tooltip
                style="width: 100%;"
                @change="handleFilter"
              >
                <el-option
                  v-for="tenant in allTenants"
                  :key="tenant.value"
                  :label="tenant.label"
                  :value="tenant.value"
                />
              </el-select>
            </div>

            <div class="filter-item" style="min-width: 280px;">
              <label class="filter-item-label">创建时间</label>
              <el-date-picker
                v-model="filters.dateRange"
                type="daterange"
                range-separator="至"
                start-placeholder="开始日期"
                end-placeholder="结束日期"
                clearable
                style="width: 100%;"
                @change="handleFilter"
              />
            </div>
          </div>
        </div>
      </div>

      <!-- 数据表格 -->
      <div class="table-container">
        <el-table
          :data="tableData"
          style="width: 100%"
          v-loading="loading"
          @sort-change="handleSortChange"
          :default-sort="{ prop: 'createTime', order: 'descending' }"
          stripe
          border
          fit
          table-layout="fixed"
        >
          <el-table-column prop="id" label="用户ID" width="150" show-overflow-tooltip>
            <template #default="{ row }">
              <span class="mono-id">{{ row.id }}</span>
            </template>
          </el-table-column>
          
          <el-table-column label="用户名称" width="200" fixed="left">
            <template #default="{ row }">
              <div class="user-name-cell" @click="viewUserDetail(row.id)">
                <img :src="row.avatar" :alt="row.name" class="user-avatar" />
                <span>{{ row.name }}</span>
              </div>
            </template>
          </el-table-column>

          <el-table-column label="归属租户" width="220">
            <template #default="{ row }">
              <div class="tenants-cell">
                <el-tag
                  v-for="(tenant, index) in row.tenants.slice(0, 2)"
                  :key="tenant.tenantId"
                  size="small"
                  effect="plain"
                >
                  {{ tenant.tenantName }}
                </el-tag>
                <el-tooltip
                  v-if="row.tenants.length > 2"
                  :content="row.tenants.slice(2).map(t => t.tenantName).join('、')"
                  placement="top"
                >
                  <el-tag size="small" effect="plain">
                    +{{ row.tenants.length - 2 }}
                  </el-tag>
                </el-tooltip>
              </div>
            </template>
          </el-table-column>

          <el-table-column label="绑定手机" width="150">
            <template #default="{ row }">
              <div class="contact-cell">
                <span>{{ row.phone }}</span>
                <el-icon
                  class="copy-btn"
                  @click.stop="copyText(row.phone)"
                >
                  <el-icon-document-copy />
                </el-icon>
              </div>
            </template>
          </el-table-column>

          <el-table-column label="绑定邮箱" width="220" show-overflow-tooltip>
            <template #default="{ row }">
              <div class="contact-cell">
                <span>{{ row.email }}</span>
                <el-icon
                  class="copy-btn"
                  @click.stop="copyText(row.email)"
                >
                  <el-icon-document-copy />
                </el-icon>
              </div>
            </template>
          </el-table-column>

          <el-table-column label="绑定MIS" width="130">
            <template #default="{ row }">
              <div class="contact-cell" v-if="row.mis">
                <span>{{ row.mis }}</span>
                <el-icon
                  class="copy-btn"
                  @click.stop="copyText(row.mis)"
                >
                  <el-icon-document-copy />
                </el-icon>
              </div>
              <span v-else style="color: var(--text-quaternary); font-size: var(--font-size-sm);">未绑定</span>
            </template>
          </el-table-column>

          <el-table-column
            prop="createTime"
            label="创建时间"
            width="170"
            sortable="custom"
          >
            <template #default="{ row }">
              <span style="color: var(--text-secondary); font-size: var(--font-size-sm);">
                {{ Utils.formatDate(row.createTime, 'YYYY-MM-DD HH:mm') }}
              </span>
            </template>
          </el-table-column>

          <el-table-column
            prop="lastLoginTime"
            label="最后登录"
            width="170"
            sortable="custom"
          >
            <template #default="{ row }">
              <span style="color: var(--text-secondary); font-size: var(--font-size-sm);">
                {{ Utils.formatDate(row.lastLoginTime, 'YYYY-MM-DD HH:mm') }}
              </span>
            </template>
          </el-table-column>

          <el-table-column label="状态" width="110">
            <template #default="{ row }">
              <div class="status-cell">
                <span :class="['status-dot', row.status === '正常' ? 'ok' : 'warn']"></span>
                <span style="color: var(--text-secondary);">{{ row.status }}</span>
              </div>
            </template>
          </el-table-column>

          <el-table-column label="账号金额" width="150">
            <template #default="{ row }">
              <div class="balance-cell" @click.stop="editBalance(row)">
                <span>{{ Utils.formatNumber(row.balance) }}</span>
                <span style="font-weight: normal; font-size: var(--font-size-xs); color: var(--text-tertiary);">w币</span>
                <el-tooltip content="点击修改账号余额" placement="top">
                  <el-icon style="font-size: 14px; color: var(--text-tertiary);">
                    <el-icon-edit />
                  </el-icon>
                </el-tooltip>
              </div>
            </template>
          </el-table-column>

          <el-table-column label="操作" width="200" fixed="right">
            <template #default="{ row }">
              <div class="action-buttons">
                <el-button
                  link
                  type="primary"
                  size="small"
                  @click="resetPassword(row)"
                >
                  重置密码
                </el-button>
                <el-button
                  link
                  :type="row.status === '正常' ? 'warning' : 'success'"
                  size="small"
                  @click="toggleStatus(row)"
                >
                  {{ row.status === '正常' ? '禁用' : '启用' }}
                </el-button>
                <el-button
                  link
                  type="danger"
                  size="small"
                  @click="deleteUser(row)"
                >
                  注销
                </el-button>
              </div>
            </template>
          </el-table-column>
        </el-table>

        <!-- 分页 -->
        <div style="padding: var(--space-4); display: flex; justify-content: flex-end;">
          <el-pagination
            v-model:current-page="pagination.page"
            v-model:page-size="pagination.pageSize"
            :page-sizes="[10, 20, 50, 100]"
            :total="pagination.total"
            layout="total, sizes, prev, pager, next, jumper"
            @size-change="handleSizeChange"
            @current-change="handlePageChange"
          />
        </div>
      </div>
    </div>

    <!-- 修改账号金额对话框 -->
    <el-dialog
      v-model="balanceDialog.visible"
      title="修改账号金额"
      width="500px"
    >
      <el-form :model="balanceDialog.form" label-width="100px">
        <el-form-item label="当前余额">
          <span style="font-size: 18px; font-weight: 600; color: var(--primary-color);">
            {{ Utils.formatNumber(balanceDialog.currentBalance) }} w币
          </span>
        </el-form-item>

        <el-form-item label="操作类型">
          <el-radio-group v-model="balanceDialog.form.type">
            <el-radio value="add">充值</el-radio>
            <el-radio value="deduct">扣除</el-radio>
          </el-radio-group>
        </el-form-item>

        <el-form-item label="变动金额">
          <el-input-number
            v-model="balanceDialog.form.amount"
            :min="1"
            :max="1000000"
            placeholder="请输入金额"
            style="width: 100%;"
          />
        </el-form-item>

        <el-form-item label="操作原因">
          <el-input
            v-model="balanceDialog.form.reason"
            type="textarea"
            :rows="3"
            placeholder="请输入操作原因（必填）"
          />
        </el-form-item>

        <el-form-item label="操作后余额">
          <span style="font-size: 16px; font-weight: 600; color: var(--success-color);">
            {{ calculatedBalance }} w币
          </span>
        </el-form-item>
      </el-form>

      <template #footer>
        <el-button @click="balanceDialog.visible = false">取消</el-button>
        <el-button
          type="primary"
          @click="confirmBalanceChange"
          :disabled="!balanceDialog.form.reason"
        >
          确认修改
        </el-button>
      </template>
    </el-dialog>
  </div>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3.3.11/dist/vue.global.js"></script>
  <!-- Element Plus -->
  <script src="https://unpkg.com/element-plus@2.4.4/dist/index.full.js"></script>
  <!-- Element Plus Icons -->
  <script src="https://unpkg.com/@element-plus/icons-vue@2.3.1/dist/index.iife.min.js"></script>
  
  <!-- 工具函数 -->
  <script src="./assets/js/utils.js"></script>
  <!-- Mock数据 -->
  <script src="./assets/js/mock-data.js"></script>
  
  <script>
    const { createApp, ref, computed, onMounted, watch } = Vue;
    
    const app = createApp({
      setup() {
        // 响应式数据
        const loading = ref(false);
        const stats = ref({ total: 0, normal: 0, disabled: 0 });
        const tableData = ref([]);
        const allTenants = ref([]);
        
        const filters = ref({
          search: '',
          status: '全部',
          tenants: [],
          dateRange: null
        });

        const pagination = ref({
          page: 1,
          pageSize: 20,
          total: 0
        });

        const balanceDialog = ref({
          visible: false,
          userId: null,
          currentBalance: 0,
          form: {
            type: 'add',
            amount: 100,
            reason: ''
          }
        });

        // 计算属性
        const calculatedBalance = computed(() => {
          const current = balanceDialog.value.currentBalance;
          const amount = balanceDialog.value.form.amount || 0;
          const type = balanceDialog.value.form.type;
          
          if (type === 'add') {
            return Utils.formatNumber(current + amount);
          } else {
            return Utils.formatNumber(Math.max(0, current - amount));
          }
        });

        // 加载数据
        const loadData = () => {
          loading.value = true;

          // 构建查询参数
          const params = {
            page: pagination.value.page,
            pageSize: pagination.value.pageSize,
            search: filters.value.search,
            status: filters.value.status,
            tenants: filters.value.tenants
          };

          if (filters.value.dateRange) {
            params.startDate = filters.value.dateRange[0];
            params.endDate = filters.value.dateRange[1];
          }

          // 从MockData获取数据
          const result = MockData.getUsers(params);
          tableData.value = result.list;
          pagination.value.total = result.total;

          setTimeout(() => {
            loading.value = false;
          }, 300);
        };

        // 加载统计数据
        const loadStats = () => {
          stats.value = MockData.getUserStats();
        };

        // 加载租户列表
        const loadTenants = () => {
          allTenants.value = MockData.getAllTenants();
        };

        // 防抖搜索
        const handleSearch = Utils.debounce(() => {
          pagination.value.page = 1;
          loadData();
        }, 500);

        // 筛选
        const handleFilter = () => {
          pagination.value.page = 1;
          loadData();
        };

        // 排序
        const handleSortChange = ({ prop, order }) => {
          // 实现排序逻辑
          loadData();
        };

        // 分页
        const handlePageChange = (page) => {
          loadData();
        };

        const handleSizeChange = (size) => {
          pagination.value.page = 1;
          loadData();
        };

        // 复制文本
        const copyText = async (text) => {
          const success = await Utils.copyToClipboard(text);
          if (success) {
            ElementPlus.ElMessage.success('复制成功');
          } else {
            ElementPlus.ElMessage.error('复制失败');
          }
        };
        
        // 查看用户详情
        const viewUserDetail = (userId) => {
          window.location.href = `user-detail.html?userId=${userId}`;
        };

        // 修改余额
        const editBalance = (row) => {
          balanceDialog.value.visible = true;
          balanceDialog.value.userId = row.id;
          balanceDialog.value.currentBalance = row.balance;
          balanceDialog.value.form = {
            type: 'add',
            amount: 100,
            reason: ''
          };
        };

        // 确认余额修改
        const confirmBalanceChange = () => {
          const { userId, form } = balanceDialog.value;
          const amount = form.type === 'add' ? form.amount : -form.amount;
          
          MockData.updateUserBalance(userId, amount, form.reason);
          
          ElementPlus.ElMessage.success('账号金额修改成功');
          balanceDialog.value.visible = false;
          loadData();
          loadStats();
        };

        // 重置密码
        const resetPassword = (row) => {
          ElementPlus.ElMessageBox.prompt('请输入新密码', '重置密码', {
            confirmButtonText: '确认',
            cancelButtonText: '取消',
            inputPattern: /.{6,}/,
            inputErrorMessage: '密码至少6位'
          }).then(({ value }) => {
            ElementPlus.ElMessage.success(`用户 ${row.name} 的密码已重置`);
          }).catch(() => {});
        };

        // 切换状态
        const toggleStatus = (row) => {
          const action = row.status === '正常' ? '禁用' : '启用';
          
          ElementPlus.ElMessageBox.confirm(
            `确认${action}用户 "${row.name}" 吗？`,
            `${action}用户`,
            {
              confirmButtonText: '确认',
              cancelButtonText: '取消',
              type: 'warning'
            }
          ).then(() => {
            const newStatus = MockData.toggleUserStatus(row.id);
            ElementPlus.ElMessage.success(`用户已${action}`);
            loadData();
            loadStats();
          }).catch(() => {});
        };

        // 注销用户
        const deleteUser = (row) => {
          ElementPlus.ElMessageBox.prompt(
            `注销用户是终极高危操作，将删除该用户的所有数据。请输入 "确认注销" 以继续`,
            `注销用户 "${row.name}"`,
            {
              confirmButtonText: '确认注销',
              cancelButtonText: '取消',
              inputPattern: /^确认注销$/,
              inputErrorMessage: '请输入"确认注销"',
              type: 'error'
            }
          ).then(() => {
            ElementPlus.ElMessage.success(`用户 ${row.name} 已注销`);
            // 这里应该调用真实的删除API
          }).catch(() => {});
        };

        // 初始化
        onMounted(() => {
          loadTenants();
          loadStats();
          loadData();
        });
        
        return {
          loading,
          stats,
          tableData,
          allTenants,
          filters,
          pagination,
          balanceDialog,
          calculatedBalance,
          handleSearch,
          handleFilter,
          handleSortChange,
          handlePageChange,
          handleSizeChange,
          copyText,
          viewUserDetail,
          editBalance,
          confirmBalanceChange,
          resetPassword,
          toggleStatus,
          deleteUser,
          Utils
        };
      }
    });
    
    // 注册Element Plus图标
    for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
      app.component(`ElIcon${key}`, component);
    }
    
    app.use(ElementPlus).mount('#app');
  </script>
</body>
</html>

