<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>个人付费记录</title>
  
  <!-- Element Plus CSS -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/dist/index.css">
  
  <!-- 自定义飞书设计系统 -->
  <link rel="stylesheet" href="../assets/css/feishu-design.css">
  
  <style>
    body {
      margin: 0;
      padding: var(--spacing-6);
      background: var(--bg-2);
    }
    
    .page-notice {
      padding: var(--spacing-4) var(--spacing-5);
      background: var(--info-lightest);
      border-left: 4px solid var(--info-color);
      border-radius: var(--radius-medium);
      margin-bottom: var(--spacing-6);
      display: flex;
      align-items: center;
      gap: var(--spacing-3);
    }
    
    .page-notice-icon {
      color: var(--info-color);
      font-size: var(--font-size-18);
      flex-shrink: 0;
    }
    
    .page-notice-text {
      font-size: var(--font-size-13);
      color: var(--text-2);
      line-height: 1.6;
    }
    
    .filter-section {
      background: var(--bg-1);
      border-radius: var(--radius-large);
      padding: var(--spacing-5) var(--spacing-6);
      box-shadow: var(--shadow-1);
      margin-bottom: var(--spacing-6);
    }
    
    .filter-row {
      display: flex;
      align-items: flex-end;
      gap: var(--spacing-4);
      flex-wrap: nowrap;
    }
    
    .filter-item {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-2);
    }
    
    .filter-item.date-range {
      min-width: 280px;
      max-width: 320px;
    }
    
    .filter-item.operator {
      min-width: 140px;
      max-width: 160px;
    }
    
    .filter-item.tenant {
      min-width: 160px;
      max-width: 180px;
    }
    
    .filter-item.behavior {
      min-width: 160px;
      max-width: 180px;
    }
    
    .filter-item.export {
      margin-left: auto;
      flex-shrink: 0;
    }
    
    .export-button {
      min-width: auto;
      padding: var(--spacing-2) var(--spacing-3);
      font-size: var(--font-size-13);
      height: 32px;
      border-radius: var(--radius-medium);
    }
    
    .export-button .el-icon {
      margin-right: var(--spacing-1);
    }
    
    .filter-label {
      font-size: var(--font-size-13);
      font-weight: var(--font-weight-medium);
      color: var(--text-2);
    }
    
    .table-section {
      background: var(--bg-1);
      border-radius: var(--radius-large);
      box-shadow: var(--shadow-1);
      overflow: hidden;
    }
    
    .table-header {
      padding: var(--spacing-5) var(--spacing-6);
      border-bottom: 1px solid var(--border-2);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .table-title {
      font-size: var(--font-size-16);
      font-weight: var(--font-weight-semibold);
      color: var(--text-1);
    }
    
    .behavior-cell {
      font-weight: var(--font-weight-medium);
      color: var(--text-1);
    }
    
    .amount-cell {
      font-family: var(--font-family-mono);
      font-weight: var(--font-weight-semibold);
      color: var(--primary-color);
      font-size: var(--font-size-16);
    }
    
    .operator-cell {
      display: flex;
      align-items: center;
      gap: var(--spacing-2);
    }
    
    .operator-avatar {
      width: 24px;
      height: 24px;
      border-radius: var(--radius-circle);
      object-fit: cover;
      border: 1px solid var(--border-2);
    }
    
    .operator-name {
      font-weight: var(--font-weight-medium);
      color: var(--text-1);
    }
    
    .tenant-cell {
      display: flex;
      align-items: center;
      gap: var(--spacing-2);
    }
    
    .tenant-avatar {
      width: 20px;
      height: 20px;
      border-radius: var(--radius-medium);
      object-fit: cover;
      border: 1px solid var(--border-2);
    }
    
    .tenant-name {
      font-weight: var(--font-weight-medium);
      color: var(--text-1);
    }
    
    .date-cell {
      color: var(--text-3);
      font-size: var(--font-size-13);
    }
    
    /* 响应式设计 */
    @media (max-width: 1400px) {
      .filter-item.date-range {
        min-width: 260px;
        max-width: 300px;
      }
      
      .filter-item.operator {
        min-width: 120px;
        max-width: 140px;
      }
      
      .filter-item.tenant {
        min-width: 140px;
        max-width: 160px;
      }
      
      .filter-item.behavior {
        min-width: 140px;
        max-width: 160px;
      }
    }
    
    @media (max-width: 1200px) {
      .filter-row {
        flex-wrap: wrap;
        gap: var(--spacing-3);
      }
      
      .filter-item.date-range {
        min-width: 100%;
        max-width: 100%;
      }
      
      .filter-item.operator,
      .filter-item.tenant,
      .filter-item.behavior {
        min-width: calc(33.333% - var(--spacing-2));
        max-width: calc(33.333% - var(--spacing-2));
      }
      
      .filter-item.export {
        margin-left: 0;
        margin-top: var(--spacing-3);
      }
    }
    
    @media (max-width: 768px) {
      .filter-row {
        flex-direction: column;
        align-items: stretch;
        gap: var(--spacing-3);
      }
      
      .filter-item {
        min-width: 100% !important;
        max-width: 100% !important;
      }
      
      .filter-item.export {
        margin-left: 0;
        margin-top: 0;
        align-self: flex-start;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- 页面提示 -->
    <div class="page-notice">
      <el-icon class="page-notice-icon"><el-icon-info-filled /></el-icon>
      <div class="page-notice-text">
        <strong>数据说明：</strong>本页面展示用户的个人付费记录，包括充值积分、订阅套餐等付费行为。数据为实时更新，支持按时间、操作人和目标租户筛选。
      </div>
    </div>
    
    <!-- 筛选器 -->
    <div class="filter-section">
      <div class="filter-row">
        <div class="filter-item date-range">
          <label class="filter-label">日期范围</label>
          <el-date-picker
            v-model="filters.dateRange"
            type="daterange"
            range-separator="至"
            start-placeholder="开始日期"
            end-placeholder="结束日期"
            clearable
            style="width: 100%;"
            @change="handleFilter"
          />
        </div>
        
        <div class="filter-item operator">
          <label class="filter-label">操作人</label>
          <el-select
            v-model="filters.operator"
            placeholder="全部操作人"
            clearable
            filterable
            style="width: 100%;"
            @change="handleFilter"
          >
            <el-option label="全部操作人" value="" />
            <el-option
              v-for="operator in uniqueOperators"
              :key="operator"
              :label="operator"
              :value="operator"
            />
          </el-select>
        </div>
        
        <div class="filter-item tenant">
          <label class="filter-label">目标租户</label>
          <el-select
            v-model="filters.targetTenant"
            placeholder="全部租户"
            clearable
            filterable
            style="width: 100%;"
            @change="handleFilter"
          >
            <el-option label="全部租户" value="" />
            <el-option
              v-for="tenant in uniqueTenants"
              :key="tenant"
              :label="tenant"
              :value="tenant"
            />
          </el-select>
        </div>
        
        <div class="filter-item behavior">
          <label class="filter-label">行为类型</label>
          <el-select
            v-model="filters.behavior"
            placeholder="全部行为"
            clearable
            style="width: 100%;"
            @change="handleFilter"
          >
            <el-option label="全部行为" value="" />
            <el-option label="充值积分" value="充值积分" />
            <el-option label="订阅套餐 - 企业版" value="订阅套餐 - 企业版" />
            <el-option label="续费套餐 - 团队版" value="续费套餐 - 团队版" />
            <el-option label="订阅套餐 - 团队版" value="订阅套餐 - 团队版" />
            <el-option label="续费套餐 - 企业版" value="续费套餐 - 企业版" />
          </el-select>
        </div>
        
        <!-- <div class="filter-item export">
          <el-button @click="handleExport" type="primary" class="export-button" size="small">
            <el-icon><el-icon-download /></el-icon>
            导出
          </el-button>
        </div> -->
      </div>
    </div>
    
    <!-- 数据表格 -->
    <div class="table-section">
      <div class="table-header">
        <span class="table-title">个人付费记录</span>
        <span style="color: var(--text-3); font-size: var(--font-size-13);">
          共 {{ filteredData.length }} 条记录
        </span>
      </div>
      
      <el-table
        :data="paginatedData"
        v-loading="loading"
        style="width: 100%"
        stripe
        @sort-change="handleSortChange"
        :default-sort="{ prop: 'date', order: 'descending' }"
      >
        <el-table-column prop="id" label="记录ID" width="140">
          <template #default="{ row }">
            <span style="font-family: var(--font-family-mono); color: var(--text-3); font-size: var(--font-size-12);">
              {{ row.id }}
            </span>
          </template>
        </el-table-column>
        
        <el-table-column prop="behavior" label="行为" min-width="200" sortable="custom">
          <template #default="{ row }">
            <span class="behavior-cell">{{ row.behavior }}</span>
          </template>
        </el-table-column>
        
        <el-table-column prop="date" label="时间" width="180" sortable="custom">
          <template #default="{ row }">
            <span class="date-cell">{{ Utils.formatDate(row.date, 'YYYY-MM-DD HH:mm') }}</span>
          </template>
        </el-table-column>
        
        <el-table-column prop="operator" label="操作人" width="150" sortable="custom">
          <template #default="{ row }">
            <div class="operator-cell">
              <img :src="getOperatorAvatar(row.operator)" :alt="row.operator" class="operator-avatar" />
              <span class="operator-name">{{ row.operator }}</span>
            </div>
          </template>
        </el-table-column>
        
        <el-table-column prop="targetTenant" label="目标租户" width="200" sortable="custom">
          <template #default="{ row }">
            <div class="tenant-cell">
              <img :src="getTenantAvatar(row.targetTenantId)" :alt="row.targetTenant" class="tenant-avatar" />
              <span class="tenant-name">{{ row.targetTenant }}</span>
            </div>
          </template>
        </el-table-column>
        
        <el-table-column prop="amount" label="消耗金额" width="150" align="right" sortable="custom">
          <template #default="{ row }">
            <span class="amount-cell">{{ Utils.formatNumber(row.amount) }} w币</span>
          </template>
        </el-table-column>
      </el-table>
      
      <!-- 分页 -->
      <div style="padding: var(--spacing-4) var(--spacing-6); display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-2);">
        <span style="color: var(--text-3); font-size: var(--font-size-13);">
          共 {{ filteredData.length }} 条
        </span>
        <el-pagination
          v-model:current-page="pagination.page"
          v-model:page-size="pagination.pageSize"
          :page-sizes="[20, 50, 100, 200]"
          :total="filteredData.length"
          layout="sizes, prev, pager, next, jumper"
          @size-change="handleSizeChange"
          @current-change="handlePageChange"
        />
      </div>
    </div>
  </div>
  
  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3.3.11/dist/vue.global.js"></script>
  <!-- Element Plus -->
  <script src="https://unpkg.com/element-plus@2.4.4/dist/index.full.js"></script>
  <!-- Element Plus Icons -->
  <script src="https://unpkg.com/@element-plus/icons-vue@2.3.1/dist/index.iife.min.js"></script>
  
  <!-- 工具函数 -->
  <script src="../assets/js/utils.js"></script>
  <!-- Mock数据 -->
  <script src="../assets/js/mock-data.js"></script>
  
  <script>
    const { createApp, ref, computed, onMounted } = Vue;
    
    const app = createApp({
      setup() {
        const userId = ref(Utils.getUrlParam('userId') || 'U00000001');
        const loading = ref(false);
        
        // 数据 - 写死的模拟数据
        const paymentRecords = ref([
          {
            id: 'PP00000001',
            behavior: '充值积分',
            date: new Date('2024-01-15T10:30:00Z'),
            operator: '当前用户',
            targetTenant: '创新科技有限公司',
            targetTenantId: 'T123456',
            amount: 15000
          },
          {
            id: 'PP00000002',
            behavior: '订阅套餐 - 企业版',
            date: new Date('2024-01-20T14:25:00Z'),
            operator: '当前用户',
            targetTenant: '云端智能',
            targetTenantId: 'T123457',
            amount: 120000
          },
          {
            id: 'PP00000003',
            behavior: '续费套餐 - 团队版',
            date: new Date('2024-02-03T09:15:00Z'),
            operator: '当前用户',
            targetTenant: '数字未来科技',
            targetTenantId: 'T123458',
            amount: 25000
          },
          {
            id: 'PP00000004',
            behavior: '充值积分',
            date: new Date('2024-02-18T16:45:00Z'),
            operator: '当前用户',
            targetTenant: '星辰网络',
            targetTenantId: 'T123459',
            amount: 30000
          },
          {
            id: 'PP00000005',
            behavior: '订阅套餐 - 团队版',
            date: new Date('2024-03-05T11:30:00Z'),
            operator: '当前用户',
            targetTenant: '飞跃互联',
            targetTenantId: 'T123460',
            amount: 18000
          },
          {
            id: 'PP00000006',
            behavior: '续费套餐 - 企业版',
            date: new Date('2024-03-22T13:20:00Z'),
            operator: '当前用户',
            targetTenant: '智慧方舟',
            targetTenantId: 'T123461',
            amount: 150000
          },
          {
            id: 'PP00000007',
            behavior: '充值积分',
            date: new Date('2024-04-10T08:50:00Z'),
            operator: '当前用户',
            targetTenant: '量子实验室',
            targetTenantId: 'T123462',
            amount: 22000
          },
          {
            id: 'PP00000008',
            behavior: '订阅套餐 - 企业版',
            date: new Date('2024-04-28T15:10:00Z'),
            operator: '当前用户',
            targetTenant: '蓝海科技',
            targetTenantId: 'T123463',
            amount: 180000
          },
          {
            id: 'PP00000009',
            behavior: '续费套餐 - 团队版',
            date: new Date('2024-05-12T12:35:00Z'),
            operator: '当前用户',
            targetTenant: '极光工作室',
            targetTenantId: 'T123464',
            amount: 32000
          },
          {
            id: 'PP00000010',
            behavior: '充值积分',
            date: new Date('2024-05-25T17:20:00Z'),
            operator: '当前用户',
            targetTenant: '未来实验室',
            targetTenantId: 'T123465',
            amount: 45000
          }
        ]);
        
        // 筛选器
        const filters = ref({
          dateRange: null,
          operator: '',
          targetTenant: '',
          behavior: ''
        });
        
        // 分页
        const pagination = ref({
          page: 1,
          pageSize: 20
        });
        
        // 排序
        const sortConfig = ref({
          prop: 'date',
          order: 'descending'
        });
        
        // 计算属性
        const uniqueOperators = computed(() => {
          const operators = [...new Set(paymentRecords.value.map(r => r.operator))];
          return operators.sort();
        });
        
        const uniqueTenants = computed(() => {
          const tenants = [...new Set(paymentRecords.value.map(r => r.targetTenant))];
          return tenants.sort();
        });
        
        const filteredData = computed(() => {
          let data = [...paymentRecords.value];
          
          // 日期筛选
          if (filters.value.dateRange && filters.value.dateRange.length === 2) {
            const startDate = new Date(filters.value.dateRange[0]);
            const endDate = new Date(filters.value.dateRange[1]);
            endDate.setHours(23, 59, 59, 999);
            
            data = data.filter(record => {
              const recordDate = new Date(record.date);
              return recordDate >= startDate && recordDate <= endDate;
            });
          }
          
          // 操作人筛选
          if (filters.value.operator) {
            data = data.filter(record => record.operator === filters.value.operator);
          }
          
          // 目标租户筛选
          if (filters.value.targetTenant) {
            data = data.filter(record => record.targetTenant === filters.value.targetTenant);
          }
          
          // 行为筛选
          if (filters.value.behavior) {
            data = data.filter(record => record.behavior === filters.value.behavior);
          }
          
          // 排序
          if (sortConfig.value.prop) {
            data.sort((a, b) => {
              const aVal = a[sortConfig.value.prop];
              const bVal = b[sortConfig.value.prop];
              const order = sortConfig.value.order === 'ascending' ? 1 : -1;
              return aVal > bVal ? order : -order;
            });
          }
          
          return data;
        });
        
        const paginatedData = computed(() => {
          const start = (pagination.value.page - 1) * pagination.value.pageSize;
          const end = start + pagination.value.pageSize;
          return filteredData.value.slice(start, end);
        });
        
        // 方法
        const loadData = () => {
          // 数据已经写死，不需要加载
          loading.value = false;
        };
        
        const handleFilter = () => {
          pagination.value.page = 1;
        };
        
        const handleSortChange = ({ prop, order }) => {
          sortConfig.value = { prop, order };
        };
        
        const handlePageChange = () => {
          // 分页变化
        };
        
        const handleSizeChange = () => {
          pagination.value.page = 1;
        };
        
        const getOperatorAvatar = (operator) => {
          return `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(operator)}`;
        };
        
        const getTenantAvatar = (tenantId) => {
          return `https://api.dicebear.com/7.x/shapes/svg?seed=${tenantId}`;
        };
        
        const handleExport = () => {
          const csvData = filteredData.value.map(record => ({
            '记录ID': record.id,
            '行为': record.behavior,
            '时间': Utils.formatDate(record.date, 'YYYY-MM-DD HH:mm'),
            '操作人': record.operator,
            '目标租户': record.targetTenant,
            '消耗金额(w币)': record.amount
          }));
          
          Utils.exportCSV(csvData, `个人付费记录_${userId.value}_${Utils.formatDate(new Date(), 'YYYY-MM-DD')}.csv`);
          ElementPlus.ElMessage.success('导出成功');
        };
        
        // 初始化
        onMounted(() => {
          loadData();
        });
        
        return {
          loading,
          paymentRecords,
          filters,
          pagination,
          sortConfig,
          uniqueOperators,
          uniqueTenants,
          filteredData,
          paginatedData,
          loadData,
          handleFilter,
          handleSortChange,
          handlePageChange,
          handleSizeChange,
          getOperatorAvatar,
          getTenantAvatar,
          handleExport,
          Utils
        };
      }
    });
    
    // 注册Element Plus图标
    for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
      app.component(`ElIcon${key}`, component);
    }
    
    app.use(ElementPlus).mount('#app');
  </script>
</body>
</html>
