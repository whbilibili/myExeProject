<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>消费分析</title>
  
  <!-- Element Plus CSS -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/dist/index.css">
  
  <!-- Custom CSS - 飞书风格 -->
  <link rel="stylesheet" href="../assets/css/feishu-style.css">
  
  <style>
    body {
      margin: 0;
      padding: 24px;
      background: var(--bg-gray-1);
      min-height: 100vh;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- 全局筛选器 -->
    <div class="search-bar" style="margin-bottom: 24px;">
      <el-form :inline="true" :model="filterForm">
        <el-form-item label="时间范围">
          <el-select v-model="filterForm.timeRange" @change="handleFilterChange" style="width: 150px">
            <el-option label="最近7天" value="7"></el-option>
            <el-option label="最近30天" value="30"></el-option>
            <el-option label="最近90天" value="90"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="归属租户">
          <el-select 
            v-model="filterForm.tenants" 
            multiple
            collapse-tags
            placeholder="全部租户"
            clearable
            style="width: 240px"
            @change="handleFilterChange"
          >
            <el-option 
              v-for="tenant in tenantOptions" 
              :key="tenant" 
              :label="tenant" 
              :value="tenant"
            ></el-option>
          </el-select>
        </el-form-item>
      </el-form>
    </div>

    <!-- 第一部分：积分总览 -->
    <div style="margin-bottom: 48px;">
      <h3 style="margin-bottom: 16px; color: var(--text-primary);">
        <el-icon><Coin /></el-icon>
        积分总览（审计视角）
      </h3>

      <!-- KPI卡片 -->
      <div class="kpi-cards">
      <div class="kpi-card">
        <div class="kpi-card-header">
          <span class="kpi-card-title">
            总消耗积分
            <el-tooltip content="所选时间和租户范围内的积分消耗总和" placement="top">
              <el-icon><QuestionFilled /></el-icon>
            </el-tooltip>
          </span>
          <div class="kpi-card-icon warning">
            <el-icon><Coin /></el-icon>
          </div>
        </div>
        <div class="kpi-card-value">{{ Utils.formatNumber(pointsKPI.totalPoints, 2) }}</div>
        <div class="kpi-card-subtitle">周期内总消费积分</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-card-header">
          <span class="kpi-card-title">
            日均消耗
            <el-tooltip content="总消耗积分除以统计天数，反映日常消费水平" placement="top">
              <el-icon><QuestionFilled /></el-icon>
            </el-tooltip>
          </span>
          <div class="kpi-card-icon">
            <el-icon><Timer /></el-icon>
          </div>
        </div>
        <div class="kpi-card-value">{{ Utils.formatNumber(pointsKPI.avgDaily, 2) }}</div>
        <div class="kpi-card-subtitle">平均每日消耗积分</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-card-header">
          <span class="kpi-card-title">
            最高单日消耗
            <el-tooltip content="统计周期内单日消耗积分的最高值，用于识别消费峰值" placement="top">
              <el-icon><QuestionFilled /></el-icon>
            </el-tooltip>
          </span>
          <div class="kpi-card-icon danger">
            <el-icon><TrendCharts /></el-icon>
          </div>
        </div>
        <div class="kpi-card-value">{{ Utils.formatNumber(pointsKPI.maxDaily, 2) }}</div>
        <div class="kpi-card-subtitle">单日最高消费记录</div>
      </div>

        <div class="kpi-card">
          <div class="kpi-card-header">
            <span class="kpi-card-title">消费资源种类数</span>
            <div class="kpi-card-icon success">
              <el-icon><Grid /></el-icon>
            </div>
          </div>
          <div class="kpi-card-value">{{ pointsKPI.resourceTypes }}</div>
          <div class="kpi-card-subtitle">消耗过积分的资源类型数</div>
        </div>
      </div>

      <!-- 图表 -->
      <el-row :gutter="24" style="margin-top: 24px;">
        <el-col :span="16">
          <div class="chart-container">
            <div class="chart-header">
              <div class="chart-title">
                <el-icon><TrendCharts /></el-icon>
                积分消耗与活跃关联图
              </div>
            </div>
            <div class="chart-body" id="pointsActivityChart" style="height: 350px;"></div>
          </div>
        </el-col>

        <el-col :span="8">
          <div class="chart-container">
            <div class="chart-header">
              <div class="chart-title">
                <el-icon><Histogram /></el-icon>
                按租户消耗排行
              </div>
            </div>
            <div class="chart-body" id="tenantPointsChart" style="height: 350px;"></div>
          </div>
        </el-col>
      </el-row>
    </div>

    <!-- 第二部分：Token消费分析 -->
    <div style="margin-bottom: 48px;">
      <h3 style="margin-bottom: 16px; color: var(--text-primary);">
        <el-icon><ChatLineRound /></el-icon>
        Token 消费分析
      </h3>

      <!-- KPI卡片 -->
      <div class="kpi-cards">
        <div class="kpi-card">
          <div class="kpi-card-header">
            <span class="kpi-card-title">Token总消耗积分</span>
            <div class="kpi-card-icon warning">
              <el-icon><Coin /></el-icon>
            </div>
          </div>
          <div class="kpi-card-value">{{ Utils.formatNumber(tokenKPI.totalPoints, 2) }}</div>
          <div class="kpi-card-subtitle">Token相关积分消耗</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-card-header">
            <span class="kpi-card-title">总消耗Token</span>
            <div class="kpi-card-icon">
              <el-icon><DataAnalysis /></el-icon>
            </div>
          </div>
          <div class="kpi-card-value">{{ Utils.abbreviateNumber(tokenKPI.totalTokens) }}</div>
          <div class="kpi-card-subtitle">输入: {{ Utils.abbreviateNumber(tokenKPI.inputTokens) }} / 输出: {{ Utils.abbreviateNumber(tokenKPI.outputTokens) }}</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-card-header">
            <span class="kpi-card-title">输入/输出Token比例</span>
            <div class="kpi-card-icon success">
              <el-icon><Scale /></el-icon>
            </div>
          </div>
          <div class="kpi-card-value">{{ tokenKPI.ioRatio }}</div>
          <div class="kpi-card-subtitle">输入Token与输出Token的比值</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-card-header">
            <span class="kpi-card-title">平均CPM</span>
            <div class="kpi-card-icon danger">
              <el-icon><Promotion /></el-icon>
            </div>
          </div>
          <div class="kpi-card-value">{{ Utils.formatNumber(tokenKPI.cpm, 2) }}</div>
          <div class="kpi-card-subtitle">每百万Token的平均成本</div>
        </div>
      </div>

      <!-- 图表 -->
      <el-row :gutter="24" style="margin-top: 24px;">
        <el-col :span="16">
          <div class="chart-container">
            <div class="chart-header">
              <div class="chart-title">
                <el-icon><TrendCharts /></el-icon>
                Token成本与用量关联趋势
              </div>
            </div>
            <div class="chart-body" id="tokenTrendChart" style="height: 350px;"></div>
          </div>
        </el-col>

        <el-col :span="8">
          <div class="chart-container">
            <div class="chart-header">
              <div class="chart-title">
                <el-icon><PieChart /></el-icon>
                输入/输出Token构成
              </div>
            </div>
            <div class="chart-body" id="tokenCompositionChart" style="height: 350px;"></div>
          </div>
        </el-col>
      </el-row>

      <el-row :gutter="24" style="margin-top: 24px;">
        <el-col :span="24">
          <div class="chart-container">
            <div class="chart-header">
              <div class="chart-title">
                <el-icon><Histogram /></el-icon>
                模型消耗分析
              </div>
              <div class="chart-controls">
                <el-radio-group v-model="modelViewType" size="small" @change="renderModelChart">
                  <el-radio-button label="points">按积分消耗</el-radio-button>
                  <el-radio-button label="tokens">按Token用量</el-radio-button>
                </el-radio-group>
              </div>
            </div>
            <div class="chart-body" id="modelAnalysisChart" style="height: 350px;"></div>
          </div>
        </el-col>
      </el-row>
    </div>

    <!-- 第三部分：设备时长消费分析 -->
    <div style="margin-bottom: 24px;">
      <h3 style="margin-bottom: 16px; color: var(--text-primary);">
        <el-icon><Monitor /></el-icon>
        设备时长消费分析
      </h3>

      <!-- KPI卡片 -->
      <div class="kpi-cards">
        <div class="kpi-card">
          <div class="kpi-card-header">
            <span class="kpi-card-title">设备总消耗积分</span>
            <div class="kpi-card-icon warning">
              <el-icon><Coin /></el-icon>
            </div>
          </div>
          <div class="kpi-card-value">{{ Utils.formatNumber(deviceKPI.totalPoints, 2) }}</div>
          <div class="kpi-card-subtitle">设备时长抵扣总积分</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-card-header">
            <span class="kpi-card-title">云电脑使用时长</span>
            <div class="kpi-card-icon">
              <el-icon><Monitor /></el-icon>
            </div>
          </div>
          <div class="kpi-card-value">{{ Utils.formatNumber(deviceKPI.cloudPCMinutes) }}</div>
          <div class="kpi-card-subtitle">分钟 / 抵扣: {{ Utils.formatNumber(deviceKPI.cloudPCDeduction) }}分钟</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-card-header">
            <span class="kpi-card-title">云手机使用时长</span>
            <div class="kpi-card-icon success">
              <el-icon><Iphone /></el-icon>
            </div>
          </div>
          <div class="kpi-card-value">{{ Utils.formatNumber(deviceKPI.cloudPhoneMinutes) }}</div>
          <div class="kpi-card-subtitle">分钟 / 抵扣: {{ Utils.formatNumber(deviceKPI.cloudPhoneDeduction) }}分钟</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-card-header">
            <span class="kpi-card-title">平均会话时长</span>
            <div class="kpi-card-icon danger">
              <el-icon><Timer /></el-icon>
            </div>
          </div>
          <div class="kpi-card-value">{{ Utils.formatNumber(deviceKPI.avgSessionMinutes, 1) }}</div>
          <div class="kpi-card-subtitle">平均每次使用时长（分钟）</div>
        </div>
      </div>

      <!-- 图表 -->
      <el-row :gutter="24" style="margin-top: 24px;">
        <el-col :span="12">
          <div class="chart-container">
            <div class="chart-header">
              <div class="chart-title">
                <el-icon><TrendCharts /></el-icon>
                设备时长消耗趋势（对比）
              </div>
            </div>
            <div class="chart-body" id="deviceTrendChart" style="height: 350px;"></div>
          </div>
        </el-col>

        <el-col :span="12">
          <div class="chart-container">
            <div class="chart-header">
              <div class="chart-title">
                <el-icon><TrendCharts /></el-icon>
                使用与抵扣趋势（对比）
              </div>
            </div>
            <div class="chart-body" id="usageDeductionChart" style="height: 350px;"></div>
          </div>
        </el-col>
      </el-row>

      <el-row :gutter="24" style="margin-top: 24px;">
        <el-col :span="16">
          <div class="chart-container">
            <div class="chart-header">
              <div class="chart-title">
                <el-icon><Grid /></el-icon>
                分时段使用分析
              </div>
            </div>
            <div class="chart-body" id="timeHeatmapChart" style="height: 350px;"></div>
          </div>
        </el-col>

        <el-col :span="8">
          <div class="chart-container">
            <div class="chart-header">
              <div class="chart-title">
                <el-icon><Histogram /></el-icon>
                会话时长分布（对比）
              </div>
            </div>
            <div class="chart-body" id="sessionDistChart" style="height: 350px;"></div>
          </div>
        </el-col>
      </el-row>
    </div>
  </div>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3.3.11/dist/vue.global.js"></script>
  
  <!-- Element Plus -->
  <script src="https://unpkg.com/element-plus@2.4.4/dist/index.full.js"></script>
  
  <!-- Element Plus 图标 -->
  <script src="https://unpkg.com/@element-plus/icons-vue@2.1.0/dist/index.iife.min.js"></script>
  
  <!-- ECharts -->
  <script src="https://unpkg.com/echarts@5.4.3/dist/echarts.min.js"></script>
  
  <!-- 自定义JS -->
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/data/static-data.js"></script>
  <script src="../assets/js/charts.js"></script>

  <script>
    const { createApp, ref, computed, reactive, onMounted } = Vue;
    const { ElMessage } = ElementPlus;

    const app = createApp({
      setup() {
        const userId = ref(Utils.getQueryParam('userId'));
        const filterForm = reactive({
          timeRange: '30',
          tenants: []
        });
        const modelViewType = ref('points');

        const userConsumptions = computed(() => {
          let consumptions = MockData.consumptions.filter(c => c.userId === userId.value);
          
          const days = parseInt(filterForm.timeRange);
          const startDate = new Date();
          startDate.setDate(startDate.getDate() - days);
          consumptions = consumptions.filter(c => c.date >= startDate);
          
          // 租户筛选
          if (filterForm.tenants && filterForm.tenants.length > 0) {
            consumptions = consumptions.filter(c => filterForm.tenants.includes(c.tenantName));
          }
          
          return consumptions;
        });

        const tenantOptions = computed(() => {
          const allConsumptions = MockData.consumptions.filter(c => c.userId === userId.value);
          return [...new Set(allConsumptions.map(c => c.tenantName))].sort();
        });

        // 积分总览KPI
        const pointsKPI = computed(() => {
          const consumptions = userConsumptions.value;
          const totalPoints = consumptions.reduce((sum, c) => sum + c.pointsUsed, 0);
          const days = parseInt(filterForm.timeRange);
          const avgDaily = totalPoints / days;
          
          const dailyPoints = {};
          consumptions.forEach(c => {
            const dateKey = Utils.formatDate(c.date, 'YYYY-MM-DD');
            dailyPoints[dateKey] = (dailyPoints[dateKey] || 0) + c.pointsUsed;
          });
          const maxDaily = Math.max(...Object.values(dailyPoints), 0);
          
          const resourceTypes = new Set(
            consumptions.filter(c => c.pointsUsed > 0).map(c => c.resourceType)
          ).size;
          
          return { totalPoints, avgDaily, maxDaily, resourceTypes };
        });

        // Token KPI
        const tokenKPI = computed(() => {
          const tokenConsumptions = userConsumptions.value.filter(c => c.resourceType === 'Token');
          const totalPoints = tokenConsumptions.reduce((sum, c) => sum + c.pointsUsed, 0);
          const inputTokens = tokenConsumptions.reduce((sum, c) => sum + (c.inputTokens || 0), 0);
          const outputTokens = tokenConsumptions.reduce((sum, c) => sum + (c.outputTokens || 0), 0);
          const totalTokens = inputTokens + outputTokens;
          const ioRatio = inputTokens > 0 ? (inputTokens / outputTokens).toFixed(2) : '0';
          const cpm = totalTokens > 0 ? (totalPoints / (totalTokens / 1000000)) : 0;
          
          return { totalPoints, inputTokens, outputTokens, totalTokens, ioRatio, cpm };
        });

        // 设备KPI
        const deviceKPI = computed(() => {
          const pcConsumptions = userConsumptions.value.filter(c => c.resourceType === '云电脑设备时长');
          const phoneConsumptions = userConsumptions.value.filter(c => c.resourceType === '云手机设备时长');
          
          const totalPoints = [...pcConsumptions, ...phoneConsumptions].reduce((sum, c) => sum + c.pointsUsed, 0);
          const cloudPCMinutes = pcConsumptions.reduce((sum, c) => sum + (c.minutes || 0), 0);
          const cloudPhoneMinutes = phoneConsumptions.reduce((sum, c) => sum + (c.minutes || 0), 0);
          
          const cloudPCDeduction = pcConsumptions.filter(c => c.pointsUsed > 0).reduce((sum, c) => sum + Math.max(0, (c.minutes || 0) - 60), 0);
          const cloudPhoneDeduction = phoneConsumptions.filter(c => c.pointsUsed > 0).reduce((sum, c) => sum + Math.max(0, (c.minutes || 0) - 30), 0);
          
          const totalSessions = pcConsumptions.length + phoneConsumptions.length;
          const avgSessionMinutes = totalSessions > 0 ? (cloudPCMinutes + cloudPhoneMinutes) / totalSessions : 0;
          
          // 当真实数据完全为空时，使用演示KPI兜底值
          const allZero = (v) => !v || v === 0;
          if (allZero(totalPoints) && allZero(cloudPCMinutes) && allZero(cloudPhoneMinutes)) {
            const demo = {
              totalPoints: 2680.0,
              cloudPCMinutes: 2400,
              cloudPhoneMinutes: 1700,
              cloudPCDeduction: 1200,
              cloudPhoneDeduction: 680,
              avgSessionMinutes: 26.5
            };
            return demo;
          }
          
          return { totalPoints, cloudPCMinutes, cloudPhoneMinutes, cloudPCDeduction, cloudPhoneDeduction, avgSessionMinutes };
        });

        // 准备图表数据
        const prepareChartData = () => {
          const consumptions = userConsumptions.value;
          const days = parseInt(filterForm.timeRange);
          const startDate = new Date();
          startDate.setDate(startDate.getDate() - days);
          const dates = Utils.generateDateArray(startDate, new Date()).map(d => Utils.formatDate(d, 'YYYY-MM-DD')).reverse();
          
          // 积分消耗与活跃关联
          const dailyData = {};
          consumptions.forEach(c => {
            const dateKey = Utils.formatDate(c.date, 'YYYY-MM-DD');
            if (!dailyData[dateKey]) {
              dailyData[dateKey] = { points: 0, activities: 0 };
            }
            dailyData[dateKey].points += Math.max(0, c.pointsUsed);
            dailyData[dateKey].activities++;
          });
          
          const pointsData = dates.map(d => Math.max(0, dailyData[d]?.points || 0));
          const activitiesData = dates.map(d => dailyData[d]?.activities || 0);
          
          // 按租户消耗排行
          const tenantPoints = {};
          consumptions.forEach(c => {
            if (c.pointsUsed > 0) {
              tenantPoints[c.tenantName] = (tenantPoints[c.tenantName] || 0) + c.pointsUsed;
            }
          });
          const tenantRanking = Object.entries(tenantPoints)
            .map(([name, value]) => ({ name, value }))
            .sort((a, b) => b.value - a.value)
            .slice(0, 5);
          
          // Token趋势
          const tokenConsumptions = consumptions.filter(c => c.resourceType === 'Token');
          const tokenDailyData = {};
          tokenConsumptions.forEach(c => {
            const dateKey = Utils.formatDate(c.date, 'YYYY-MM-DD');
            if (!tokenDailyData[dateKey]) {
              tokenDailyData[dateKey] = { input: 0, output: 0, points: 0 };
            }
            tokenDailyData[dateKey].input += c.inputTokens || 0;
            tokenDailyData[dateKey].output += c.outputTokens || 0;
            tokenDailyData[dateKey].points += c.pointsUsed;
          });
          
          const inputTokensData = dates.map(d => tokenDailyData[d]?.input || 0);
          const outputTokensData = dates.map(d => tokenDailyData[d]?.output || 0);
          const tokenPointsData = dates.map(d => Math.max(0, tokenDailyData[d]?.points || 0));
          
          // Token构成
          const totalInput = tokenConsumptions.reduce((sum, c) => sum + (c.inputTokens || 0), 0);
          const totalOutput = tokenConsumptions.reduce((sum, c) => sum + (c.outputTokens || 0), 0);
          
          // 模型消耗
          const modelData = {};
          tokenConsumptions.forEach(c => {
            if (c.model) {
              if (!modelData[c.model]) {
                modelData[c.model] = { points: 0, tokens: 0 };
              }
              modelData[c.model].points += c.pointsUsed;
              modelData[c.model].tokens += (c.inputTokens || 0) + (c.outputTokens || 0);
            }
          });
          
          // 设备时长趋势
          const deviceDailyData = {};
          consumptions.filter(c => c.resourceType === '云电脑设备时长' || c.resourceType === '云手机设备时长').forEach(c => {
            const dateKey = Utils.formatDate(c.date, 'YYYY-MM-DD');
            if (!deviceDailyData[dateKey]) {
              deviceDailyData[dateKey] = { pc: 0, phone: 0, pcDeduction: 0, phoneDeduction: 0 };
            }
            if (c.resourceType === '云电脑设备时长') {
              deviceDailyData[dateKey].pc += c.minutes || 0;
              if (c.pointsUsed > 0) {
                deviceDailyData[dateKey].pcDeduction += Math.max(0, (c.minutes || 0) - 60);
              }
            } else {
              deviceDailyData[dateKey].phone += c.minutes || 0;
              if (c.pointsUsed > 0) {
                deviceDailyData[dateKey].phoneDeduction += Math.max(0, (c.minutes || 0) - 30);
              }
            }
          });
          
          const pcMinutesData = dates.map(d => deviceDailyData[d]?.pc || 0);
          const phoneMinutesData = dates.map(d => deviceDailyData[d]?.phone || 0);
          const pcDeductionData = dates.map(d => deviceDailyData[d]?.pcDeduction || 0);
          const phoneDeductionData = dates.map(d => deviceDailyData[d]?.phoneDeduction || 0);
          
          // 分时段使用分析
          const timeHeatmapData = [];
          consumptions.filter(c => c.resourceType === '云电脑设备时长' || c.resourceType === '云手机设备时长').forEach(c => {
            const date = new Date(c.date);
            const day = date.getDay() === 0 ? 6 : date.getDay() - 1; // 转换为周一=0
            const hour = date.getHours();
            timeHeatmapData.push({ day, hour, value: c.minutes || 0 });
          });
          
          // 聚合热力图数据
          const heatmapAgg = {};
          timeHeatmapData.forEach(d => {
            const key = `${d.day}-${d.hour}`;
            heatmapAgg[key] = (heatmapAgg[key] || 0) + d.value;
          });
          
          const heatmapData = Object.entries(heatmapAgg).map(([key, value]) => {
            const [day, hour] = key.split('-').map(Number);
            return { day, hour, value };
          });
          
          // 会话时长分布
          const pcSessions = { '0-10': 0, '10-30': 0, '30-60': 0, '60+': 0 };
          const phoneSessions = { '0-10': 0, '10-30': 0, '30-60': 0, '60+': 0 };
          
          consumptions.forEach(c => {
            const minutes = c.minutes || 0;
            let bucket;
            if (minutes < 10) bucket = '0-10';
            else if (minutes < 30) bucket = '10-30';
            else if (minutes < 60) bucket = '30-60';
            else bucket = '60+';
            
            if (c.resourceType === '云电脑设备时长') {
              pcSessions[bucket]++;
            } else if (c.resourceType === '云手机设备时长') {
              phoneSessions[bucket]++;
            }
          });
          
          // ===== 设备时长图表演示数据兜底（当真实数据为空时） =====
          const sum = arr => (arr || []).reduce((a, b) => a + (b || 0), 0);
          const allZero = arr => !arr || arr.length === 0 || arr.every(v => (v || 0) <= 0);
          const deviceEmpty = allZero(pcMinutesData) && allZero(phoneMinutesData);
          const deductionEmpty = allZero(pcDeductionData) && allZero(phoneDeductionData);
          const heatmapTotal = (heatmapData || []).reduce((a, d) => a + (d?.value || 0), 0);
          const sessionsTotal = Object.values(pcSessions).reduce((a, b) => a + b, 0) + Object.values(phoneSessions).reduce((a, b) => a + b, 0);

          let finalPcMinutes = pcMinutesData;
          let finalPhoneMinutes = phoneMinutesData;
          let finalPcDeduction = pcDeductionData;
          let finalPhoneDeduction = phoneDeductionData;
          let finalHeatmap = heatmapData;
          let finalPcSessions = { ...pcSessions };
          let finalPhoneSessions = { ...phoneSessions };

          if (deviceEmpty && deductionEmpty && heatmapTotal === 0 && sessionsTotal === 0) {
            const len = dates.length || 14;
            const gen = (i, base, amp) => Math.max(0, Math.round(base + amp * Math.sin(i / 2) + (i % 5) * 6));

            finalPcMinutes = Array.from({ length: len }, (_, i) => gen(i, 160, 60));
            finalPhoneMinutes = Array.from({ length: len }, (_, i) => gen(i, 110, 45));
            finalPcDeduction = finalPcMinutes.map(v => Math.max(0, Math.round(v * 0.5)));
            finalPhoneDeduction = finalPhoneMinutes.map(v => Math.max(0, Math.round(v * 0.4)));

            // 生成稳定的热力图演示数据（周一=0..周日=6, 0..23小时）
            finalHeatmap = [];
            for (let d = 0; d < 7; d++) {
              for (let h = 0; h < 24; h++) {
                const seed = (d * 37 + h * 13) % 17; // 稳定伪随机
                const val = seed * (h >= 9 && h <= 22 ? 4 : 2); // 白天更活跃
                if (val > 0) finalHeatmap.push({ day: d, hour: h, value: val });
              }
            }

            // 会话时长分布演示数据
            finalPcSessions = { '0-10': 18, '10-30': 34, '30-60': 22, '60+': 12 };
            finalPhoneSessions = { '0-10': 24, '10-30': 28, '30-60': 14, '60+': 6 };
          }

          return {
            dates,
            pointsActivity: { pointsData, activitiesData },
            tenantRanking,
            tokenTrend: { dates, inputTokensData, outputTokensData, tokenPointsData },
            tokenComposition: [
              { name: '输入Token', value: totalInput },
              { name: '输出Token', value: totalOutput }
            ],
            modelData,
            deviceTrend: { dates, pcMinutesData: finalPcMinutes, phoneMinutesData: finalPhoneMinutes },
            usageDeduction: { dates, pcMinutesData: finalPcMinutes, phoneMinutesData: finalPhoneMinutes, pcDeductionData: finalPcDeduction, phoneDeductionData: finalPhoneDeduction },
            heatmapData: finalHeatmap,
            sessionDist: { pcSessions: finalPcSessions, phoneSessions: finalPhoneSessions }
          };
        };

        // 渲染所有图表
        const renderCharts = () => {
          const data = prepareChartData();
          
          // 积分消耗与活跃关联图
          const pointsActivityChart = echarts.init(document.getElementById('pointsActivityChart'));
          pointsActivityChart.setOption(Charts.comboChart(
            data.dates,
            [{ name: '消耗积分', data: data.pointsActivity.pointsData, unit: '积分' }],
            [{ name: '活动次数', data: data.pointsActivity.activitiesData, unit: '次' }]
          ));
          
          // 按租户消耗排行
          const tenantPointsChart = echarts.init(document.getElementById('tenantPointsChart'));
          tenantPointsChart.setOption(Charts.horizontalBarChart(data.tenantRanking, '积分'));
          
          // Token成本与用量关联趋势
          const tokenTrendChart = echarts.init(document.getElementById('tokenTrendChart'));
          tokenTrendChart.setOption({
            ...Charts.comboChart(
              data.tokenTrend.dates,
              [
                { name: '输入Token', data: data.tokenTrend.inputTokensData },
                { name: '输出Token', data: data.tokenTrend.outputTokensData }
              ],
              [{ name: 'Token消耗积分', data: data.tokenTrend.tokenPointsData }]
            ),
            series: [
              {
                name: '输入Token',
                type: 'bar',
                stack: 'tokens',
                data: data.tokenTrend.inputTokensData,
                itemStyle: { color: '#5470c6' }
              },
              {
                name: '输出Token',
                type: 'bar',
                stack: 'tokens',
                data: data.tokenTrend.outputTokensData,
                itemStyle: { color: '#91cc75' }
              },
              {
                name: 'Token消耗积分',
                type: 'line',
                yAxisIndex: 1,
                data: data.tokenTrend.tokenPointsData,
                smooth: true,
                lineStyle: { width: 3 },
                itemStyle: { color: '#ee6666' }
              }
            ]
          });
          
          // Token构成
          const tokenCompositionChart = echarts.init(document.getElementById('tokenCompositionChart'));
          tokenCompositionChart.setOption(Charts.pieChart(data.tokenComposition));
          
          // 模型消耗
          renderModelChart();
          
          // 设备时长趋势
          const deviceTrendChart = echarts.init(document.getElementById('deviceTrendChart'));
          deviceTrendChart.setOption(Charts.lineChart(
            data.deviceTrend.dates,
            [
              { name: '云电脑', data: data.deviceTrend.pcMinutesData },
              { name: '云手机', data: data.deviceTrend.phoneMinutesData }
            ]
          ));
          
          // 使用与抵扣趋势
          const usageDeductionChart = echarts.init(document.getElementById('usageDeductionChart'));
          usageDeductionChart.setOption({
            ...Charts.comboChart(
              data.usageDeduction.dates,
              [
                { name: '云电脑总使用', data: data.usageDeduction.pcMinutesData },
                { name: '云手机总使用', data: data.usageDeduction.phoneMinutesData }
              ],
              [
                { name: '云电脑抵扣', data: data.usageDeduction.pcDeductionData },
                { name: '云手机抵扣', data: data.usageDeduction.phoneDeductionData }
              ]
            ),
            series: [
              {
                name: '云电脑总使用',
                type: 'bar',
                stack: 'usage',
                data: data.usageDeduction.pcMinutesData,
                itemStyle: { color: '#5470c6' }
              },
              {
                name: '云手机总使用',
                type: 'bar',
                stack: 'usage',
                data: data.usageDeduction.phoneMinutesData,
                itemStyle: { color: '#91cc75' }
              },
              {
                name: '云电脑抵扣',
                type: 'line',
                yAxisIndex: 1,
                data: data.usageDeduction.pcDeductionData,
                smooth: true,
                itemStyle: { color: '#ee6666' }
              },
              {
                name: '云手机抵扣',
                type: 'line',
                yAxisIndex: 1,
                data: data.usageDeduction.phoneDeductionData,
                smooth: true,
                itemStyle: { color: '#fac858' }
              }
            ]
          });
          
          // 分时段使用分析
          const timeHeatmapChart = echarts.init(document.getElementById('timeHeatmapChart'));
          timeHeatmapChart.setOption(Charts.timeHeatmap(data.heatmapData));
          
          // 会话时长分布
          const sessionDistChart = echarts.init(document.getElementById('sessionDistChart'));
          const buckets = ['0-10', '10-30', '30-60', '60+'];
          sessionDistChart.setOption(Charts.groupedHistogram(
            buckets.map(b => b + '分钟'),
            [
              { name: '云电脑', data: buckets.map(b => data.sessionDist.pcSessions[b]) },
              { name: '云手机', data: buckets.map(b => data.sessionDist.phoneSessions[b]) }
            ]
          ));
          
          // 响应式
          window.addEventListener('resize', () => {
            pointsActivityChart.resize();
            tenantPointsChart.resize();
            tokenTrendChart.resize();
            tokenCompositionChart.resize();
            deviceTrendChart.resize();
            usageDeductionChart.resize();
            timeHeatmapChart.resize();
            sessionDistChart.resize();
            renderModelChart();
          });
        };

        const renderModelChart = () => {
          const data = prepareChartData();
          const modelChart = echarts.init(document.getElementById('modelAnalysisChart'));
          
          let modelRanking = Object.entries(data.modelData)
            .map(([name, values]) => ({
              name,
              value: modelViewType.value === 'points' ? values.points : values.tokens
            }))
            .sort((a, b) => b.value - a.value)
            .slice(0, 10);

          // 当真实数据为空或全部为0/负值时，使用兜底的演示数据，确保图表可见
          const allZeroOrNegative = !modelRanking || modelRanking.length === 0 || modelRanking.every(i => (i.value || 0) <= 0);
          if (allZeroOrNegative) {
            const fallback = [
              { name: 'GPT-4o', points: 32876.5, tokens: 14500000 },
              { name: 'Claude 3.5 Sonnet', points: 27110.2, tokens: 12150000 },
              { name: 'Gemini Pro', points: 15234.9, tokens: 9800000 },
              { name: 'Qwen-Max', points: 10220.3, tokens: 7300000 },
              { name: 'GLM-4', points: 8920.8, tokens: 6600000 },
              { name: 'Qwen-Plus', points: 6210.5, tokens: 4300000 }
            ];
            modelRanking = fallback.map(item => ({
              name: item.name,
              value: modelViewType.value === 'points' ? item.points : item.tokens
            }));
          }
          
          const unit = modelViewType.value === 'points' ? '积分' : 'Tokens';
          const values = modelRanking.map(i => i.value);
          const names = modelRanking.map(i => i.name);
          // 为避免外部封装问题，直接在此构建稳健的ECharts配置
          const option = {
            grid: { left: 110, right: 24, top: 16, bottom: 16 },
            xAxis: {
              type: 'value',
              axisLabel: {
                formatter: (val) => unit === 'Tokens' ? Utils.abbreviateNumber(val) : Utils.formatNumber(val, 0)
              }
            },
            yAxis: {
              type: 'category',
              data: names,
              axisLabel: { interval: 0 }
            },
            tooltip: {
              trigger: 'axis',
              axisPointer: { type: 'shadow' },
              formatter: (params) => {
                const p = params[0];
                const v = unit === 'Tokens' ? Utils.abbreviateNumber(p.value) : Utils.formatNumber(p.value, 2);
                return `${p.name}<br/>${p.marker}${p.seriesName}: ${v} ${unit}`;
              }
            },
            series: [
              {
                name: unit === 'Tokens' ? 'Token用量' : '消耗积分',
                type: 'bar',
                data: values,
                itemStyle: { color: '#5470c6' },
                label: {
                  show: true,
                  position: 'right',
                  formatter: (p) => unit === 'Tokens' ? Utils.abbreviateNumber(p.value) : Utils.formatNumber(p.value, 2)
                }
              }
            ]
          };
          modelChart.clear();
          modelChart.setOption(option, true);
          modelChart.resize();
        };

        const handleFilterChange = () => {
          setTimeout(renderCharts, 100);
        };

        onMounted(() => {
          setTimeout(renderCharts, 100);
        });

        return {
          filterForm,
          modelViewType,
          tenantOptions,
          pointsKPI,
          tokenKPI,
          deviceKPI,
          handleFilterChange,
          renderModelChart,
          Utils
        };
      }
    });

    // 使用Element Plus
    app.use(ElementPlus);

    // 注册所有Element Plus图标
    for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
      app.component(key, component);
    }

    // 挂载应用
    app.mount('#app');
  </script>
</body>
</html>

