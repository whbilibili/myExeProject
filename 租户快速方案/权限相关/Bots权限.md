<!--
 * @Author: wanghong52 wanghong52@meituan.com
 * @Date: 2025-06-19 10:31:30
 * @LastEditors: wanghong52 wanghong52@meituan.com
 * @LastEditTime: 2025-07-01 10:58:57
 * @FilePath: /租户快速方案/Bots权限.md
 * @Description: 这是默认设置,请设置`customMade`, 打开koroFileHeader查看配置 进行设置: https://github.com/OBKoro1/koro1FileHeader/wiki/%E9%85%8D%E7%BD%AE
-->
# Bots系统 - 数据权限模型 (V2 - 状态切换模型)

### 现状

*   **权限拆分不够细致**：如智能体、工作流等的创建权，没有明确的角色归属。
*   **无继承**：权限赋予依赖显式手动共享，面对批量操作时，操作较为繁琐。

### 权限模型优化方案

本权限模型旨在通过引入"默认继承，自定义覆盖"的机制，结合清晰的角色体系，提升系统的易用性、可管理性和安全性。核心方案阐述如下：

## 一、核心原则：默认继承，自定义覆盖

采用 "默认继承，自定义覆盖" 的核心原则，为子资源（智能体、工作流等）提供两种权限管理状态：

*   **默认继承状态 (Default Inheritance)**：新创建的子资源，其权限设置**完全同步**其所属"空间"的权限。这是一个动态链接，对空间的权限变更会自动、实时地反映到所有处于此状态的子资源上。这是管理权限的主要模式，实现了"改一处，处处生效"的高效管理。

*   **自定义权限状态 (Custom Permissions)**：用户可以为单个子资源设置一套完全独立的权限规则。一旦启用自定义，该资源将与其父级"空间"的权限**完全脱钩**，后续空间的任何权限变更都不会影响该资源。这为特殊资源提供了灵活性。

*   **状态可逆**：处于"自定义权限"状态的资源，可以随时被一键"**清空自定义设置**"，从而恢复到"默认继承"状态，重新跟随空间权限。

## 二、权限角色体系与核心权责

系统在"空间"、"智能体/工作流/插件/知识库"这两层核心资源维度上，统一设置以下五种固定角色。这些角色按权限级别高低排序，高级别角色的权限将覆盖低级别角色的权限。当用户访问统一资源存在角色冲突时（个人和组织层面的角色冲突，组织和组织层面的冲突等），以最高级别角色的权限为准。

*   **所有者 (Owner)**：
    *   **定义**：资源的创建者，自动获得此角色。
    *   **权限**：拥有对资源的全部操作权限，包括删除资源。
    *   **特性**：所有者身份不可被其他任何用户移除或更改。
*   **管理员 (Admin)**：
    *   **定义**：由所有者或其他管理员添加。
    *   **权限**：拥有除删除资源外的所有管理权限。
*   **可编辑 (Editor)**：
    *   **定义**：由所有者或管理员添加。
    *   **权限**：拥有资源的编辑权限，例如修改内容、配置等。
*   **可评论（Commenter）**：
    *   **定义**：由所有者或管理员添加。
    *   **权限**：拥有资源的查看和使用权，且能够添加评论（若支持评论）。
*   **查看与使用 (Viewer)**：
    *   **定义**：由所有者或管理员添加。
    *   **权限**：仅拥有对资源的查看和使用权限，但是无法添加评论。
*   **无权限**：无权限不是一种角色，是用户没有任何权限角色的中间态。

#### 权限矩阵

| 层级 | 角色 | 所有者 | 管理员 | 可编辑 | 可评论 | 查看与使用 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **空间** | 空间查看, 创建智能体, 创建工作流, 创建插件, 创建知识库, 空间设置, 空间删除 | ✅ | ✅ | ✅ | ✅ | ✅ |
| **智能体** | 智能体访问与使用, 智能体编排、发布, 智能体管理, 智能体删除 | ✅ | ✅ | ✅ | ✅ | ✅ |
| **工作流**| 工作流访问与使用, 工作流编排、发布, 工作流管理, 工作流删除 | ✅ | ✅ | ✅ | ✅ | ✅ |
| **工具** | 工具库及其工具的访问与使用, 工具的创建、编辑、发布, 管理工具库和工具, 工具库删除 | ✅ | ✅ | ✅ | ✅ | ✅ |
| **知识库**| 知识库的访问与使用, 知识库的开发, 知识库的管理, 知识库删除 | ✅ | ✅ | ✅ | ✅ | ✅ |

## 三、所有者规则

*   **创建者即所有者**：
    *   任何资源的创建者将自动成为该资源的【所有者】。
    *   创建者的【所有者】身份不可被其他管理员移除，其权限亦不可被其他管理员更改。
*   **注意**：原方案中"上级资源的所有者自动成为下级资源的管理员"的规则**被废弃**，以简化模型。在新的"默认继承"模型下，空间所有者在子资源中的角色，与其在空间中的角色保持一致（即所有者）。

## 四、权限状态管理与工作流

本节详细描述子资源（如智能体）权限在"默认继承"和"自定义权限"两种状态之间切换的具体流程。

#### 1. 默认继承状态

*   **触发**：在空间内创建新资源时，该资源自动进入此状态。
*   **UI表现**：在资源的权限设置页面，会明确提示"**当前权限继承自 'XX空间'**"。权限成员列表会以**只读模式**展示空间的成员列表。
*   **行为**：空间的权限配置发生任何变更（增、删、改成员），将实时同步到所有处于该状态下的子资源。

#### 2. 切换至"自定义权限"状态

*   **触发**：在资源权限页面，用户点击【自定义权限】或类似按钮。
*   **交互流程**：系统将弹出确认对话框，以处理"增量设置"的需求：
    > **"设置独立权限"**
    >
    > "您即将为此资源设置独立权限，这将断开其与'XX空间'的权限继承关系。请选择如何开始："
    >
    > *   **【保留空间成员并自定义】**：将当前从空间继承的权限列表复制为初始设置，您可在此基础上进行增、删、改。
    > *   **【全新设置】**：清空所有权限（仅保留您作为"所有者"），由您从零开始添加成员并分配角色。
    *   **【取消】**
*   **行为**：用户做出选择并保存后，该资源的权限状态切换为"自定义权限"，拥有了一套独立的权限配置。

#### 3. 切换回"默认继承"状态

*   **主动触发**：在处于"自定义权限"状态的资源权限页面，用户点击【恢复继承空间权限】或类似按钮。
    *   **交互流程**：系统将弹出二次确认对话框：
        > **"确认恢复继承？"**
        >
        > "此操作将**清空所有为此资源单独设置的权限**，并使其重新跟随'XX空间'的权限。此操作不可撤销。是否继续？"
        >
        *   **【确认恢复】** / **【取消】**
    *   **行为**：用户确认后，该资源的所有自定义权限设置被**丢弃**，状态恢复为"默认继承"，权限重新与空间同步。

*   **隐式触发（手动清空）**：为提升体验，当用户在"自定义权限"模式下手动移除了所有协作者（除所有者外），导致权限列表为空时，系统也可将其视为恢复继承的意图。
    *   **交互流程**：此时可提示用户："权限列表已清空，是否要恢复继承'XX空间'的权限？"
    *   **行为**：用户确认后，效果同上，状态恢复为"默认继承"。若用户取消，则该资源保持自定义状态，仅所有者可访问。

## 五、权限冲突解决机制

本模型下，权限冲突的场景被大幅简化。

*   **资源层级间**：由于子资源的权限来源是唯一的（要么继承自空间，要么自定义），因此**不存在**空间与子资源之间的权限冲突。
*   **单一资源内**：当一个用户通过多种途径（如同时是个人成员，又属于某个用户组）在**同一个权限列表**中（无论是空间的还是子资源自定义的）被赋予多个角色时，系统遵循"**取最高权限**"的原则。
    *   权限优先级排序：【所有者】> 【管理员】 > 【可编辑】 > 【可评论】>【查看与使用】。

*注："组织"在此上下文中通常指代"用户组"或"部门"。*

## 六、Bots空间下级资源权限相关改造

除下文提到的改造外，Bots原有的其他逻辑不做改动。

| 智能体 | 工作流 | 工具库/工具 | 知识库 |
| :--- | :--- | :--- | :--- |
| **所有者**：<br>- 展示样式：展示创建人头像+名称<br>- 说明文案：拥有对智能体的全部操作权限，包括删除智能体。<br><br>**管理员**：<br>- 展示样式：不变<br>- 说明文案：拥有除删除智能体外的所有权限。<br><br>**可编辑（原开发者）**：<br>- 展示样式：不变<br>- 说明文案：拥有智能体的编辑、编排、发布等权限。<br><br>**可评论**：<br>- 展示样式：同可编辑/管理员<br>- 说明文案：拥有智能体的访问和使用权，且支持添加评论。<br><br>**查看与使用**<br>- 展示样式：同可编辑/管理员<br>- 说明文案：仅拥有智能体的访问和使用权。 | **所有者**：<br>- 展示样式：展示创建人头像+名称<br>- 说明文案：拥有对工作流的全部操作权限，包括删除工作流。<br><br>**管理员**：<br>- 展示样式：不变<br>- 说明文案：拥有除删除工作流外的所有权限。<br><br>**可编辑（原开发者）**：<br>- 展示样式：不变<br>- 说明文案：拥有工作流的基本信息编辑、工作流编排、发布等权限。<br><br>**可评论**：<br>- 展示样式：同可编辑/管理员<br>- 说明文案：拥有工作流的访问和使用权，且支持添加评论。<br><br>**查看与使用**<br>- 展示样式：同可编辑/管理员<br>- 说明文案：仅拥有工作流的访问和使用权。 | **所有者**：<br>- 展示样式：展示创建人头像+名称<br>- 说明文案：拥有对工具库和工具的全部操作权限。<br><br>**管理员**：<br>- 展示样式：不变<br>- 说明文案：拥有除删除工具和工具库外的所有权限。<br><br>**可编辑（原开发者）**：<br>- 展示样式：不变<br>- 说明文案：拥有创建、编辑、发布工具的权限。<br><br>**可评论**：<br>- 展示样式：同可编辑/管理员<br>- 说明文案：拥有工具库和工具的访问和使用权，且支持添加评论。<br><br>**查看与使用**<br>- 展示样式：同可编辑/管理员<br>- 说明文案：仅拥有工具库和工具的访问和使用权。 | **所有者**：<br>- 展示样式：展示创建人头像+名称<br>- 说明文案：拥有对知识库的全部操作权限。<br><br>**管理员**：<br>- 展示样式：不变<br>- 说明文案：拥有除删除知识库外的所有权限。<br><br>**可编辑（原开发者）**：<br>- 展示样式：不变<br>- 说明文案：拥有知识库的开发权限。<br><br>**可评论**：<br>- 展示样式：同可编辑/管理员<br>- 说明文案：拥有知识库的访问和使用权，且支持添加评论。<br><br>**查看与使用**<br>- 展示样式：同可编辑/管理员<br>- 说明文案：仅拥有知识库的访问和使用权。 |

## 七、后续规划与功能增强

当前权限模型强调显式授权，为满足在特定场景下对多个资源进行统一、高效授权的需求，后续计划引入**【批量授权】**机制。

*   **批量授权设想**：允许管理员选择某个应用下的多张表格，一次性将这些表格以特定角色共享给指定用户或用户组。这将显著提升大规模授权的操作效率。