import React, { useState, useMemo } from 'react';
import { Table, Avatar, Tooltip, Popover, Button, Modal, Transfer, Tag, Space, App as AntApp } from 'antd';
import { UserOutlined, TeamOutlined, QuestionCircleOutlined, EditOutlined, PlusOutlined } from '@ant-design/icons';

// --- 全局样式 ---
// 为了保证原型在独立JSX环境下的外观一致性，我们将样式注入到组件中
const GlobalStyles = () => (
    <style>{`
        body {
            background-color: #f0f2f5 !important;
            padding: 24px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
        }
        .container {
            background-color: #fff;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .header h1 {
            font-size: 22px;
            font-weight: 600;
            margin: 0;
        }
        .ant-table-cell .ant-space {
            align-items: center;
        }
        .admin-edit-icon {
            cursor: pointer;
            color: #1677ff;
            font-size: 16px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .ant-table-row:hover .admin-edit-icon {
            visibility: visible;
            opacity: 1;
        }
    `}</style>
);


// --- 模拟数据 ---
// 租户下的所有成员
const allUsers = [
    { key: '1', name: '王宏', avatar: 'https://i.pravatar.cc/150?u=1' },
    { key: '2', name: '周义', avatar: 'https://i.pravatar.cc/150?u=2' },
    { key: '3', name: '张三', avatar: 'https://i.pravatar.cc/150?u=3' },
    { key: '4', name: '李四', avatar: 'https://i.pravatar.cc/150?u=4' },
    { key: '5', name: '王五', avatar: 'https://i.pravatar.cc/150?u=5' },
    { key: '6', name: '赵六', avatar: 'https://i.pravatar.cc/150?u=6' },
    { key: '7', name: '孙七', avatar: 'https://i.pravatar.cc/150?u=7' },
    { key: '8', name: '陈八', avatar: 'https://i.pravatar.cc/150?u=8' },
];

// 租户所有者ID (用于标识)
const tenantOwnerId = '15830348527';

// 空间列表初始数据
const initialSpacesData = [
    { id: 1, name: '[已归档] 15830348527个人空间', agents: 0, workflows: 0, kbs: 0, type: '团队', ownerId: tenantOwnerId, adminIds: ['5', '6', '7'], createdAt: '2025/09/16 19:04:51', lastUpdater: null, lastUpdatedAt: '2025/09/16 19:04:51' },
    { id: 2, name: '测试继承所有者是否能删除资源', agents: 1, workflows: 1, kbs: 1, type: '团队', ownerId: tenantOwnerId, adminIds: ['4'], createdAt: '2025/09/16 16:25:58', lastUpdater: null, lastUpdatedAt: '2025/09/16 16:25:58' },
    { id: 3, name: '1234456', agents: 1, workflows: 2, kbs: 1, type: '团队', ownerId: tenantOwnerId, adminIds: [], createdAt: '2025/09/16 16:12:55', lastUpdater: null, lastUpdatedAt: '2025/09/16 16:12:55' },
    { id: 4, name: '个人空间', agents: 0, workflows: 1, kbs: 0, type: '个人', ownerId: '2', adminIds: [], createdAt: '2025/09/16 14:41:17', lastUpdater: null, lastUpdatedAt: '2025/09/16 14:41:17' },
    { id: 5, name: '自己创建的空间', agents: 0, workflows: 0, kbs: 1, type: '团队', ownerId: tenantOwnerId, adminIds: ['8'], createdAt: '2025/09/16 14:13:06', lastUpdater: null, lastUpdatedAt: '2025/09/16 14:13:06' },
    { id: 6, name: '别人的空间', agents: 2, workflows: 3, kbs: 2, type: '团队', ownerId: '3', adminIds: ['2', '4'], createdAt: '2025/09/16 14:11:52', lastUpdater: null, lastUpdatedAt: '2025/09/16 14:11:52' },
    { id: 7, name: '个人空间', agents: 0, workflows: 0, kbs: 0, type: '个人', ownerId: '3', adminIds: [], createdAt: '2025/09/11 14:27:22', lastUpdater: null, lastUpdatedAt: '2025/09/11 14:27:22' },
];

const App = () => {
    const [spaces, setSpaces] = useState(initialSpacesData);
    const [isModalVisible, setIsModalVisible] = useState(false);
    const [editingSpace, setEditingSpace] = useState(null);
    const [targetKeys, setTargetKeys] = useState([]);
    const { message } = AntApp.useApp();

    const userMap = useMemo(() => {
        const map = new Map();
        allUsers.forEach(user => map.set(user.key, user));
        // 为租户所有者创建一个特殊条目
        map.set(tenantOwnerId, { key: tenantOwnerId, name: '租户所有者', avatar: 'https://i.pravatar.cc/150?u=owner' });
        return map;
    }, []);

    const showModal = (space) => {
        setEditingSpace(space);
        setTargetKeys(space.adminIds);
        setIsModalVisible(true);
    };

    const handleOk = () => {
        setSpaces(prevSpaces =>
            prevSpaces.map(space =>
                space.id === editingSpace.id ? { ...space, adminIds: targetKeys } : space
            )
        );
        message.success(`已成功更新空间 [${editingSpace.name}] 的管理员。`);
        setIsModalVisible(false);
        setEditingSpace(null);
    };

    const handleCancel = () => {
        setIsModalVisible(false);
        setEditingSpace(null);
    };

    const onTransferChange = (nextTargetKeys) => {
        setTargetKeys(nextTargetKeys);
    };

    const helpContent = (
        <div style={{ maxWidth: 300 }}>
            <h4>关于租户级空间管理员</h4>
            <p><strong>用途说明</strong><br />
                此功能用于在特殊情况下，由租户所有者/管理员<strong>临时或长期</strong>指派专人接管空间。
                <br /><i>常见场景：处理离职成员空间、跨部门问题排查、关键项目支持等。</i>
            </p>
            <p><strong>权限来源</strong><br />
                此处<strong>仅显示和管理</strong>由租户层面（即当前页面）指派的管理员。
            </p>
            <p><strong>重要提示</strong><br />
                为保证权责清晰，空间所有者在其空间<strong>内部</strong>自行添加的任何管理员，均<strong>不会</strong>在此处显示。
            </p>
        </div>
    );

    const columns = [
        { title: '空间名称', dataIndex: 'name', key: 'name', width: 250, ellipsis: true },
        { title: '智能体数量', dataIndex: 'agents', key: 'agents', align: 'center' },
        { title: '工作流数量', dataIndex: 'workflows', key: 'workflows', align: 'center' },
        { title: '知识库数量', dataIndex: 'kbs', key: 'kbs', align: 'center' },
        {
            title: '类型',
            dataIndex: 'type',
            key: 'type',
            render: (type) => (
                <Tag icon={type === '团队' ? <TeamOutlined /> : <UserOutlined />} color={type === '团队' ? 'blue' : 'green'}>
                    {type}
                </Tag>
            )
        },
        {
            title: '所有者',
            dataIndex: 'ownerId',
            key: 'ownerId',
            render: (ownerId) => {
                const owner = userMap.get(ownerId);
                return owner ? (
                    <Space>
                        <Avatar src={owner.avatar} icon={<UserOutlined />} size="small" />
                        <span>{owner.name}</span>
                    </Space>
                ) : '未知';
            }
        },
        {
            title: () => (
                <Space>
                    空间管理员
                    <Popover content={helpContent} trigger="hover" placement="top">
                        <QuestionCircleOutlined style={{ color: '#999', cursor: 'pointer' }} />
                    </Popover>
                </Space>
            ),
            dataIndex: 'adminIds',
            key: 'admins',
            width: 200,
            render: (adminIds, record) => {
                const admins = adminIds.map(id => userMap.get(id)).filter(Boolean);

                const AdminAvatars = () => {
                    if (admins.length === 0) return '--';
                    return (
                        <Avatar.Group maxCount={2}>
                            {admins.map(admin => (
                                <Tooltip key={admin.key} title={admin.name} placement="top">
                                    <Avatar src={admin.avatar} icon={<UserOutlined />} />
                                </Tooltip>
                            ))}
                        </Avatar.Group>
                    );
                };

                return (
                    <Space>
                        {AdminAvatars()}
                        <Tooltip title="指派管理员">
                            <EditOutlined className="admin-edit-icon" onClick={() => showModal(record)} />
                        </Tooltip>
                    </Space>
                );
            }
        },
        { title: '空间创建时间', dataIndex: 'createdAt', key: 'createdAt' },
        { title: '最近更新人', dataIndex: 'lastUpdater', key: 'lastUpdater', render: (text) => text || '--' },
        { title: '最近更新时间', dataIndex: 'lastUpdatedAt', key: 'lastUpdatedAt' },
    ];

    return (
        <div className="container">
            <div className="header">
                <h1>空间管理</h1>
                <Button type="primary" icon={<PlusOutlined />}>创建空间</Button>
            </div>
            <Table
                columns={columns}
                dataSource={spaces.map(s => ({ ...s, key: s.id }))}
                rowKey="id"
                pagination={{ pageSize: 10 }}
            />

            {editingSpace && (
                <Modal
                    title={`为 [${editingSpace.name}] 指派管理员`}
                    open={isModalVisible}
                    onOk={handleOk}
                    onCancel={handleCancel}
                    width={720}
                    okText="确认"
                    cancelText="取消"
                >
                    <p style={{ color: '#888', marginTop: '-10px', marginBottom: '20px' }}>
                        您正在从租户层面对该空间进行管理员授权，此授权在空间内可见但不可被移除。
                    </p>
                    <Transfer
                        dataSource={allUsers}
                        targetKeys={targetKeys}
                        onChange={onTransferChange}
                        render={item => item.name}
                        listStyle={{ width: 300, height: 300 }}
                        showSearch
                        oneWay
                    />
                </Modal>
            )}
        </div>
    );
};

const AppWrapper = () => (
    <AntApp>
        <GlobalStyles />
        <App />
    </AntApp>
);

export default AppWrapper;

