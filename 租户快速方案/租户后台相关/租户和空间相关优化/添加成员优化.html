<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>可交互原型 - 空间成员添加</title>
    <script src="https://cdn.tailwindcss.com/"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Arial', sans-serif;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2563eb;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        /* Tooltip styles */
        .tooltip-container .tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip-container:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .user-pill {
            transition: all 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 antialiased text-gray-800">

    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md mx-auto bg-white rounded-xl shadow-md p-6 space-y-4">
            <h1 class="text-xl font-bold text-gray-900">空间权限管理</h1>
            <p class="text-gray-600">当前空间共有 <span id="member-count">5</span> 位成员。</p>
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex flex-col">
                    <span id="role-label" class="font-semibold text-gray-800">当前角色：非租户管理员</span>
                    <span class="text-sm text-gray-500">切换角色以体验不同交互流程</span>
                </div>
                <label class="switch">
                    <input type="checkbox" id="role-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            <button id="open-modal-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                新增权限
            </button>
        </div>
        <footer class="mt-8 text-sm text-gray-500">
            <p>这是一个高保真交互原型，用于演示体验优化方案。</p>
        </footer>
    </div>

    <!-- 主弹窗：添加成员 -->
    <div id="add-member-modal" class="modal-overlay">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-lg mx-4">
            <!-- 弹窗头部 -->
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <div class="flex items-center space-x-2">
                    <h2 class="text-xl font-bold text-gray-900">新增权限</h2>
                    <div class="relative tooltip-container">
                        <svg class="w-5 h-5 text-gray-400 cursor-pointer" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                        </svg>
                        <div class="tooltip absolute bottom-full mb-2 w-72 bg-gray-800 text-white text-sm rounded-lg p-3 pointer-events-none z-10 -translate-x-1/2 left-1/2">
                            <span id="tooltip-text"></span>
                            <a href="#" onclick="alert('这应该链接到\nplatform_guide.md\n\n请在实际应用中替换为真实URL。')" class="text-blue-400 hover:underline pointer-events-auto">了解更多</a>
                            <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-8 border-x-transparent border-t-8 border-t-gray-800"></div>
                        </div>
                    </div>
                </div>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <!-- 弹窗内容 -->
            <div class="p-6 space-y-4">
                <div class="flex items-center space-x-6">
                     <label class="flex items-center space-x-2">
                        <input type="radio" name="type" class="form-radio text-blue-600" checked>
                        <span class="text-gray-700 font-medium">个人</span>
                    </label>
                     <label class="flex items-center space-x-2">
                        <input type="radio" name="type" class="form-radio text-blue-600">
                        <span class="text-gray-700 font-medium">部门</span>
                    </label>
                </div>
                
                <!-- Updated Input Area for Multi-select -->
                <div class="flex items-center border border-gray-300 rounded-lg focus-within:ring-2 focus-within:ring-blue-500 transition">
                    <div id="user-input-wrapper" class="flex-grow flex flex-wrap items-center gap-2 p-1 pl-3">
                        <div id="selected-users-pills" class="contents"></div>
                        <input type="text" id="search-input" placeholder="请输入姓名、MIS号查找" class="flex-grow bg-transparent border-none focus:outline-none focus:ring-0 p-1 min-w-[150px]">
                    </div>
                    <div class="flex items-center pr-2 border-l border-gray-200 ml-2">
                        <select id="permission-select" class="h-full py-2 pl-2 pr-8 border-transparent bg-transparent text-gray-600 sm:text-sm rounded-md focus:ring-0 focus:border-transparent">
                            <option>可编辑</option>
                            <option>可查看</option>
                            <option>管理员</option>
                        </select>
                    </div>
                </div>
                
                <p id="helper-text" class="text-sm text-gray-500 px-1"></p>

                <!-- 搜索结果 -->
                <div id="search-results" class="hidden absolute mt-1 w-full bg-white border border-gray-200 rounded-lg max-h-60 overflow-y-auto shadow-lg z-[60]">
                    <!-- 动态内容 -->
                </div>
            </div>

            <!-- 弹窗底部 -->
            <div class="flex justify-end items-center p-6 bg-gray-50 rounded-b-2xl space-x-3 mt-4">
                <button id="cancel-btn" class="px-6 py-2 text-sm font-semibold text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">取消</button>
                <button id="confirm-add-btn" class="px-6 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" disabled>新增权限</button>
            </div>
        </div>
    </div>

    <!-- 二次确认弹窗 -->
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-lg mx-4 p-6">
            <h3 class="text-lg leading-6 font-bold text-gray-900" id="confirmation-title">确认批量操作</h3>
            <div class="mt-4" id="confirmation-text-wrapper">
                <!-- 动态内容 -->
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-confirmation-btn" type="button" class="px-6 py-2 text-sm font-semibold text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                    取消
                </button>
                <button id="confirm-final-btn" type="button" class="px-6 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                    确认
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 数据模拟 ---
            const mockData = {
                tenantUsers: [
                    { id: 1, name: '王宏', mis: 'wanghong', avatar: 'https://placehold.co/40x40/E2E8F0/4A5568?text=WH' },
                    { id: 2, name: '李静', mis: 'lijing', avatar: 'https://placehold.co/40x40/E2E8F0/4A5568?text=LJ' },
                    { id: 3, name: '张伟', mis: 'zhangwei', avatar: 'https://placehold.co/40x40/E2E8F0/4A5568?text=ZW' },
                    { id: 4, name: '王秀英', mis: 'wangxiuying', avatar: 'https://placehold.co/40x40/E2E8F0/4A5568?text=WY' },
                    { id: 5, name: '李强', mis: 'liqiang', avatar: 'https://placehold.co/40x40/E2E8F0/4A5568?text=LQ' },
                ],
                platformUsers: function() {
                    return [
                        ...this.tenantUsers,
                        { id: 6, name: '陈晨', mis: 'chenchen', avatar: 'https://placehold.co/40x40/CBD5E0/4A5568?text=CC' },
                        { id: 7, name: '刘洋', mis: 'liuyang', avatar: 'https://placehold.co/40x40/CBD5E0/4A5568?text=LY' },
                        { id: 8, name: '赵敏', mis: 'zhaomin', avatar: 'https://placehold.co/40x40/CBD5E0/4A5568?text=ZM' },
                        { id: 9, name: '周芷若', mis: 'zhouzhiruo', avatar: 'https://placehold.co/40x40/CBD5E0/4A5568?text=ZR' },
                        { id: 10, name: '宋青书', mis: 'songqingshu', avatar: 'https://placehold.co/40x40/CBD5E0/4A5568?text=SS' },
                    ]
                }
            };

            // --- 状态管理 ---
            let isTenantAdmin = false;
            let selectedUsers = [];

            // --- DOM 元素获取 ---
            const getEl = (id) => document.getElementById(id);
            const roleToggle = getEl('role-toggle'), roleLabel = getEl('role-label');
            const openModalBtn = getEl('open-modal-btn'), addMemberModal = getEl('add-member-modal');
            const closeModalBtn = getEl('close-modal-btn'), cancelBtn = getEl('cancel-btn');
            const confirmAddBtn = getEl('confirm-add-btn'), searchInput = getEl('search-input');
            const helperText = getEl('helper-text'), searchResultsContainer = getEl('search-results');
            const confirmationModal = getEl('confirmation-modal'), cancelConfirmationBtn = getEl('cancel-confirmation-btn');
            const confirmFinalBtn = getEl('confirm-final-btn'), confirmationTextWrapper = getEl('confirmation-text-wrapper');
            const tooltipText = getEl('tooltip-text'), selectedUsersPills = getEl('selected-users-pills');
            const memberCountSpan = getEl('member-count'), permissionSelect = getEl('permission-select');
            const confirmationTitle = getEl('confirmation-title');
            
            // --- 函数定义 ---
            function updateMainUI() {
                confirmAddBtn.disabled = selectedUsers.length === 0;
                const hasExternal = selectedUsers.some(u => !mockData.tenantUsers.some(tu => tu.id === u.id));
                confirmAddBtn.textContent = hasExternal ? '邀请并添加' : '新增权限';
            }
            
            function renderPills() {
                selectedUsersPills.innerHTML = '';
                selectedUsers.forEach(user => {
                    const pill = document.createElement('div');
                    pill.className = 'user-pill flex items-center bg-blue-100 text-blue-800 text-sm font-semibold px-2.5 py-1 rounded-full gap-2';
                    pill.innerHTML = `
                        <span>${user.name}</span>
                        <button data-userid="${user.id}" class="remove-pill-btn text-blue-500 hover:text-blue-700 focus:outline-none">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                    `;
                    selectedUsersPills.appendChild(pill);
                });
                updateMainUI();
            }

            function updateRoleUI() {
                if (isTenantAdmin) {
                    roleLabel.textContent = '当前角色：租户管理员';
                    helperText.innerHTML = '您当前是<strong class="font-bold text-gray-800">【租户管理员】</strong>，可搜索并邀请租户外（标记为【待邀请】）的成员加入。';
                    tooltipText.innerHTML = '您是租户管理员，可邀请租户外（标记为【待邀请】）的成员加入。';
                } else {
                    roleLabel.textContent = '当前角色：非租户管理员';
                    helperText.textContent = '仅可搜索和添加本租户内的成员。';
                    tooltipText.textContent = '只能添加您租户内的成员。不同租户或个人账号之间无法直接添加。';
                }
                searchInput.value = '';
                selectedUsers = [];
                renderPills();
                searchResultsContainer.innerHTML = '';
                searchResultsContainer.classList.add('hidden');
            }

            function renderSearchResults(results, searchTerm) {
                searchResultsContainer.innerHTML = '';
                if (results.length === 0 && searchTerm) {
                    let messageHtml = isTenantAdmin ?
                        `<div class="p-4 text-center text-sm text-gray-500">在平台中未找到 "${searchTerm}"</div>` :
                        `<div class="p-4 text-center text-sm text-gray-500">
                            <p class="font-semibold mb-2">在租户成员中未找到 "${searchTerm}"</p>
                            <p>协作者须为租户成员，</p>
                            <p>请联系租户管理员邀请其加入。</p>
                        </div>`;
                    searchResultsContainer.innerHTML = messageHtml;
                } else {
                    results.forEach(user => {
                        const isExternal = !mockData.tenantUsers.some(tu => tu.id === user.id);
                        const isSelected = selectedUsers.some(su => su.id === user.id);
                        const resultItem = document.createElement('div');
                        resultItem.className = `flex items-center justify-between p-3 cursor-pointer border-b border-gray-100 last:border-b-0 ${isSelected ? 'bg-gray-200 cursor-not-allowed' : 'hover:bg-gray-50'}`;
                        resultItem.innerHTML = `
                            <div class="flex items-center space-x-3">
                                <img src="${user.avatar}" alt="${user.name}" class="w-8 h-8 rounded-full">
                                <div>
                                    <span class="font-semibold text-gray-800">${user.name}</span>
                                    <span class="text-sm text-gray-500 ml-2">${user.mis}</span>
                                </div>
                            </div>
                            ${isExternal ? '<span class="text-xs font-bold text-purple-800 bg-purple-100 px-2 py-1 rounded-full">待邀请</span>' : ''}
                        `;
                        if (!isSelected) {
                            resultItem.addEventListener('click', () => {
                                selectedUsers.push(user);
                                renderPills();
                                searchInput.value = '';
                                searchResultsContainer.classList.add('hidden');
                                searchInput.focus();
                            });
                        }
                        searchResultsContainer.appendChild(resultItem);
                    });
                }
                
                if (searchTerm) searchResultsContainer.classList.remove('hidden');
                else searchResultsContainer.classList.add('hidden');
            }
            
            function positionSearchResults() {
                const inputWrapper = getEl('user-input-wrapper').parentElement;
                const inputRect = inputWrapper.getBoundingClientRect();
                searchResultsContainer.style.left = `${inputRect.left}px`;
                searchResultsContainer.style.top = `${inputRect.bottom + 4}px`;
                searchResultsContainer.style.width = `${inputRect.width}px`;
            }

            function handleSearch() {
                const searchTerm = searchInput.value.trim().toLowerCase();
                positionSearchResults(); 
                if (!searchTerm) {
                    searchResultsContainer.classList.add('hidden');
                    return;
                }
                const sourceData = isTenantAdmin ? mockData.platformUsers() : mockData.tenantUsers;
                const results = sourceData.filter(u => u.name.toLowerCase().includes(searchTerm) || u.mis.toLowerCase().includes(searchTerm));
                renderSearchResults(results, searchInput.value.trim());
            }

            const openModal = (modal) => modal.classList.add('active');
            const closeModal = (modal) => modal.classList.remove('active');

            // --- Event Listeners ---
            roleToggle.addEventListener('change', () => { isTenantAdmin = roleToggle.checked; updateRoleUI(); });
            openModalBtn.addEventListener('click', () => { updateRoleUI(); openModal(addMemberModal); setTimeout(() => { positionSearchResults(); searchInput.focus(); }, 50); });
            [closeModalBtn, cancelBtn].forEach(btn => btn.addEventListener('click', () => closeModal(addMemberModal)));
            [searchInput, searchResultsContainer].forEach(el => el.addEventListener('focusin', handleSearch));
            searchInput.addEventListener('input', handleSearch);

            selectedUsersPills.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-pill-btn');
                if (removeBtn) {
                    const userId = parseInt(removeBtn.dataset.userid, 10);
                    selectedUsers = selectedUsers.filter(u => u.id !== userId);
                    renderPills();
                }
            });

            confirmAddBtn.addEventListener('click', () => {
                const permission = permissionSelect.value;
                const externalUsers = selectedUsers.filter(u => !mockData.tenantUsers.some(tu => tu.id === u.id));
                const internalUsers = selectedUsers.filter(u => mockData.tenantUsers.some(tu => tu.id === u.id));

                if (externalUsers.length > 0) {
                    confirmationTitle.textContent = '确认批量操作';
                    let confirmationHtml = `<div class="text-sm text-gray-500 text-left space-y-4">
                        <p>您将为 ${selectedUsers.length} 位成员赋予 <strong class="text-blue-600 font-semibold">${permission}</strong> 权限。详情如下：</p>`;
                    
                    if(externalUsers.length > 0) {
                        confirmationHtml += `
                        <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg">
                            <h4 class="font-semibold text-purple-800">以下成员将被邀请加入您的租户：</h4>
                            <ul class="list-disc list-inside mt-2 text-purple-700">
                                ${externalUsers.map(u => `<li>${u.name} <span class="text-gray-400">(${u.mis})</span></li>`).join('')}
                            </ul>
                        </div>`;
                    }

                    if(internalUsers.length > 0) {
                        confirmationHtml += `
                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                            <h4 class="font-semibold text-green-800">以下租户内成员将直接添加：</h4>
                            <ul class="list-disc list-inside mt-2 text-green-700">
                                ${internalUsers.map(u => `<li>${u.name} <span class="text-gray-400">(${u.mis})</span></li>`).join('')}
                            </ul>
                        </div>`;
                    }
                    confirmationHtml += `</div>`;
                    confirmationTextWrapper.innerHTML = confirmationHtml;
                    openModal(confirmationModal);
                } else {
                    closeModal(addMemberModal);
                    memberCountSpan.textContent = parseInt(memberCountSpan.textContent) + selectedUsers.length;
                    alert(`${selectedUsers.length} 位成员已成功设为“${permission}”权限！`);
                }
            });

            cancelConfirmationBtn.addEventListener('click', () => closeModal(confirmationModal));
            confirmFinalBtn.addEventListener('click', () => {
                closeModal(confirmationModal);
                closeModal(addMemberModal);
                memberCountSpan.textContent = parseInt(memberCountSpan.textContent) + selectedUsers.length;
                alert(`已发送邀请并成功添加 ${selectedUsers.length} 位成员！`);
            });

            window.addEventListener('resize', positionSearchResults);

            document.addEventListener('click', (e) => {
                 if (!addMemberModal.querySelector('.modal-content').contains(e.target) && !openModalBtn.contains(e.target) && !searchResultsContainer.contains(e.target) ) {
                    if (addMemberModal.classList.contains('active')) {
                        closeModal(addMemberModal);
                    }
                 }
                 if (!searchInput.parentElement.parentElement.contains(e.target) && !searchResultsContainer.contains(e.target)) {
                    searchResultsContainer.classList.add('hidden');
                 }
            });

            // Initial setup
            updateRoleUI();
            document.body.appendChild(searchResultsContainer);
        });
    </script>
</body>
</html>