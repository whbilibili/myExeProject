# 功能需求文档：用量与授权管理

## 1. 功能概述 (Feature Overview)

“用量与授权”是一个为租户管理员设计的核心管理模块。它提供了一个统一的界面，用于集中管理租户所订阅的全部权益，包括可消耗的**资源配额**（如云电脑/手机设备使用时长、API调用量）和需按席位分配的**高级功能**（如UI操作指令、自动化工作流等）。此模块旨在为管理员提供灵活、精细、直观的权限与成本控制能力，最大化租户权益的价值。

---

## 2. 统一页面架构 (Unified Page Architecture)

### 2.1. 核心设计理念

为了在快速验证核心价值的同时，保持未来良好的可扩展性，MVP版本将采用**单页面布局**。

**设计 rationale**:
*   **避免过度设计**: 在初期可配置项较少（如仅有“云电脑/手机设备使用时长”和“UI操作指令”）的情况下，引入Tab或更复杂的导航会使界面显得空旷，增加不必要的用户操作。
*   **降低认知负荷**: 将所有可管理项集中于一页，让管理员一目了然，无需猜测不同分类下隐藏着什么内容，心流更顺畅。
*   **聚焦核心价值**: MVP的核心是验证“分配资源”与“授权功能”这两个核心流程，而非追求UI架构的完美。

所有功能配置项将以“卡片(Card)”的形式平铺在页面中，并通过二级标题进行逻辑分组，为未来新增更多卡片（如API调用量、存储空间等）预留了清晰的扩展空间。

### 2.2. 页面规格

| 架构元素           | 规格                                                     |
| :----------------- | :------------------------------------------------------- |
| **菜单入口**       | `用量与授权` (租户设置侧边栏中的一级菜单)              |
| **页面标题**       | `用量与授权`                                             |
| **页面描述**       | `在这里统一管理您团队的资源用量和功能使用权限。`         |
| **内容分组**       | **二级标题**: `资源用量分配` <br/> **二级标题**: `高级功能授权` |

---

## 3. 模块一：资源用量分配

此区域用于管理所有消耗型资源的分配规则。

### 3.1. 功能点：云电脑设备使用时长

#### 3.1.1. 入口卡片

此卡片是“云电脑设备使用时长”功能的唯一入口，旨在提供一个快速的状态概览和操作入口。

| 元素         | 规格                                         |
| :----------- | :------------------------------------------- |
| **标题**     | `云电脑设备使用时长`                         |
| **描述**     | `为成员分配每月可用的云电脑设备使用时长。`   |
| **图标**     | `fas fa-desktop`                             |
| **操作按钮** | `[管理分配规则]`                             |
| **交互**     | 点击按钮，弹出“分配规则弹窗”。               |

#### 3.1.2. 分配规则弹窗

此弹窗是功能的核心配置区域，分为“按租户设置”的全局规则和“按白名单设置”的例外规则两部分，逻辑清晰。

| 弹窗元素     | 规格                                                                   |
| :----------- | :--------------------------------------------------------------------- |
| **弹窗标题** | `云电脑设备使用时长分配`                                               |
| **弹窗描述** | `为租户内所有成员设置通用的月度云电脑设备使用时长，并可为特定个人或部门添加例外规则。` |

**a. 按租户设置 (Default Tenant-wide Rule)**

这部分定义了全局默认规则，作为整个权限体系的基线。

| 设定         | UI 组件                                   | 默认状态              | 逻辑                                          |
| :----------- | :---------------------------------------- | :-------------------- | :-------------------------------------------- |
| 通用上限规则 | 单选框组                                  | `不限制` 被选中。     | 此为全局规则，优先级最低。                    |
| 选项1        | `(•) 不限制`                              | 选中                  |                                               |
| 选项2        | `( ) 每人最多` `[ 100 ]` `小时/月`         | 未选中，输入框有占位符 | 选中此项后输入框激活，否则禁用。              |

**b. 按白名单设置 (Whitelist-based Exceptions)**

白名单为管理员提供了打破全局规则的灵活性，以应对特殊的管理需求。

*   **规则说明**: `白名单规则生效的优先级从高到低依次为：成员 > 部门/虚拟角色组。`
*   **操作按钮**: `[+ 添加个人]` `[+ 添加部门/组]`

**c. 白名单规则列表详情**

下表详细定义了添加和配置白名单规则时的交互细节。

| 动作         | 选择器 UI                                 | 占位符/提示文本            | 数据源与呈现                                                 |
| :----------- | :---------------------------------------- | :------------------------- | :----------------------------------------------------------- |
| **添加个人** | 支持多选的搜索框                          | `按姓名/邮箱/手机号搜索成员` | 租户下所有成员。选中后以“标签(Tag)”形式显示在输入框内。       |
| **添加部门/组** | 支持多选的搜索框                          | `搜索部门或虚拟角色组`     | 租户下所有部门和虚拟角色组。以树状结构呈现，组与根部门平级。 |
| **单条规则配置** | 单选框组：`( ) 不限制` `( ) 每人最多 [200] 小时/月` | -                          | 为每一条白名单规则独立配置。                                 |
| **删除规则**     | 图标按钮                                  | -                          | 每条规则行末提供一个`删除`图标按钮。                         |

**d. 弹窗操作**

| 动作       | 按钮             | 行为                                         |
| :--------- | :--------------- | :------------------------------------------- |
| **保存**   | `[保存更改]`     | 所有规则生效，弹窗关闭。                     |
| **取消/关闭** | `[取消]` 或 `×` | 所有未保存的修改作废，弹窗关闭。             |

### 3.2. 功能点：手机设备使用时长

#### 3.2.1. 入口卡片

| 元素         | 规格                                         |
| :----------- | :------------------------------------------- |
| **标题**     | `手机设备使用时长`                           |
| **描述**     | `为成员分配每月可用的手机设备使用时长。`     |
| **图标**     | `fas fa-mobile-alt`                          |
| **操作按钮** | `[管理分配规则]`                             |
| **交互**     | 点击按钮，弹出“分配规则弹窗”。               |

#### 3.2.2. 分配规则弹窗

为快速迭代，此功能的弹窗在**MVP阶段**与“云电脑设备使用时长”**共用同一套UI和逻辑**，仅弹窗标题不同。

| 弹窗元素     | 规格                                                                   |
| :----------- | :--------------------------------------------------------------------- |
| **弹窗标题** | `手机设备使用时长分配`                                                 |
| **核心功能** | 与 3.1.2 节中描述的弹窗功能完全一致。                                  |

---

## 4. 模块二：高级功能授权

此区域用于管理需要按席位分配的资格型功能。

### 4.1. 功能点：功能席位分配

#### 4.1.1. 入口卡片

每个高级功能都对应一个独立的卡片，清晰地展示其分配状态。

| 元素             | 规格                                                       |
| :--------------- | :--------------------------------------------------------- |
| **功能名称**     | e.g., `UI操作指令`                                         |
| **功能图标**     | e.g., `fa-hand-pointer`                                    |
| **功能描述**     | e.g., `高级功能，用于操作手机和电脑的工作流指令。`         |
| **分配状态**     | `✅ 已为所有成员启用` 或 `X 席位已分配`                     |
| **操作按钮**     | `[管理分配]`                                               |
| **交互**         | 点击按钮，弹出“席位分配弹窗”。                             |

#### 4.1.2. 席位分配弹窗

| 弹窗元素     | 规格                                      |
| :----------- | :---------------------------------------- |
| **弹窗标题** | `管理分配 - [功能名称]` (动态生成)        |
| **弹窗描述** | `为此功能添加或移除成员/部门的席位。`     |

**a. 规则配置**

| 设定类型               | UI 组件                             | 逻辑                                               |
| :--------------------- | :---------------------------------- | :------------------------------------------------- |
| **为所有成员启用**     | 开关 (Toggle)                       | 开启后，“按席位单独分配”区域禁用。此规则覆盖所有其他规则。 |
| **按席位单独分配：成员** | 支持多选的搜索框                    |                                                    |
| **按席位单独分配：部门** | 支持多选的部门树选择器              |                                                    |

**b. 状态统计与操作**

| 动作           | UI & 逻辑                                                    |
| :------------- | :----------------------------------------------------------- |
| **席位统计**   | 弹窗底部实时显示 `已分配席位: X`。<br/>*计算逻辑: 精确计算所有已分配个人以及已分配部门下所有成员的去重总和。* |
| **保存/取消**    | 与“设备使用时长”弹窗的 `[保存更改]` `[取消]` 逻辑一致。       |

---

## 5. 规则详解与常见问题

### 5.1. 白名单冲突规则与优先级详解

当一个成员同时命中多条**同类型**（如同样是云电脑时长）的规则时，系统需要一套清晰无歧义的逻辑来计算其最终的使用时长上限。下表定义了所有冲突场景的解决方案。

| 冲突场景                                               | 解决逻辑                                 | 示例                                                                                                                                              |
| :----------------------------------------------------- | :--------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------ |
| **情况 1**：同一成员命中多条 **“个人”** 白名单规则       | 取设备使用时长的 **最大值**。            | 成员A有两条规则：“100小时”和“200小时”。<br/>**结果**：A的上限为 `200小时`。                                                                    |
| **情况 2**：成员同时被 **个人、组、部门** 规则覆盖       | 优先级：**个人 > 虚拟角色组 > 部门**。   | 成员A个人(不限制)，所属组(100小时)，所属部门(200小时)。<br/>**结果**：A的上限为 `不限制`。                                                       |
| **情况 3**：成员属于多个 **同级部门** 或 **多个组**        | 取上限值 **最高** 的规则。               | 成员A属于组1(100小时)和组2(200小时)。<br/>**结果**：A的上限为 `200小时`。                                                                       |
| **情况 4**：成员属于 **不同层级** 的部门                 | 应用 **层级最低**（最具体）的部门规则。    | 成员A属于“研发部(L1)”(200小时)和“前端团队(L2)”(50小时)。<br/>**结果**：A的上限为 `50小时`。                                                  |

### 5.2. 常见问题 (FAQ)

| 问题                                                               | 解答                                                                                                                                     |
| :----------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------- |
| **统一设置后，还能为个别人单独设置吗？**                           | **可以。** 白名单规则永远优先生效于全局默认规则。您可以随时为特定个人、部门或组添加例外规则。                                                    |
| **成员达到使用时长上限后会怎样？**                                 | **将无法再启动或连接对应的设备（云电脑或手机）。** 直到下个月度周期重置时长，系统会给出明确的“使用时长不足”提示。                              |
| **设置上限时，若某成员本月已用时长已超额，会发生什么？**             | **规则可设置成功。** 该成员在本月剩余时间内将无法再使用对应的设备，但这不影响他之前的正常使用。                                                  |
